<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>選擇你的獵人角色 - 進擊的蟑螂</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="style.css" />

  <!-- 全域工具（維持傳統 script）：提供 Modes 與 RolesVoice 兩個全域物件 -->
  <script src="js/core/modes.js"></script>
  <script src="js/core/roles-voice.js"></script>

  <style>
    :root { --card-bg: rgba(0,0,0,0.45); --card-bd: rgba(255,255,255,0.2); --accent: #ffd166; }
    body {
      margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center;
      background: url("assets/images/select_bg.png") no-repeat center center/cover;
      color: #fff; text-shadow: 1px 1px 2px #000;
    }
    main {
      width: min(980px, 92vw); padding: 1.5rem; background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.15); border-radius: 16px; backdrop-filter: blur(4px);
      opacity: 0; animation: fadeIn .9s forwards;
    }
    @keyframes fadeIn { to { opacity: 1; } }
    h1 { margin: 0 0 0.25rem } p.lead { margin: 0 0 1rem; opacity: .9 } form { margin-top: 1rem; }

    .name-row { display: grid; grid-template-columns: 110px 1fr; gap: .75rem; align-items: center; margin-bottom: 1rem; }
    .name-row input[type="text"]{
      padding: .6rem .8rem; font-size: 1.05rem; border-radius: 10px; border: 1px solid var(--card-bd);
      background: rgba(0,0,0,0.3); color: #fff; outline: none;
    }
    .name-row input[type="text"]:focus{ border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255,209,102,.25); }

    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: .9rem; align-items: stretch; }
    @media (max-width: 900px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 520px) { .grid { grid-template-columns: 1fr; } }

    .hunter-input { position: absolute; opacity: 0; pointer-events: none; }

    .card {
      position: relative; cursor: pointer; border-radius: 14px; border: 2px solid var(--card-bd);
      background: var(--card-bg); padding: .9rem .9rem 1rem; text-align: center;
      transition: transform .15s ease, border-color .15s ease, box-shadow .15s ease;
      display: grid; grid-template-rows: auto 1fr auto; min-height: 260px; overflow: visible;
    }
    .card:hover .img-wrap img { transform: scale(1.05); }
    .card:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    .card .img-wrap {
      height: 160px; display: grid; place-items: center; border-radius: 10px; background: rgba(255,255,255,.08);
      margin: .25rem 0 .6rem; overflow: visible;
    }
    .card img {
      max-height: 150px; width: auto; height: auto; max-width: 100%; object-fit: contain; display: block;
      transform-origin: center bottom; transition: transform .25s ease; will-change: transform;
    }
    .hunter-input:checked + .card .img-wrap img { transform: scale(1.3); z-index: 2; filter: drop-shadow(0 6px 12px rgba(0,0,0,0.55)); }

    .card .hn { font-weight: 700; margin: 0 0 .2rem; }
    .card .roman { opacity: .9; font-size: .95rem; }

    .hunter-input:checked + .card { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255,209,102,.25); }
    .hunter-input:checked + .card::after{
      content: "✓"; position: absolute; right: 10px; top: 8px; background: var(--accent);
      color: #222; font-weight: 900; border-radius: 999px; width: 22px; height: 22px; display: grid; place-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,.35); z-index: 3;
    }

    .actions { margin-top: 1.25rem; display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
    .btn { appearance: none; border: none; border-radius: 999px; padding: .7rem 1.2rem; font-size: 1.05rem;
      background: var(--accent); color: #222; cursor: pointer; font-weight: 700; transition: transform .08s ease; }
    .btn:active { transform: translateY(1px); }

    #status { min-height: 1.2em; font-weight: 700; color: #fff; text-shadow: 0 1px 2px #000; }

    .sr-only { position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body>
  <main>
    <h1>選擇你的獵人角色</h1>
    <p class="lead" id="screenHint">請輸入暱稱，選擇一位獵人，按「開始遊戲」或 Enter。</p>

    <form id="playerForm">
      <div class="name-row">
        <label for="playerName">暱稱：</label>
        <input id="playerName" name="playerName" type="text" placeholder="輸入你的稱號…" required maxlength="20" />
      </div>

      <div class="mode-row">
        <fieldset aria-describedby="modeHint">
          <legend>體驗模式</legend>
          <label><input type="radio" name="mode" value="visual" checked> 顯示遊戲畫面模式</label>
          <label style="margin-left:12px;"><input type="radio" name="mode" value="audio">　遮蔽遊戲畫面（聽覺模式）</label>
          <p id="modeHint" class="hint">※ 遊戲進行中可按 <kbd>Shift</kbd> + <kbd>M</kbd> 切換模式。</p>
        </fieldset>
      </div>

      <fieldset>
        <legend class="sr-only">選擇獵人</legend>
        <div class="grid" role="listbox" aria-label="獵人清單">
          <!-- 金巴 -->
          <label>
            <input class="hunter-input" type="radio" name="hunter" value="kinbah.png" data-name="金巴" checked />
            <div class="card" role="option" aria-label="金巴h">
              <div class="img-wrap">
              <img src="assets/images/hunters/kinbah.png" alt="金巴 圖像">
              </div>
              <div class="hn">金巴</div>
              <div class="roman">Kin-bah</div>
            </div>
          </label>
          <!-- 麥拉 -->
          <label>
            <input class="hunter-input" type="radio" name="hunter" value="mailah.png" data-name="麥拉" />
            <div class="card" role="option" aria-label="麥拉">
              <div class="img-wrap">
              <img src="assets/images/hunters/mailah.png" alt="麥拉 圖像">
              </div>
              <div class="hn">麥拉</div>
              <div class="roman">Mài--lah</div>
            </div>
          </label>
          <!-- 考盃 -->
          <label>
            <input class="hunter-input" type="radio" name="hunter" value="khaupe.png" data-name="考盃" />
            <div class="card" role="option" aria-label="考盃">
              <div class="img-wrap">
              <img src="assets/images/hunters/khaupe.png" alt="考盃 圖像">
              </div>
              <div class="hn">考盃</div>
              <div class="roman">Khàu-pē</div>
            </div>
          </label>
          <!-- 赫拉 -->
          <label>
            <input class="hunter-input" type="radio" name="hunter" value="holah.png" data-name="赫拉" />
            <div class="card" role="option" aria-label="赫拉">
              <div class="img-wrap">
              <img src="assets/images/hunters/holah.png" alt="赫拉 圖像">
              </div>
              <div class="hn">赫拉</div>
              <div class="roman">Hó--lah</div>
            </div>
          </label>
          <!-- 金艾捆 -->
          <label>
            <input class="hunter-input" type="radio" name="hunter" value="chinaikhun.png" data-name="金·艾捆" />
            <div class="card" role="option" aria-label="金·艾捆">
              <div class="img-wrap">
              <img src="assets/images/hunters/chinaikhun.png" alt="金·艾捆 圖像">
              </div>
              <div class="hn">金．艾捆</div>
              <div class="roman">Chin Ài-khùn</div>
            </div>
          </label>
                    <!-- 郊．萊北 -->
          <label>
            <input class="hunter-input" type="radio" name="hunter" value="chiaulaipeh.png" data-name="郊．萊北" />
            <div class="card" role="option" aria-label="郊．萊北">
              <div class="img-wrap">
              <img src="assets/images/hunters/chiaulaipeh.png" alt="郊．萊北 圖像">
              </div>
              <div class="hn">郊．萊北</div>
              <div class="roman">Chiáu Lâi-peh</div>
            </div>
          </label>
                              <!-- 綿葩．坂 -->
          <label>
            <input class="hunter-input" type="radio" name="hunter" value="mienphapan.png" data-name="綿葩．坂" />
            <div class="card" role="option" aria-label="綿葩．坂">
              <div class="img-wrap">
              <img src="assets/images/hunters/mienphapan.png" alt="綿葩．坂 圖像">
              </div>
              <div class="hn">綿葩．坂</div>
              <div class="roman">Mien pa Banˋ</div>
            </div>
          </label>
                                        <!-- 罕族．拗 -->
          <label>
            <input class="hunter-input" type="radio" name="hunter" value="hamchuniok.png" data-name="罕族．拗" />
            <div class="card" role="option" aria-label="罕族．拗">
              <div class="img-wrap">
              <img src="assets/images/hunters/hamchuniok.png" alt="罕族．拗 圖像">
              </div>
              <div class="hn">罕族．拗</div>
              <div class="roman">Hamˇ zuˊ Ngiugˋ</div>
            </div>
          </label>
        </div>
      </fieldset>

      <div class="actions">
        <button type="submit" class="btn">開始遊戲</button>
        <div id="status" aria-live="polite"></div>
        <div id="srName" class="sr-only" aria-live="polite"></div>
      </div>
    </form>
  </main>

  <!-- 與首頁相同音樂 -->
  <audio id="bgm" src="assets/sounds/start_theme.mp3" loop playsinline preload="auto"></audio>

  <!-- ✅ 單一入口：用 ES Module 寫頁面邏輯 -->
  <script type="module">
    // Modes / RolesVoice 來自上面的傳統 script（全域物件）
    const bgm = document.getElementById("bgm");
    const statusEl = document.getElementById("status");
    const srName = document.getElementById("srName");

    // 先套用模式（支援 ?mode=audio 覆蓋）
    window.Modes?.applyModeOnLoad();

    // === 音訊啟動（BGM + 角色語音播放器）===
    let audioArmed = false;
    function armAudio() {
      if (audioArmed) return;
      audioArmed = true;
      bgm?.play()?.catch(()=>{});
      try {
        window.RolesVoice?.init({ selector: '.card', hover: false, focus: false, autoPrime: true });
      } catch(_) {}
    }
    document.addEventListener("click", armAudio, { once: true });
    document.addEventListener("keydown", armAudio, { once: true });
    document.addEventListener("touchstart", armAudio, { once: true, passive: true });

    // === 建立「角色中文名 → MP3」對照 ===
    function buildRoleVoicesMap() {
      const radios = document.querySelectorAll('input[name="hunter"]');
      const map = {};
      radios.forEach(r => {
        const displayName = (r.dataset.name || '').trim() || r.value;
        const slug = String(r.value).replace(/\.png$/i, '');
        map[displayName] = `assets/sounds/hunters/${slug}_select.mp3`;
      });
      return map;
    }
    try { window.RolesVoice?.setVoices(buildRoleVoicesMap()); } catch(_) {}

    // === 選角語音與可及性標示 ===
    function bindHunterVoice() {
      const radios = document.querySelectorAll('input[name="hunter"]');
      const playByRadio = (r) => {
        const name = (r.dataset.name || '').trim() || r.value;
        if (statusEl) statusEl.textContent = `已選擇：${name}`;
        if (srName) srName.textContent = `已選擇 ${name}`;
        document.querySelectorAll('.grid .card[role="option"]').forEach(c => c.setAttribute('aria-selected','false'));
        r.nextElementSibling?.setAttribute('aria-selected','true');
        try { window.RolesVoice?.play(name, { fallbackTTSText: '' }); } catch(_) {}
      };
      radios.forEach(r => {
        r.addEventListener("change", () => playByRadio(r));
        r.closest("label")?.addEventListener("click", () => playByRadio(r));
      });
      document.querySelectorAll('.grid .card').forEach(card => {
        card.addEventListener('mouseenter', () => {
          const r = card.previousElementSibling; if (!r) return;
          const name = (r.dataset.name || '').trim() || r.value;
          try { window.RolesVoice?.play(name, { fallbackTTSText: '' }); } catch(_) {}
        });
        card.addEventListener('focus', () => {
          const r = card.previousElementSibling; if (!r) return;
          const name = (r.dataset.name || '').trim() || r.value;
          try { window.RolesVoice?.play(name, { fallbackTTSText: '' }); } catch(_) {}
        }, true);
      });
    }
    bindHunterVoice();

    // === 模式切換 ===
    document.querySelectorAll('input[name="mode"]').forEach(r => {
      r.addEventListener('change', () => window.Modes?.setMode(r.value));
    });
    (function syncRadio() {
      const cur = window.Modes?.getMode?.() ?? 'visual';
      const el = document.querySelector(`input[name="mode"][value="${cur}"]`);
      if (el) el.checked = true;
    })();

    // === 表單送出 ===
    document.getElementById("playerForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const name = document.getElementById("playerName").value.trim();
      if (!name) {
        if (statusEl) statusEl.textContent = "請先輸入暱稱～";
        document.getElementById("playerName").focus();
        return;
      }
      const chosenMode = document.querySelector('input[name="mode"]:checked')?.value || 'visual';
      window.Modes?.setMode(chosenMode);

      const hunterRadio = document.querySelector('input[name="hunter"]:checked');
      const avatarFile = hunterRadio ? hunterRadio.value : "kinbah.png";

      const player = {
        name,
        avatar: `assets/images/hunters/${avatarFile}`,
        weapon: "fire",
        hp: 10,
        coins: 10,
        weaponUsage: { fire: 10, spray: 10, slipper: 10 }
      };
      localStorage.setItem("bugSlayerPlayer", JSON.stringify(player));

            // 存玩家資料後，立刻用「同一個手勢」解鎖音訊，並把旗子帶到下一頁
      try {
        // 叫醒你的 Audio 系統（若已載入）
        window.AudioFX?.init?.();
        window.AudioFX?.ensure?.();

        // 給下一頁看的時間戳旗子（存 10 秒即可）
        sessionStorage.setItem('audioArmedAt', String(Date.now()));
      } catch (_) {}

      location.href = "intro.html"; // 你原本的導頁
    });

    // Enter 直接送出（非 textarea）
    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.isComposing) {
        const form = document.getElementById("playerForm");
        if (document.activeElement.tagName !== "TEXTAREA") form.requestSubmit();
      }
    });

    // ===== 進頁引導朗讀 =====
    function speak(text){
      try{
        if(!("speechSynthesis" in window) || !text) return;
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "zh-TW"; u.rate = 1.5; u.pitch = 1.0; u.volume = 1.0;
        speechSynthesis.speak(u);
      }catch(_){}
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('playerName')?.focus({ preventScroll: true });
      const sr = document.getElementById('srName');
      if (sr) sr.textContent = "歡迎來到選角頁。請先輸入暱稱，接著選擇一位獵人，按下開始遊戲。";
      speak("歡迎來到選角頁。請輸入暱稱，使用 Tab 鍵移到獵人清單，方向鍵左右或上下切換，Enter 確認，或直接按開始遊戲。");
    });

    // 卡片方向鍵導覽
    (function enableArrowNav(){
      const radios = Array.from(document.querySelectorAll('input[name="hunter"]'));
      if (!radios.length) return;
      function currentCols(){
        const w = window.innerWidth;
        if (w <= 520) return 1; if (w <= 900) return 2; return 4;
      }
      radios.forEach(r => { const card = r.nextElementSibling; if (card) card.tabIndex = 0; });
      function selectIndex(i){
        const r = radios[i]; if (!r) return;
        r.checked = true; r.dispatchEvent(new Event('change', { bubbles: true }));
        r.nextElementSibling?.focus({ preventScroll: true });
      }
      document.querySelector('.grid')?.addEventListener('keydown', (e)=>{
        const focusedCard = document.activeElement?.classList?.contains('card') ? document.activeElement : null;
        if (!focusedCard) return;
        const idx = radios.findIndex(r => r.nextElementSibling === focusedCard); if (idx < 0) return;
        const cols = currentCols(); let next = idx;
        if (e.key === 'ArrowRight') next = Math.min(radios.length - 1, idx + 1);
        else if (e.key === 'ArrowLeft') next = Math.max(0, idx - 1);
        else if (e.key === 'ArrowDown') next = Math.min(radios.length - 1, idx + cols);
        else if (e.key === 'ArrowUp') next = Math.max(0, idx - cols);
        else return;
        e.preventDefault(); selectIndex(next);
      });
    })();

    document.addEventListener("click", () => {
      speak("歡迎來到選角頁。請輸入暱稱，使用 Tab 鍵移到獵人清單，方向鍵左右或上下切換，Enter 確認，或直接按開始遊戲。");
    }, { once: true });
  </script>
</body>
</html>