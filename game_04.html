<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ç¬¬ 4 é—œï¼šå®¢å»³ï¼ˆ7Ã—7ï¼‰ - é€²æ“Šçš„èŸ‘è‚</title>
  <link rel="stylesheet" href="style.css" />
  <script src="js/core/modes.js"></script>
  <script>window.ASSETS_ROOT = "/";</script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: url("assets/images/game_bg4.png") no-repeat center center fixed;
      background-size: cover;
      font-family: sans-serif;
      opacity: 0;
      transition: opacity .6s ease;
    }
    body.ready { opacity: 1; }

    /* åˆå§‹ç‚º flexï¼›ModeGrid æœƒæ¥æ‰‹æ”¹ç‚º CSS Grid 7Ã—7 */
    #gameArea {
      display: flex;
      justify-content: center;
      margin: 1rem auto;
      gap: 0.5rem;
    }
    .tile {
      width: 50px;
      height: 50px;
      border: 2px solid #333;
      font-size: 1.5rem;
      text-align: center;
      line-height: 50px;
      background-color: #eee;
    }
    .tile.player { background-color: #cce5ff; }
    .tile.bug    { background-color: #f8d7da; }
    .obstacle{background:#444;color:#eee}

    #touchControls { margin: 1rem auto; text-align: center; }
    #touchControls button { font-size: 1rem; margin: 0.3rem; }
    #message { margin-top: 1rem; font-weight: bold; text-align: center; }

    .sr-only{
      position:absolute!important;
      width:1px;height:1px;
      padding:0;margin:-1px;overflow:hidden;
      clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }
        /* å‹‡è€…è²¼åœ–ï¼ˆå³ä¸‹è§’è£é£¾ï¼Œä¸æ“‹æ“ä½œï¼‰ */
  .hero-sticker{
    position: fixed;
    right: 12px;
    bottom: 12px;
    width: min(22vw, 180px);
    max-width: 220px;
    height: auto;
    opacity: .95;
    pointer-events: none;                 /* â˜… ä¸æ””æˆªæ»‘é¼ /è§¸æ§ */
    filter: drop-shadow(0 6px 18px rgba(0,0,0,.45));
    z-index: 10;
  }
  @media (max-width: 480px){
    .hero-sticker{ width: 28vw; opacity: .9; }
  }
  </style>
</head>
<body class="stage4">
  <main>
    <h1>å±æ©Ÿå››ä¼çš„å®¢å»³</h1>
    <p class="sr-only" id="a11yHelp">
      éµç›¤æ“ä½œï¼šæ–¹å‘éµä¸Šä¸‹å·¦å³ç§»å‹•ï¼›ç©ºç™½éµæƒæï¼›Enter æ”»æ“Šï¼›æ•¸å­—éµ 1 åˆ° 4 åˆ‡æ›æ­¦å™¨ã€‚
      ä»»ä½•æ™‚å€™å¯æŒ‰ Shift+S æœ—è®€ç›®å‰ç‹€æ…‹ï¼ˆè¡€é‡ã€é‡‘å¹£ã€æ­¦å™¨èˆ‡å¯ç”¨æ¬¡æ•¸ï¼‰ã€‚
      è»å¸«èŸ‘åˆ°çˆ†æœƒç™¼èµ·æŒ‘æˆ°ï¼Œéœ€ç­”é¡Œéé—œæˆ–ç”¨æ¯’é¤Œæ‰èƒ½æ“Šæ•—ç‰ ã€‚
      æœ¬é—œéšœç¤™ï¼šä¸­å¤®ç¬¬ 3ã€4 è¡Œã€ç¬¬ 3 è‡³ 5 åˆ—ç‚ºæ²™ç™¼èŒ¶å‡ å€ï¼›ç½®ä¸­æœ€ä¸‹åˆ—ç¬¬ 7 è¡Œã€ç¬¬ 3 è‡³ 5 åˆ—ç‚ºé›»è¦–å€ã€‚
    </p>

    <!-- ç©å®¶ç‹€æ…‹å€å¡Š -->
    <section id="playerStatus" aria-label="ç©å®¶ç‹€æ…‹" style="margin: 1rem 0; font-weight: bold;">
      <div>å‹‡è€…ï¼š<span id="playerName">---</span></div>
      <div>è¡€é‡ï¼š<span id="playerHP">---</span></div>
      <div>é‡‘å¹£ï¼š<span id="playerCoins">---</span></div>
      <div><span id="weaponStatus">---</span></div>
      <!-- çµ¦è¢å¹•å ±è®€å™¨ç”¨çš„éš±å½¢æ‘˜è¦ -->
      <div id="srStatus" aria-live="polite" aria-atomic="true" role="status" class="sr-only"></div>
    </section>

    <!-- è§¸æ§æ§åˆ¶ -->
    <div id="touchControls" aria-label="è§¸æ§æ§åˆ¶">
      <button onclick="moveLeft()">â¬…ï¸ å·¦ç§»</button>
      <button onclick="moveRight()">â¡ï¸ å³ç§»</button>
      <button onclick="moveUp()">â¬†ï¸ ä¸Š</button>
      <button onclick="moveDown()">â¬‡ï¸ ä¸‹</button>
      <button onclick="scanArea()">ğŸ” æƒæ</button>
      <button onclick="attack()">ğŸ”¥ æ”»æ“Š</button>
      <button onclick="changeWeapon('fire')">1ï¸âƒ£ å™´ç«æ§</button>
      <button onclick="changeWeapon('spray')">2ï¸âƒ£ é¦™æ°›å™´éœ§</button>
      <button onclick="changeWeapon('slipper')">3ï¸âƒ£ è—ç™½æ‹–</button>
      <button onclick="changeWeapon('bait')">4ï¸âƒ£ æ¯’é¤Œ</button>
    </div>

    <!-- éŠæˆ²å ´åœ°ï¼šæœ¬é—œç‚º 7Ã—7 -->
    <div id="gameArea" role="group" aria-describedby="a11yHelp" aria-label="å®¢å»³æˆ°é¬¥å€ï¼š7ä¹˜7 æ ¼ç‹€å€åŸŸ" tabindex="0"></div>

    <div id="message" aria-live="assertive"></div>

    <!-- æ’­éŸ³ç”¨ audio -->
    <audio id="voicePlayer" src="" hidden></audio>
  </main>

  <!-- èƒŒæ™¯éŸ³æ¨‚ -->
  <audio id="bgm" src="assets/sounds/game_04.mp3" loop preload="auto"></audio>

  <!-- BGM äº’å‹•è§£é– + æ·¡å…¥ -->
  <script>
    (function () {
      document.body.classList.add('ready');
      const bgm = document.getElementById('bgm');
      function tryPlay() {
        bgm?.play().catch(()=>{});
        document.removeEventListener('click', tryPlay);
        document.removeEventListener('keydown', tryPlay);
        document.removeEventListener('touchstart', tryPlay);
      }
      document.addEventListener('click', tryPlay, { once: true });
      document.addEventListener('keydown', tryPlay, { once: true });
      document.addEventListener('touchstart', tryPlay, { once: true, passive: true });
    })();
  </script>

  <!-- è³‡æ–™ -->
  <script src="js/content/bugs.js"></script>
  <script src="js/content/levels.js"></script>

  <!-- æ ¸å¿ƒèˆ‡æ¨¡å¼ï¼ˆé †åºè¦ä¿æŒï¼šcore -> lane -> gridï¼‰ -->
  <script src="js/core/game-core.js"></script>
  <script src="js/core/mode-lane.js"></script>
  <script src="js/render/furniture.js"></script>
  <script src="js/core/mode-grid.js"></script>

  <script src="js/a11y/focus-hints.js"></script>
  <script src="js/a11y/announce-arbiter.js"></script>
  <script src="js/a11y/spawn-conductor.js"></script>

  <!-- å•ç­”èˆ‡ K4 å°è©±ï¼ˆé †åºå¾ˆé‡è¦ï¼šquiz.js â†’ å»ºç«‹å¯¦ä¾‹ â†’ k4_dialog.js â†’ wiring â†’ bootï¼‰ -->
  <script src="js/core/quiz.js"></script>
  <script>
    // å»ºç«‹å…¨åŸŸé¡Œåº«å¯¦ä¾‹ï¼ˆè·¯å¾‘ç”¨ä½ å¯¦éš›çš„ K4 é¡Œåº«ï¼‰
    window.quiz = new window.QuizEngine({
      dataUrl: 'assets/questions/questions_k4.json',
      voiceLang: 'zh-TW',
      enableTTS: true,
      readChoicesOnOpen: true,
      speakOnSelect: true
    });

    // å¯é¸ï¼šå…ˆé è¼‰é¡Œåº«ï¼Œé¿å…æŒ‰ Enter æ™‚æ‰ä¸‹è¼‰
    document.addEventListener('game-ready', async () => {
      try { await window.quiz.load(); } catch (e) {
        console.warn('[k4] quiz.load å¤±æ•—', e);
      }
    });
  </script>

  <script src="js/core/k4_dialog.js"></script>
  <script src="js/core/retry.js"></script>
  <script> Retry.rememberLevel(); </script>

  <!-- â˜… å°‡ k4_dialog ç¶é€²éŠæˆ²ï¼ˆä¿æŒç²¾ç°¡ã€äº¤ç”± k4_dialog æ¥ç®¡æµç¨‹ï¼‰ -->
  <script>
    document.addEventListener('game-ready', (e) => {
      const game = e.detail?.game || window.game;
      if (typeof window.bindK4Trigger === 'function')    window.bindK4Trigger(game);
      if (typeof window.bindQuizHandlers === 'function') window.bindQuizHandlers(game);
    });
  </script>

  <!-- å•Ÿå‹•è…³æœ¬ï¼ˆç¬¬ 4 é—œï¼‰ -->
  <script src="js/boot/game_l4.js"></script>

  <script src="js/core/keys.js"></script>

  <script>
    // boot å®Œæˆ/æˆ– game-ready ä¹‹å¾Œå‘¼å«ä¸€æ¬¡
    document.addEventListener('game-ready', () => {
      Keys.init({ scanFn: () => window.scanArea?.() });
    }, { once:true });
  </script>

  <script>
  /* === A11Y åˆå§‹åŒ–ï¼šé€²å ´ç„¦é»æç¤º + SR ç‹€æ…‹å ±è®€ä»²è£ === */
  document.addEventListener('game-ready', () => {
    // 1) é€²å ´æç¤ºèˆ‡è‡ªå‹•èšç„¦ï¼ˆNVDA ç„¦é»æ¨¡å¼ï¼‰
    const stageEl = document.getElementById('gameArea');
    window.__focusHints = A11YFocusHints.install({
      stageEl,
      // ä¸çµ¦ srEl ä¹Ÿè¡Œï¼Œæ¨¡çµ„æœƒè‡ªå»ºéš±å½¢ aria-live å®¹å™¨ï¼ˆpolite+atomicï¼‰
      hintText: 'æç¤ºï¼šå·²é€²å…¥éŠæˆ²ã€‚NVDA ä½¿ç”¨è€…è«‹æŒ‰ NVDA åŠ  ç©ºç™½ åˆ‡æ›åˆ°ç„¦é»æ¨¡å¼ï¼Œå†ç”¨æ–¹å‘éµæ“ä½œã€‚',
      // é è¨­ useSpeechSynthesis:falseï¼Œé¿å…å’Œä½ çš„éŠæˆ² TTS æ‰“æ¶
    });

    // 2) ç‹€æ…‹å ±è®€ä»²è£ï¼ˆåˆä½µï¼‹ç¯€æµï¼Œé¿é–‹ TTS èˆ‡ç”Ÿæ€ªåŠæ‹ï¼‰
    window.__arb = A11YArbiter.install({
      hpEl:   document.getElementById('playerHP'),
      coinEl: document.getElementById('playerCoins'),
      wpnEl:  document.getElementById('weaponStatus'),
      srEl:   document.getElementById('srStatus'),
      // å¦‚éœ€å¾®èª¿ä¸åŒé—œå¡ç¯€å¥å¯é–‹æ”¾ï¼š
      // coolDownMs: 1200, quietNeedMs: 400, checkInterval: 200,
    });
      // å®‰è£ SpawnConductorï¼ˆæŠŠ srStatus å‚³é€²ä¾†æ›´ç²¾æº–ï¼‰
    window.__sc = SpawnConductor.install({
      srEl: document.getElementById('srStatus'),
      // waitTimeout: 2200, quietNeed: 300, poll: 60,
      // è‹¥æœ‰ quiz èªéŸ³ï¼Œå»ºè­°ç”¨èˆ‡è©²é—œç›¸åŒçš„ ttsBusyFnï¼š
      ttsBusyFn: () => (Core._speechDepth > 0) || (speechSynthesis?.speaking)
    });
  });

    // ï¼ˆå¯é¸ï¼‰ç•¶æ¸¬é©—å°è©±æ¡†é–‹å•Ÿ/é—œé–‰æ™‚ï¼Œæš«åœ/æ¢å¾©éŠæˆ²çš„ç‹€æ…‹æ’­å ±
    // è‹¥ k4_dialog å…§æœ‰æ´¾ç™¼é€™å…©å€‹äº‹ä»¶ï¼Œé€™è£¡å°±èƒ½æ›ä¸Šï¼š
    window.addEventListener('quiz-open', () => { window.gameActive = false; });
    window.addEventListener('quiz-close', () => { window.gameActive = true;  });

  </script>

  <script>
  // åˆ‡é æˆ–é‡è¼‰æ™‚ï¼Œå–„å¾Œé‚„åŸ role/tabindex ç­‰
  window.addEventListener('beforeunload', () => {
    try { window.__focusHints?.destroy(); } catch(_){}
  });
  </script>
  <script>
  ;(() => {
    "use strict";

    // === æª”å â†’ ä¸­æ–‡è§’è‰²åï¼ˆå…¨éƒ¨å°å¯« keyï¼‰ ===
    const roleMap = {
      "kinbah.png": "é‡‘å·´",
      "mailah.png": "éº¥æ‹‰",
      "khaupe.png": "è€ƒç›ƒ",
      "holah.png": "èµ«æ‹‰",
      "chinaikhun.png": "é‡‘ï¼è‰¾æ†",
      "chiaulaipeh.png": "éƒŠï¼èŠåŒ—"
    };

    // å¯é å–æª”åï¼ˆå» query/hashï¼Œè½‰å°å¯«ï¼‰
    function fileKey(path){
      if (!path || typeof path !== "string") return "";
      const clean = path.split("#")[0].split("?")[0];
      const file  = clean.split("/").pop() || "";
      return file.toLowerCase();
    }

    // è®€ç©å®¶ â†’ {name, roleName, avatarPath}
    function readHero(){
      let p = {};
      try { p = JSON.parse(localStorage.getItem("bugSlayerPlayer") || "{}"); } catch {}
      const name = p?.name || "ç„¡åå‹‡è€…";
      const avatarPath = p?.avatar || "";
      const roleName = roleMap[fileKey(avatarPath)] || "æœªçŸ¥å‹‡è€…";
      return { name, roleName, avatarPath };
    }

    // åˆå§‹åŒ–å‹‡è€… UI
    function initHeroUI(){
      const { name, roleName, avatarPath } = readHero();

      // å‹‡è€…åç¨±ï¼ˆè§’è‰²ä¸­æ–‡åï¼æš±ç¨±ï¼‰
      const elName = document.getElementById("playerName");
      if (elName) elName.textContent = `${roleName}ï¼${name}`;

      // å³ä¸‹è§’è²¼åœ–ï¼ˆè£é£¾ï¼‰
      let sticker = document.getElementById("heroSticker");
      if (!sticker) {
        sticker = document.createElement("img");
        sticker.id = "heroSticker";
        sticker.className = "hero-sticker";
        sticker.alt = "";
        sticker.setAttribute("aria-hidden", "true");
        document.body.appendChild(sticker);
      }
      sticker.style.display = avatarPath ? "" : "none";
      if (avatarPath) sticker.src = avatarPath;
    }

    // æ””æˆª Core.updateUIï¼Œæ¯æ¬¡éƒ½ç¶­æŒé¡¯ç¤ºã€Œè§’è‰²ä¸­æ–‡åï¼æš±ç¨±ã€
    function patchUpdateUI(){
      if (!window.Core || typeof Core.updateUI !== "function") return false;
      if (Core.__patchedHeroName) return true;

      const orig = Core.updateUI.bind(Core);
      Core.updateUI = function(){
        orig();
        const { name, roleName } = readHero();
        const elName = document.getElementById("playerName");
        if (elName) elName.textContent = `${roleName}ï¼${name}`;
      };
      Core.__patchedHeroName = true;
      return true;
    }

    // ç¢ºä¿ patch æˆåŠŸï¼ˆäº‹ä»¶ + è¼ªè©¢ï¼‰
    function ensurePatched(){
      if (patchUpdateUI()) return;
      const t0 = Date.now();
      const timer = setInterval(() => {
        if (patchUpdateUI() || Date.now() - t0 > 5000) clearInterval(timer);
      }, 120);
    }

    document.addEventListener("DOMContentLoaded", initHeroUI);
    document.addEventListener("game-ready", () => {
      initHeroUI();
      ensurePatched();
    }, { once:true });
    window.addEventListener("load", ensurePatched, { once:true });
  })();
  </script>
  <script>
    Modes.applyModeOnLoad();
    Modes.bindQuickToggle();

    // è‹¥ä½ æœ‰éŠæˆ²èªéŸ³ï¼Œæ¨¡å¼åˆ‡æ›æ™‚ä¹Ÿå¯è£œä¸€æ®µèªªæ˜ï¼š
    document.addEventListener('keydown', (e)=>{
      if (e.shiftKey && (e.key === 'M' || e.key === 'm')) {
        // é€™è£¡ä¸ç”¨åšåˆ¥çš„ï¼Œmodes.js æœƒè™•ç† TTS + aria äº†
      }
    });
  </script>
  <script>
  /* SRNoiseGate v1 â€” å…¨åŸŸé—œ/é–‹ live regionï¼Œé¿å… NVDA æ¶è©± */
  (function (w) {
    'use strict';
    // ä½ è¦ã€Œç®¡æ§ã€çš„ live å…ƒç´ ï¼ˆå¯è¦–éœ€æ±‚åŠ ï¼‰
    const LIVE_SELECTORS = [
      '#srStatus',  // æˆ‘å€‘çš„ç‹€æ…‹æ’­å ±
      '#message',   // å¤§å¤šæ•¸é—œå¡ç”¨ä¾†é¡¯ç¤ºæç¤º/è­¦ç¤º
      '[role="status"][aria-live]',
      '[aria-live="polite"]',
      '[aria-live="assertive"]'
    ];

    // å– DOM + å»é‡
    function getLiveNodes() {
      const set = new Set();
      LIVE_SELECTORS.forEach(sel => {
        document.querySelectorAll(sel).forEach(n => set.add(n));
      });
      return Array.from(set);
    }

    // è¨˜ä½åŸæœ¬ aria-liveï¼Œä¹‹å¾Œæ¢å¾©
    const original = new WeakMap();
    function muteLiveRegions() {
      getLiveNodes().forEach(n => {
        if (!original.has(n)) original.set(n, n.getAttribute('aria-live') || '');
        n.setAttribute('aria-live', 'off');
      });
      // å‘Šè¨´ ATï¼šé é¢æš«æ™‚å¿™ï¼Œåˆ¥å¿µè®Šæ›´ï¼ˆè¼”åŠ©æ——æ¨™ï¼‰
      document.body.setAttribute('aria-busy', 'true');
    }
    function unmuteLiveRegions() {
      getLiveNodes().forEach(n => {
        const v = original.get(n);
        if (v === null || v === '') n.removeAttribute('aria-live');
        else n.setAttribute('aria-live', v);
      });
      document.body.removeAttribute('aria-busy');
    }

    // åˆ¤æ–· TTS æ˜¯å¦å¿™ç¢Œï¼ˆCore æˆ–ç€è¦½å™¨ TTS å…¶ä¸€ï¼‰
    function ttsBusy() {
      const coreBusy  = !!(w.Core && typeof Core._speechDepth === 'number' && Core._speechDepth > 0);
      const synthBusy = !!(w.speechSynthesis && speechSynthesis.speaking);
      return coreBusy || synthBusy;
    }

    // ç›£è½å™¨ï¼šå®šæœŸæŸ¥çœ‹ç‹€æ…‹è½‰è®Šï¼Œåªåœ¨ã€Œå¿™ç¢Œâ†’ç©ºé–’ã€ã€Œç©ºé–’â†’å¿™ç¢Œã€æ™‚åˆ‡æ›
    (function startWatcher() {
      let muted = false;
      setInterval(() => {
        const busy = ttsBusy();
        if (busy && !muted) { muteLiveRegions(); muted = true; }
        else if (!busy && muted) { unmuteLiveRegions(); muted = false; }
      }, 120);
    })();

    // è‹¥æœ‰ Quiz open/close äº‹ä»¶ä¹Ÿä¸€ä½µæ›ä¸Šï¼Œé€²ä¸€æ­¥éœéŸ³
    w.addEventListener?.('quiz-open',  muteLiveRegions);
    w.addEventListener?.('quiz-close', unmuteLiveRegions);

    // é€€å‡ºé é¢æ™‚æ¸…ç†
    w.addEventListener?.('beforeunload', unmuteLiveRegions);
  })(window);
  </script>

</body>
</html>
