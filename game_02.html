<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>第 2 關：主臥室（9 宮格） - 進擊的蟑螂</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />

  <link rel="stylesheet" href="style.css" />
  <script src="js/core/modes.js"></script>
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>

  <style>
    html, body { min-height: 100svh; }
    body {
      margin: 0; padding: 0;
      background: url("assets/images/game_bg2.png") no-repeat center center fixed;
      background-size: cover;
      font-family: sans-serif;
      opacity: 0; transition: opacity .6s ease;
      color:#111;
    }
    body.ready { opacity: 1; }

    main { padding: .75rem 1rem 1rem; }
    h1{ text-align:center; color:#fff; text-shadow:0 2px 8px rgba(0,0,0,.45); margin:.5rem 0 .25rem; }

    /* === 舞台：ModeGrid 會改成 display:grid；先給安全預設 === */
    #gameArea{
      display:flex; justify-content:center; gap:.45rem;
      margin:.5rem auto 0;
      max-width:min(94vw, 760px);
      outline: none;
      touch-action: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Grid 版：tile 填滿 cell，電腦/手機一致無縫或用 gap 控制縫隙 */
    .tile{
      width: 100%;
      height: 100%;
      display: flex;
      align-items:center;
      justify-content:center;
      font-size: 1.05rem;
      border: 2px solid #333;
      border-radius: 8px;
      text-align:center;
      background:rgba(238,238,238,0.6);  /* ← 半透明灰色 */
      user-select:none;
    }
    .tile.player { background:#cce5ff; }
    .tile.bug    { background:#f8d7da; }

    #message{
      margin-top:.6rem; font-weight:bold; text-align:center;
      color:#fff; text-shadow:0 2px 8px rgba(0,0,0,.45);
      min-height:1.2em;
    }

    /* SR-only */
    .sr-only{
      position:absolute !important; width:1px; height:1px;
      padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    /* 右下勇者貼紙（不擋操作） */
    .hero-sticker{
      position: fixed;
      right: 12px;
      bottom: calc(12px + env(safe-area-inset-bottom));
      width: min(21vw, 160px); max-width: 200px; height:auto;
      opacity:.95; pointer-events:none;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,.45));
      z-index: 10;
    }
    @media (max-width:480px){ .hero-sticker{ width:26vw; opacity:.9; } }

    /* 玩家狀態（桌機） */
    #playerStatus{
      margin:.4rem auto 0; padding:.5rem .75rem; max-width:960px;
      background: rgba(255,255,255,.15);
      border-radius:10px; color:#fff;
      text-shadow:0 2px 8px rgba(0,0,0,.45);
    }

    /* 行動版：縮標題、狀態浮動膠囊 */
    @media (pointer:coarse){
      h1{ font-size:1.05rem; font-weight:600; margin:.25rem 0 .1rem; }
      #playerStatus{
        position:fixed; top:calc(8px + env(safe-area-inset-top)); left:8px; right:8px; z-index:18;
        display:flex; flex-wrap:wrap; gap:.25rem .6rem; align-items:center;
        padding:.35rem .6rem;
        background: rgba(0,0,0,.35);
        backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
        border-radius:12px;
        font-size:.9rem; line-height:1.2; color:#fff; text-shadow:0 1px 3px rgba(0,0,0,.35);
      }
      main{ padding-top: calc(2.6rem + env(safe-area-inset-top)); }
    }

    /* 左下：武器選單浮動鈕 + 垂直子選單（僅手機顯示） */
    #weaponToggle{
      position:fixed; left:12px; bottom:calc(12px + env(safe-area-inset-bottom));
      z-index:25;
      background:#ffd452; color:#222; border:none; border-radius:50%;
      width:52px; height:52px; font-size:1.25rem;
      box-shadow:0 3px 10px rgba(0,0,0,.3);
      display:none;
    }
    #weaponMenu{
      position:fixed; left:12px; bottom:calc(72px + env(safe-area-inset-bottom));
      display:none; flex-direction:column; gap:.35rem; z-index:26;
    }
    #weaponMenu button{
      background:#ffd452; color:#222; border:none; border-radius:10px;
      font-size:.9rem; padding:.42rem .55rem; min-width:68px;
      box-shadow:0 3px 8px rgba(0,0,0,.25);
    }
    #weaponMenu button:disabled{ opacity:.55; filter:saturate(.7); }
    #weaponToggle{ display:inline-flex; align-items:center; justify-content:center; }
    }
  </style>
</head>
<body class="stage2">

  <main>
    <h1>床上好像有什麼東西在爬...</h1>
    <h1>啊！牠會飛！</h1>

    <p class="sr-only" id="a11yHelp">
      鍵盤：上下左右移動；空白鍵掃描；Enter 攻擊；數字 1~3 切武器。手機：四向滑動移動、單擊掃描、雙擊攻擊。
    </p>

    <!-- 玩家狀態 -->
    <section id="playerStatus" aria-label="玩家狀態">
      <div>勇者：<span id="playerName">---</span></div>
      <div>血量：<span id="playerHP">---</span></div>
      <div>金幣：<span id="playerCoins">---</span></div>
      <div><span id="weaponStatus">---</span></div>
      <div id="srStatus" aria-live="polite" aria-atomic="true" role="status" class="sr-only"></div>
    </section><br><br>

    <!-- 3×3 九宮格舞台（ModeGrid 會把它變成 grid） -->
    <div id="gameArea" role="group" aria-describedby="a11yHelp" aria-label="主臥室戰鬥區：3乘3 九宮格" tabindex="0"></div>

    <div id="message" aria-live="assertive"></div>

    <!-- 播音用 audio -->
    <audio id="voicePlayer" src="" hidden></audio>
  </main>

  <!-- 手機：武器浮動按鈕 + 子選單 -->
  <button id="weaponToggle" aria-label="武器選單">⚔️</button>
  <div id="weaponMenu" role="menu" aria-label="武器選單">
    <button data-wpn="fire"    aria-keyshortcuts="1">1️⃣ 噴火槍</button>
    <button data-wpn="spray"   aria-keyshortcuts="2">2️⃣ 噴霧</button>
    <button data-wpn="slipper" aria-keyshortcuts="3">3️⃣ 拖鞋</button>
    <button data-wpn="bait"    aria-keyshortcuts="4" disabled>4️⃣ 毒餌</button>
    <button data-wpn="cat"     aria-keyshortcuts="5" disabled>5️⃣ 養貓</button>
    <button data-wpn="vote"    aria-keyshortcuts="6" disabled>6️⃣ 連署</button>
    <button data-wpn="recall"  aria-keyshortcuts="7" disabled>7️⃣ 罷免</button>
  </div>

  <!-- 背景音樂 -->
  <audio id="bgm" src="assets/sounds/game_02.mp3" loop preload="auto"></audio>

  <!-- BGM 解鎖與登記 -->
  <script>
    AudioFX.init();
    const bgm = document.getElementById('bgm');
    AudioFX.register(bgm);
    window.addEventListener('game-ready', () => { try { AudioFX.ensure(); } catch(_) {} });
  </script>

  <!-- 內容與核心 -->
  <script src="js/content/bugs.js"></script>
  <script src="js/content/levels.js"></script>

  <script src="js/core/game-core.js"></script>
  <script src="js/core/mode-lane.js"></script>
  <script src="js/render/furniture.js"></script>
  <script src="js/core/mode-grid.js"></script>

  <script src="js/a11y/focus-hints.js"></script>
  <script src="js/a11y/announce-arbiter.js"></script>
  <script src="js/a11y/spawn-conductor.js"></script>

  <!-- 第 2 關啟動（會設定 ModeGrid、講開場，講完才 spawnBug） -->
  <script src="js/boot/game_l2.js"></script>

  <script src="js/core/retry.js"></script>
  <script> Retry.rememberLevel(); </script>
  <script src="js/core/keys.js"></script>

  <!-- 鍵盤初始化（boot 完成/或 game-ready 後） -->
  <script>
    document.addEventListener('game-ready', () => {
      const stage = document.getElementById('gameArea');
      Keys.init({
        stageEl: stage,
        scanFn: () => window.scanArea?.(),
        activeGuardFn: () => window.gameActive !== false
      });
    }, { once:true });
  </script>

  <!-- A11Y 初始化 -->
  <script>
    document.addEventListener('game-ready', () => {
      const stageEl = document.getElementById('gameArea');
      window.__focusHints = A11YFocusHints.install({
        stageEl,
        hintText: '提示：已進入遊戲。NVDA 使用者請按 NVDA+空白 進入焦點模式，再用方向鍵操作。'
      });
      window.__arb = A11YArbiter.install({
        hpEl:   document.getElementById('playerHP'),
        coinEl: document.getElementById('playerCoins'),
        wpnEl:  document.getElementById('weaponStatus'),
        srEl:   document.getElementById('srStatus'),
      });
      window.__sc = SpawnConductor.install({ srEl: document.getElementById('srStatus') });
    });

    window.addEventListener('beforeunload', () => {
      try { window.__focusHints?.destroy(); } catch(_){}
    });
  </script>

  <!-- 勇者名稱貼圖補丁 -->
  <script>
  ;(() => {
    "use strict";
    const roleMap = {
      "kinbah.png":"金巴","mailah.png":"麥拉","khaupe.png":"考盃","holah.png":"赫拉",
      "chinaikhun.png":"金．艾捆","chiaulaipeh.png":"郊．萊北","mienphapan.png":"綿葩．坂","hamchuniok.png":"罕族．拗"
    };
    const fileKey = (p)=> (String(p||'').split('#')[0].split('?')[0].split('/').pop()||'').toLowerCase();
    function readHero(){
      let p={}; try{ p=JSON.parse(localStorage.getItem("bugSlayerPlayer")||"{}"); }catch(_){}
      const name=p?.name||"無名勇者", avatarPath=p?.avatar||"", roleName=roleMap[fileKey(avatarPath)]||"未知勇者";
      return { name, roleName, avatarPath };
    }
    function initHeroUI(){
      const { name, roleName, avatarPath } = readHero();
      const elName = document.getElementById("playerName");
      if (elName) elName.textContent = `${roleName}．${name}`;
      let sticker = document.getElementById("heroSticker");
      if (!sticker) {
        sticker = document.createElement("img");
        sticker.id = "heroSticker";
        sticker.className = "hero-sticker";
        sticker.alt = ""; sticker.setAttribute("aria-hidden","true");
        document.body.appendChild(sticker);
      }
      sticker.style.display = avatarPath ? "" : "none";
      if (avatarPath) sticker.src = avatarPath;
    }
    function patchUpdateUI(){
      if (!window.Core || typeof Core.updateUI !== "function") return false;
      if (Core.__patchedHeroName) return true;
      const orig = Core.updateUI.bind(Core);
      Core.updateUI = function(){
        orig();
        const { name, roleName } = readHero();
        const elName = document.getElementById("playerName");
        if (elName) elName.textContent = `${roleName}．${name}`;
      };
      Core.__patchedHeroName = true; return true;
    }
    function ensurePatched(){
      if (patchUpdateUI()) return;
      const t0=Date.now(), timer=setInterval(()=>{ if (patchUpdateUI() || Date.now()-t0>5000) clearInterval(timer); },120);
    }
    document.addEventListener("DOMContentLoaded", initHeroUI);
    document.addEventListener("game-ready", () => { initHeroUI(); ensurePatched(); }, { once:true });
    window.addEventListener("load", ensurePatched, { once:true });
  })();
  </script>

  <!-- 等 TTS 完整後再生第一隻 -->
  <script>
  (function(){
    document.addEventListener('game-ready', async function(){
      try {
        window.__gateOpen = true;
        while (window.Core && Core._speechDepth > 0) {
          await new Promise(r => setTimeout(r, 120));
        }
        window.__gateOpen = false;
        if (window.Core && typeof Core.spawnBug === 'function') Core.spawnBug();
      } catch(_) {}
    }, { once: true });
  })();
  </script>

  <!-- 模式切換（Shift+M） -->
  <script>
    Modes.applyModeOnLoad();
    Modes.bindQuickToggle();
  </script>

  <!-- 舞台手勢：單擊掃描、雙擊攻擊、四向滑動移動 -->
  <script>
  (function(){
    const area = document.getElementById('gameArea');
    if (!area) return;

    let t1 = 0, x1 = 0, y1 = 0;
    let sx=0, sy=0;

    area.addEventListener('touchstart', (e)=>{
      const t = e.changedTouches[0]; sx = t.clientX; sy = t.clientY;
    }, { passive: true });

    area.addEventListener('touchend', (e)=>{
      const now = Date.now();
      const t = e.changedTouches[0];
      const dx = t.clientX - sx, dy = t.clientY - sy;
      const adx = Math.abs(dx), ady = Math.abs(dy);

      const TAP_DIST = 16;
      const DBL_MS   = 280;
      const SWIPE    = 28;

      if (adx > SWIPE || ady > SWIPE) {
        if (adx > ady) { (dx > 0 ? window.moveRight : window.moveLeft)?.(); }
        else           { (dy > 0 ? window.moveDown  : window.moveUp  )?.(); }
        t1 = 0; return;
      }

      if (!t1) {
        t1 = now; x1 = t.clientX; y1 = t.clientY;
        setTimeout(()=>{ if (t1 && (Date.now()-t1)>=DBL_MS) { t1=0; window.scanArea?.(); } }, DBL_MS+10);
      } else {
        const dt = now - t1;
        const dd = Math.hypot(t.clientX - x1, t.clientY - y1);
        if (dt <= DBL_MS && dd <= TAP_DIST) { t1 = 0; window.attack?.(); }
        else {
          t1 = now; x1 = t.clientX; y1 = t.clientY;
          setTimeout(()=>{ if (t1 && (Date.now()-t1)>=DBL_MS) { t1=0; window.scanArea?.(); } }, DBL_MS+10);
        }
      }
    }, { passive: true });
  })();
  </script>

  <!-- 武器浮動選單（手機） -->
  <script>
  (function(){
    const toggle = document.getElementById('weaponToggle');
    const menu   = document.getElementById('weaponMenu');
    if (!toggle || !menu) return;

    let open = false;
    const show = ()=>{ menu.style.display='flex'; open=true; };
    const hide = ()=>{ menu.style.display='none'; open=false; };
    const toggleMenu = ()=>{ open ? hide() : show(); };

    toggle.addEventListener('click', toggleMenu);
    document.addEventListener('click', (e)=>{ if (open && !menu.contains(e.target) && e.target!==toggle) hide(); });

    menu.addEventListener('click',(e)=>{
      const btn=e.target.closest('button[data-wpn]'); if(!btn || btn.disabled) return;
      window.changeWeapon?.(btn.dataset.wpn); hide();
    });

    document.addEventListener('DOMContentLoaded',()=>{
      ['fire','spray','slipper'].forEach(id=> menu.querySelector(`button[data-wpn="${id}"]`)?.removeAttribute('disabled'));
    });
  })();
  </script>

  <!-- SR live region 噪音門 + 淡入 -->
  <script>
  (function (w) {
    'use strict';
    const LIVE_SELECTORS = ['#srStatus','#message','[role="status"][aria-live]','[aria-live="polite"]','[aria-live="assertive"]'];
    const getLiveNodes = () => { const set=new Set(); LIVE_SELECTORS.forEach(sel=>{ document.querySelectorAll(sel).forEach(n=>set.add(n)); }); return Array.from(set); };
    const original = new WeakMap();
    function mute(){ getLiveNodes().forEach(n=>{ if(!original.has(n)) original.set(n, n.getAttribute('aria-live')||''); n.setAttribute('aria-live','off'); }); document.body.setAttribute('aria-busy','true'); }
    function unmute(){ getLiveNodes().forEach(n=>{ const v=original.get(n); if(v===null||v==='') n.removeAttribute('aria-live'); else n.setAttribute('aria-live',v); }); document.body.removeAttribute('aria-busy'); }
    const busy = ()=> !!(w.Core && typeof Core._speechDepth==='number' && Core._speechDepth>0) || !!(w.speechSynthesis && speechSynthesis.speaking);
    (function watch(){ let m=false; setInterval(()=>{ const b=busy(); if(b && !m){ mute(); m=true; } else if(!b && m){ unmute(); m=false; } }, 120); })();
    w.addEventListener?.('quiz-open',  mute);
    w.addEventListener?.('quiz-close', unmute);
    w.addEventListener?.('beforeunload', unmute);
    document.addEventListener('DOMContentLoaded', () => { document.body.classList.add('ready'); });
  })(window);
  </script>
</body>
</html>
