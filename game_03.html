<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ç¬¬ 3 é—œï¼šå»æ‰€æµ´å®¤ï¼ˆ6Ã—3ï¼‰ - é€²æ“Šçš„èŸ‘è‚</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />

  <link rel="stylesheet" href="style.css" />
  <script src="js/core/modes.js"></script>
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>

  <style>
    html, body { min-height: 100svh; }
    body{
      margin:0; padding:0;
      background:url("assets/images/game_bg3.png") no-repeat center center fixed;
      background-size:cover;
      font-family:sans-serif;
      color:#111;
      opacity:0; transition:opacity .6s ease;
    }
    body.ready{ opacity:1; }

    main{ padding:.75rem 1rem 1rem; }
    h1{ text-align:center; color:#fff; text-shadow:0 2px 8px rgba(0,0,0,.45); margin:.5rem 0 .25rem; }

    /* èˆå°ï¼šModeGrid æœƒæŠŠå®ƒè®Šæˆ display:gridï¼›å…ˆçµ¦å®‰å…¨é è¨­ */
    #gameArea{
      display:flex; justify-content:center; gap:.45rem;
      margin:.5rem auto 0;
      max-width:min(94vw, 860px);
      outline:none;
      touch-action:none;
      -webkit-tap-highlight-color:transparent;
    }

    /* tile å¡«æ»¿æ¯å€‹ grid cellï¼Œé›»è…¦/æ‰‹æ©Ÿä¸€è‡´ */
    .tile{
      width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      font-size:1.05rem;
      border:2px solid #333; border-radius:8px;
      text-align:center;
      background:rgba(238,238,238,0.6);  /* â† åŠé€æ˜ç°è‰² */
      user-select:none;
    }
    .tile.player{ background:#cce5ff; }
    .tile.bug{ background:#f8d7da; }
    .tile.hazard{ box-shadow: inset 0 0 0 3px rgba(255,255,255,.2); }

    #message{
      margin-top:.6rem; font-weight:bold; text-align:center;
      color:#fff; text-shadow:0 2px 8px rgba(0,0,0,.45);
      min-height:1.2em;
    }

    /* SR-only */
    .sr-only{
      position:absolute!important; width:1px; height:1px;
      padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0);
      white-space:nowrap; border:0;
    }

    /* å³ä¸‹å‹‡è€…è²¼ç´™ï¼ˆä¸æ“‹æ“ä½œï¼‰ */
    .hero-sticker{
      position:fixed; right:12px; bottom:calc(12px + env(safe-area-inset-bottom));
      width:min(21vw,160px); max-width:200px; height:auto;
      opacity:.95; pointer-events:none;
      filter:drop-shadow(0 6px 18px rgba(0,0,0,.45));
      z-index:10;
    }
    @media (max-width:480px){ .hero-sticker{ width:26vw; opacity:.9; } }

    /* ç©å®¶ç‹€æ…‹ï¼ˆæ¡Œæ©Ÿï¼‰ */
    #playerStatus{
      margin:.4rem auto 0; padding:.5rem .75rem; max-width:960px;
      background:rgba(255,255,255,.15);
      border-radius:10px; color:#fff;
      text-shadow:0 2px 8px rgba(0,0,0,.45);
    }

    /* è¡Œå‹•ç‰ˆï¼šç¸®æ¨™é¡Œã€ç‹€æ…‹è† å›Š */
    @media (pointer:coarse){
      h1{ font-size:1.05rem; font-weight:600; margin:.25rem 0 .1rem; }
      #playerStatus{
        position:fixed; top:calc(8px + env(safe-area-inset-top)); left:8px; right:8px; z-index:18;
        display:flex; flex-wrap:wrap; gap:.25rem .6rem; align-items:center;
        padding:.35rem .6rem;
        background:rgba(0,0,0,.35);
        backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
        border-radius:12px;
        font-size:.9rem; line-height:1.2; color:#fff; text-shadow:0 1px 3px rgba(0,0,0,.35);
      }
      main{ padding-top:calc(2.6rem + env(safe-area-inset-top)); }
    }

    /* æ‰‹æ©Ÿï¼šå·¦ä¸‹æ­¦å™¨æµ®å‹•éˆ•ï¼‹å‚ç›´å­é¸å–® */
    #weaponToggle{
      position:fixed; left:12px; bottom:calc(12px + env(safe-area-inset-bottom));
      z-index:25;
      background:#ffd452; color:#222; border:none; border-radius:50%;
      width:52px; height:52px; font-size:1.25rem;
      box-shadow:0 3px 10px rgba(0,0,0,.3);
      display:none;
    }
    #weaponMenu{
      position:fixed; left:12px; bottom:calc(72px + env(safe-area-inset-bottom));
      display:none; flex-direction:column; gap:.35rem; z-index:26;
    }
    #weaponMenu button{
      background:#ffd452; color:#222; border:none; border-radius:10px;
      font-size:.9rem; padding:.42rem .55rem; min-width:68px;
      box-shadow:0 3px 8px rgba(0,0,0,.25);
    }
    #weaponMenu button:disabled{ opacity:.55; filter:saturate(.7); }
    #weaponToggle{ display:inline-flex; align-items:center; justify-content:center; }
  </style>
</head>
<body class="stage3">
  <main>
    <h1>å»æ‰€æµ´å®¤è¢«ä½”é ˜äº†ï¼ï¼ï¼</h1>
    <p class="sr-only" id="a11yHelp">
      éµç›¤ï¼šä¸Šä¸‹å·¦å³ç§»å‹•ï¼›ç©ºç™½éµæƒæï¼›Enter æ”»æ“Šï¼›æ•¸å­— 1~4 åˆ‡æ›æ­¦å™¨ã€‚
      æ‰‹æ©Ÿè‹¥å·²é–‹å•Ÿè¢å¹•é–±è®€å™¨ï¼šäºŒæŒ‡æ»‘å‹•ç§»å‹•ï¼›å–®æŒ‡é›™æ“Šä»»æ„ä½ç½®æ”»æ“Šï¼Œè¢å¹•å·¦ä¸‹è§’æ­¦å™¨é¸å–®ã€‚
      æœ¬é—œæœ‰éš¨æ©Ÿã€Œè‚¥çš‚ã€é™·é˜±ï¼›è¸©åˆ°å°‡æ–¼ 2 ç§’å…§æ»‘å€’ä¸¦æ‰£è¡€ 3 ã€‚
    </p>

    <!-- ç©å®¶ç‹€æ…‹ -->
    <section id="playerStatus" aria-label="ç©å®¶ç‹€æ…‹">
      <div>å‹‡è€…ï¼š<span id="playerName">---</span></div>
      <div>è¡€é‡ï¼š<span id="playerHP">---</span></div>
      <div>é‡‘å¹£ï¼š<span id="playerCoins">---</span></div>
      <div><span id="weaponStatus">---</span></div>
      <div id="srStatus" aria-live="polite" aria-atomic="true" role="status" class="sr-only"></div>
    </section><br><br>

    <!-- 6Ã—3 èˆå°ï¼ˆModeGrid æœƒæŠŠå®ƒè®Šæˆ gridï¼‰ -->
    <div id="gameArea" role="group" aria-describedby="a11yHelp" aria-label="å»æ‰€æµ´å®¤æˆ°é¬¥å€ï¼š6ä¹˜3 æ ¼ç‹€å€åŸŸ" tabindex="0"></div>

    <div id="message" aria-live="assertive"></div>

    <!-- æ’­éŸ³ç”¨ audio -->
    <audio id="voicePlayer" src="" hidden></audio>
  </main>

  <!-- æ‰‹æ©Ÿï¼šæ­¦å™¨æµ®å‹•é¸å–®ï¼ˆç¬¬ 3 é—œé–‹æ”¾ 1ï½4ï¼‰ -->
  <button id="weaponToggle" aria-label="æ­¦å™¨é¸å–®">âš”ï¸</button>
  <div id="weaponMenu" role="menu" aria-label="æ­¦å™¨é¸å–®">
    <button role="menuitem"
        id="btnModeToggle"
        aria-keyshortcuts="Shift+M"
        title="åˆ‡æ›è¦–è¦º/ç´”è½è¦ºæ¨¡å¼ï¼ˆç­‰åŒ Shift+Mï¼‰">
      ğŸ‘ï¸ åˆ‡æ›æ¨¡å¼
    </button>

    <button data-wpn="fire"    aria-keyshortcuts="1">1ï¸âƒ£ å™´ç«æ§</button>
    <button data-wpn="spray"   aria-keyshortcuts="2">2ï¸âƒ£ é¦™æ°›å™´éœ§</button>
    <button data-wpn="slipper" aria-keyshortcuts="3">3ï¸âƒ£ è—ç™½æ‹–</button>
    <button data-wpn="bait"    aria-keyshortcuts="4">4ï¸âƒ£ æ¯’é¤Œ</button>
    <button data-wpn="cat"     aria-keyshortcuts="5" disabled>5ï¸âƒ£ é¤Šè²“</button>
    <button data-wpn="vote"    aria-keyshortcuts="6" disabled>6ï¸âƒ£ é€£ç½²</button>
    <button data-wpn="recall"  aria-keyshortcuts="7" disabled>7ï¸âƒ£ ç½·å…</button>
  </div>

  <!-- BGM -->
  <audio id="bgm" src="assets/sounds/game_03.mp3" loop preload="auto"></audio>

  <!-- BGM è§£é–èˆ‡ç™»è¨˜ -->
  <script>
    AudioFX.init();
    const bgm = document.getElementById('bgm');
    AudioFX.register(bgm);
    window.addEventListener('game-ready', () => { try { AudioFX.ensure(); } catch(_) {} });
  </script>

  <!-- å…§å®¹èˆ‡æ ¸å¿ƒ -->
  <script src="js/content/bugs.js"></script>
  <script src="js/content/levels.js"></script>

  <script src="js/core/game-core.js"></script>
  <script src="js/core/mode-lane.js"></script>
  <script src="js/render/furniture.js"></script>
  <script src="js/core/mode-grid.js"></script>

  <script src="js/a11y/focus-hints.js"></script>
  <script src="js/a11y/announce-arbiter.js"></script>
  <script src="js/a11y/spawn-conductor.js"></script>

  <script type="module" src="./js/core/input-adapter.js"></script>

  <!-- ç¬¬ 3 é—œå•Ÿå‹•ï¼ˆæœƒè¨­å®š 6Ã—3ã€è¬›é–‹å ´ï¼Œè¬›å®Œæ‰ spawnBugï¼‰ -->
  <script src="js/boot/game_l3.js"></script>

  <script src="js/core/keys.js"></script>
  <script src="js/core/retry.js"></script>
  <script> Retry.rememberLevel(); </script>

      <!-- SR å°ˆç”¨æ§åˆ¶ç–Šå±¤ï¼ˆVoiceOver/TalkBackï¼‰ -->
  <div id="srControlOverlay" aria-hidden="false" aria-label="è§¸æ§æ§åˆ¶é¢æ¿">
    <div id="srDpad" class="pad" role="group" aria-label="æ–¹å‘æ“ä½œ">
      <span class="empty" aria-hidden="true"></span>
      <button type="button" data-key="ArrowUp"    aria-label="å‘ä¸Š">â†‘</button>
      <span class="empty" aria-hidden="true"></span>

      <button type="button" data-key="ArrowLeft"  aria-label="å‘å·¦">â†</button>
      <span class="empty" aria-hidden="true"></span>
      <button type="button" data-key="ArrowRight" aria-label="å‘å³">â†’</button>

      <span class="empty" aria-hidden="true"></span>
      <button type="button" data-key="ArrowDown"  aria-label="å‘ä¸‹">â†“</button>
      <span class="empty" aria-hidden="true"></span>
    </div>

    <div id="srEnter" class="pad" role="group" aria-label="ç¢ºèªå‹•ä½œ">
      <button type="button" data-key="Enter" aria-label="ç¢ºèª">ENTER</button>
    </div>
  </div>

  <button id="srAttackFull" aria-label="æ”»æ“Šï¼ˆå…¨ç•«é¢é›™æ“Šï¼‰" title="æ”»æ“Šï¼ˆå…¨ç•«é¢é›™æ“Šï¼‰"></button>

  <!-- éµç›¤åˆå§‹åŒ– -->
  <script>
    document.addEventListener('game-ready', () => {
      const stage = document.getElementById('gameArea');
      Keys.init({
        stageEl: stage,
        scanFn: () => window.scanArea?.(),
        activeGuardFn: () => window.gameActive !== false
      });
    }, { once:true });
  </script>

  <script>
  (function(){
    // === ç›´æ¥å‘¼å«ä½ çš„å‹•ä½œ API ===
    function act(key){
      switch(key){
        case 'ArrowLeft':  return window.moveLeft?.();
        case 'ArrowRight': return window.moveRight?.();
        case 'ArrowUp':    return window.moveUp?.();
        case 'ArrowDown':  return window.moveDown?.();
        case 'Enter':      return window.attack?.();
        case 'Scan':       return window.scanArea?.();
      }
    }

    // ===== å…¨è¢å¹•æ‰‹å‹¢ï¼šæ»‘å‹•=ç§»å‹•ï¼›å–®æ“Š=æƒæï¼›é›™æ“Š=æ”»æ“Š =====
    const G = {
      active:false, startX:0, startY:0,
      lastTapTime:0, lastTapX:0, lastTapY:0,
      singleTapTimer:null,
      threshold:24, edge:10, dblTime:280, dblDist:24
    };

    function isInSafeArea(x,y){ const w=innerWidth,h=innerHeight,e=G.edge; return (x>e && x<w-e && y>e && y<h-e); }
    function isInteractiveTarget(el){
      return !!el.closest?.(
        '#catDialog:not([hidden]), #weaponMenu,'+
        'button, a, input, select, textarea,'+
        '[role="button"], [role="dialog"], [aria-haspopup]'
      );
    }

    function onTouchStart(e){
      const t=e.changedTouches?.[0]; if(!t) return;
      if (e.touches?.length>1) return;
      if (!isInSafeArea(t.clientX,t.clientY)) return;
      if (isInteractiveTarget(e.target)) return;
      if (window.gameActive===false) return;
      G.active=true; G.startX=t.clientX; G.startY=t.clientY;
    }
    function onTouchEnd(e){
      const t=e.changedTouches?.[0]; if(!t) return;
      const dx=t.clientX-G.startX, dy=t.clientY-G.startY;
      const ax=Math.abs(dx), ay=Math.abs(dy);
      if (G.active && (ax>=G.threshold || ay>=G.threshold)){
        G.active=false;
        if (ax>ay) act(dx>0?'ArrowRight':'ArrowLeft');
        else       act(dy>0?'ArrowDown' :'ArrowUp');
        clearSingleTap(); return;
      }
      handleTap(t); G.active=false;
    }
    function handleTap(t){
      const now=performance.now();
      const dt=now-G.lastTapTime;
      const dd=Math.max(Math.abs(t.clientX-G.lastTapX), Math.abs(t.clientY-G.lastTapY));
      G.lastTapTime=now; G.lastTapX=t.clientX; G.lastTapY=t.clientY;
      if (dt<=G.dblTime && dd<=G.dblDist){
        clearSingleTap(); act('Enter'); G.lastTapTime=0; return;
      }
      clearSingleTap();
      G.singleTapTimer=setTimeout(()=>{ act('Scan'); G.singleTapTimer=null; }, G.dblTime+10);
    }
    function clearSingleTap(){ if (G.singleTapTimer){ clearTimeout(G.singleTapTimer); G.singleTapTimer=null; } }

    const supportsTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints>0) || matchMedia('(pointer:coarse)').matches;
    if (supportsTouch){
      document.addEventListener('touchstart', onTouchStart, { passive:true });
      document.addEventListener('touchend',   onTouchEnd,   { passive:true });
    }

    // ===== SR æ§åˆ¶é¢æ¿ï¼ˆD-pad/Enterï¼‰é…ç·šï¼ˆå¯é¸é–‹å•Ÿï¼‰ =====
    const dpad     = document.getElementById('srDpad');
    const enterPad = document.getElementById('srEnter');

    (function wireSrPad(){
      const hook = (root)=> root?.addEventListener('click', (e)=>{
        const btn=e.target.closest('button[data-key]'); if(!btn) return;
        act(btn.getAttribute('data-key'));
      });
      hook(dpad); hook(enterPad);
    })();

    // é¡¯ç¤º/éš±è—é¢æ¿ APIï¼ˆä¸å†ä¾è³´ srToggleï¼‰
    function showOverlay(){
      document.body.classList.add('show-sr-overlay');
      document.querySelector('#srEnter button')?.focus({ preventScroll:true });
      setTimeout(()=>{ document.getElementById('srAttackFull')?.focus({ preventScroll:true }); }, 30);
    }
    function hideOverlay(){
      document.body.classList.remove('show-sr-overlay');
    }

    // ===== æ°¸é çµ¦ SR é›™æ“Šä¸€å€‹ç„¦é»ç›®æ¨™ï¼ˆå…¨ç•«é¢æ”»æ“Šï¼‰ =====
    const fullBtn = document.getElementById('srAttackFull');
    fullBtn.addEventListener('click', ()=> act('Enter'));
    fullBtn.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); act('Enter'); } });

    function uiBlocking(){
      const catOpen  = !!document.querySelector('#catDialog:not([hidden]):not(.sr-only)');
      const menu     = document.getElementById('weaponMenu');
      const menuOpen = !!menu && getComputedStyle(menu).display!=='none';
      const quizBusy = document.body.classList.contains('quiz-open');
      const a=document.activeElement, inForm=a && /^(INPUT|SELECT|TEXTAREA)$/.test(a.tagName);
      return catOpen || menuOpen || quizBusy || inForm;
    }
    function ensureFullAttackFocus(){
      if (uiBlocking()) return;
      if (document.activeElement !== fullBtn) fullBtn.focus({ preventScroll:true });
    }
    setInterval(ensureFullAttackFocus, 1200);

    window.addEventListener('quiz-open',  ()=> document.body.classList.add('quiz-open'));
    window.addEventListener('quiz-close', ()=> { document.body.classList.remove('quiz-open'); setTimeout(ensureFullAttackFocus,80); });
    window.addEventListener('cat-open',   ()=> {});
    window.addEventListener('cat-close',  ()=> setTimeout(ensureFullAttackFocus,80));
    document.addEventListener('click',    ()=> setTimeout(ensureFullAttackFocus,120));
    document.addEventListener('DOMContentLoaded', ()=> setTimeout(ensureFullAttackFocus,200));

    // 3-Aï¼šæ¡Œæ©Ÿæ¸¬è©¦ç†±éµï¼ˆShift+Oï¼‰
    document.addEventListener('keydown', (e)=>{
      if (e.shiftKey && (e.key==='O' || e.key==='o')){
        if (document.body.classList.contains('show-sr-overlay')) hideOverlay();
        else showOverlay();
      }
    });

    // 3-Bï¼šSR å°ˆç”¨éš±è—æŒ‰éˆ•ï¼ˆä½ å·²æ”¾åœ¨ HTML äº†ï¼‰
    document.getElementById('srOverlayOpener')?.addEventListener('click', ()=> showOverlay());
  })();
  </script>

  <!-- A11Y åˆå§‹åŒ– -->
  <script>
  document.addEventListener('game-ready', () => {
    const stageEl = document.getElementById('gameArea');
    window.__focusHints = A11YFocusHints.install({
      stageEl,
      hintText: 'æç¤ºï¼šå·²é€²å…¥éŠæˆ²ã€‚NVDA ä½¿ç”¨è€…è«‹æŒ‰ NVDA+ç©ºç™½ é€²å…¥ç„¦é»æ¨¡å¼ï¼Œå†ç”¨æ–¹å‘éµæ“ä½œã€‚'
    });
    window.__arb = A11YArbiter.install({
      hpEl:   document.getElementById('playerHP'),
      coinEl: document.getElementById('playerCoins'),
      wpnEl:  document.getElementById('weaponStatus'),
      srEl:   document.getElementById('srStatus'),
    });
    window.__sc = SpawnConductor.install({ srEl: document.getElementById('srStatus') });
  });

  window.addEventListener('beforeunload', () => {
    try { window.__focusHints?.destroy(); } catch(_){}
  });
  </script>

  <!-- å‹‡è€…åç¨±è²¼åœ–è£œä¸ -->
  <script>
  ;(() => {
    "use strict";
    const roleMap = {
      "kinbah.png":"é‡‘å·´","mailah.png":"éº¥æ‹‰","khaupe.png":"è€ƒç›ƒ","holah.png":"èµ«æ‹‰",
      "chinaikhun.png":"é‡‘ï¼è‰¾æ†","chiaulaipeh.png":"éƒŠï¼èŠåŒ—","mienphapan.png":"ç¶¿è‘©ï¼å‚","hamchuniok.png":"ç½•æ—ï¼æ‹—"
    };
    const fileKey = (p)=> (String(p||'').split('#')[0].split('?')[0].split('/').pop()||'').toLowerCase();
    function readHero(){
      let p={}; try{ p=JSON.parse(localStorage.getItem("bugSlayerPlayer")||"{}"); }catch(_){}
      const name=p?.name||"ç„¡åå‹‡è€…", avatarPath=p?.avatar||"", roleName=roleMap[fileKey(avatarPath)]||"æœªçŸ¥å‹‡è€…";
      return { name, roleName, avatarPath };
    }
    function initHeroUI(){
      const { name, roleName, avatarPath } = readHero();
      const elName = document.getElementById("playerName");
      if (elName) elName.textContent = `${roleName}ï¼${name}`;
      let sticker = document.getElementById("heroSticker");
      if (!sticker) {
        sticker = document.createElement("img");
        sticker.id = "heroSticker";
        sticker.className = "hero-sticker";
        sticker.alt = ""; sticker.setAttribute("aria-hidden","true");
        document.body.appendChild(sticker);
      }
      sticker.style.display = avatarPath ? "" : "none";
      if (avatarPath) sticker.src = avatarPath;
    }
    function patchUpdateUI(){
      if (!window.Core || typeof Core.updateUI !== "function") return false;
      if (Core.__patchedHeroName) return true;
      const orig = Core.updateUI.bind(Core);
      Core.updateUI = function(){
        orig();
        const { name, roleName } = readHero();
        const elName = document.getElementById("playerName");
        if (elName) elName.textContent = `${roleName}ï¼${name}`;
      };
      Core.__patchedHeroName = true; return true;
    }
    function ensurePatched(){
      if (patchUpdateUI()) return;
      const t0=Date.now(), timer=setInterval(()=>{ if (patchUpdateUI() || Date.now()-t0>5000) clearInterval(timer); },120);
    }
    document.addEventListener("DOMContentLoaded", initHeroUI);
    document.addEventListener("game-ready", () => { initHeroUI(); ensurePatched(); }, { once:true });
    window.addEventListener("load", ensurePatched, { once:true });
  })();
  </script>

  <!-- ç­‰ TTS å®Œæ•´å¾Œå†ç”Ÿç¬¬ä¸€éš» -->
  <script>
  (function(){
    document.addEventListener('game-ready', async function(){
      try{
        window.__gateOpen = true;
        while (window.Core && Core._speechDepth > 0) { await new Promise(r=>setTimeout(r,120)); }
        window.__gateOpen = false;
        if (window.Core && typeof Core.spawnBug === 'function') Core.spawnBug();
      }catch(_){}
    }, { once:true });
  })();
  </script>

  <!-- æ¨¡å¼åˆ‡æ›ï¼ˆShift+Mï¼‰ -->
  <script>
    Modes.applyModeOnLoad();
    Modes.bindQuickToggle();
  </script>

  <!-- æ‰‹æ©Ÿï¼šæ­¦å™¨æµ®å‹•é¸å–®æ§åˆ¶ -->
  <script>
  (function(){
    const toggle = document.getElementById('weaponToggle');
    const menu   = document.getElementById('weaponMenu');
    if (!toggle || !menu) return;

    let open = false;
    const show = ()=>{ menu.style.display='flex'; toggle.setAttribute('aria-expanded','true'); open=true; };
    const hide = ()=>{ menu.style.display='none';  toggle.setAttribute('aria-expanded','false'); open=false; };
    const toggleMenu = ()=>{ open ? hide() : show(); };

    toggle.addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); });

    // é»å¤–é¢è‡ªå‹•æ”¶èµ·
    document.addEventListener('click', (e)=>{
      if (open && !menu.contains(e.target) && e.target!==toggle){ hide(); }
    });

    // é»å­æŒ‰éˆ• â†’ æ›æ­¦å™¨
    menu.addEventListener('click',(e)=>{
      const btn=e.target.closest('button[data-wpn]');
      if(!btn || btn.disabled) return;
      window.changeWeapon?.(btn.dataset.wpn);
      hide();
    });

    // ç¬¬ä¸€é—œå•Ÿç”¨ 1~3
    ['fire','spray','slipper'].forEach(id=>{
      menu.querySelector(`button[data-wpn="${id}"]`)?.removeAttribute('disabled');
    });
  })();

    (function(){
      const btn = document.getElementById('btnModeToggle');
      const menu = document.getElementById('weaponMenu');
      const toggle = document.getElementById('weaponToggle');

      function closeMenu(){
        if (!menu) return;
        menu.style.display = 'none';
        toggle?.setAttribute('aria-expanded','false');
      }

      btn?.addEventListener('click', ()=>{
        // æ´¾é€èˆ‡æ¡Œæ©Ÿç›¸åŒçš„å¿«æ·éµï¼šShift+M
        const ev = new KeyboardEvent('keydown', {
          key: 'M',
          shiftKey: true,
          bubbles: true,
          cancelable: true
        });
        document.dispatchEvent(ev);

        // é—œæ‰é¸å–®ã€å›åˆ°éŠæˆ²
        closeMenu();

        // å°å»¶é²æŠŠç„¦é»è£œå›å…¨ç•«é¢æ”»æ“Šéˆ•ï¼Œç¶­æŒã€Œé›™æ“Š=æ”»æ“Šã€çš„ä¸€è‡´é«”é©—
        setTimeout(()=> document.getElementById('srAttackFull')?.focus({ preventScroll:true }), 50);
      });
    })();

    (function(){
      const toggle = document.getElementById('weaponToggle');
      if (!toggle) return;

      let pressTimer = null;
      const HOLD_MS = 700;

      function fireToggleMode(){
        const ev = new KeyboardEvent('keydown', { key:'M', shiftKey:true, bubbles:true, cancelable:true });
        document.dispatchEvent(ev);
        setTimeout(()=> document.getElementById('srAttackFull')?.focus({ preventScroll:true }), 50);
      }

      toggle.addEventListener('touchstart', ()=>{ pressTimer = setTimeout(fireToggleMode, HOLD_MS); }, { passive:true });
      toggle.addEventListener('touchend',   ()=>{ clearTimeout(pressTimer); pressTimer=null; }, { passive:true });
      toggle.addEventListener('touchmove',  ()=>{ clearTimeout(pressTimer); pressTimer=null; }, { passive:true });
      // ä¹Ÿæ”¯æ´æ»‘é¼ é•·æŒ‰ï¼ˆæ¡Œæ©Ÿæ¸¬è©¦ç”¨ï¼‰
      toggle.addEventListener('mousedown',  ()=>{ pressTimer = setTimeout(fireToggleMode, HOLD_MS); });
      toggle.addEventListener('mouseup',    ()=>{ clearTimeout(pressTimer); pressTimer=null; });
      toggle.addEventListener('mouseleave', ()=>{ clearTimeout(pressTimer); pressTimer=null; });
    })();
  </script>

  <!-- SR live region å™ªéŸ³é–€ + æ·¡å…¥ -->
  <script>
  (function (w) {
    'use strict';
    const LIVE_SELECTORS=['#srStatus','#message','[role="status"][aria-live]','[aria-live="polite"]','[aria-live="assertive"]'];
    const getLiveNodes=()=>{ const set=new Set(); LIVE_SELECTORS.forEach(sel=>{ document.querySelectorAll(sel).forEach(n=>set.add(n)); }); return Array.from(set); };
    const original=new WeakMap();
    function mute(){ getLiveNodes().forEach(n=>{ if(!original.has(n)) original.set(n, n.getAttribute('aria-live')||''); n.setAttribute('aria-live','off'); }); document.body.setAttribute('aria-busy','true'); }
    function unmute(){ getLiveNodes().forEach(n=>{ const v=original.get(n); if(v===null||v==='') n.removeAttribute('aria-live'); else n.setAttribute('aria-live',v); }); document.body.removeAttribute('aria-busy'); }
    const busy=()=> !!(w.Core && typeof Core._speechDepth==='number' && Core._speechDepth>0) || !!(w.speechSynthesis && speechSynthesis.speaking);
    (function watch(){ let m=false; setInterval(()=>{ const b=busy(); if(b && !m){ mute(); m=true; } else if(!b && m){ unmute(); m=false; } }, 120); })();
    w.addEventListener?.('quiz-open',  mute);
    w.addEventListener?.('quiz-close', unmute);
    w.addEventListener?.('beforeunload', unmute);
    document.addEventListener('DOMContentLoaded', ()=>{ document.body.classList.add('ready'); });
  })(window);
  </script>
  <script type="module">
    import { mountDesktopKeymap } from "./js/core/input-desktop.js";
    const unbind = mountDesktopKeymap(document);
  </script>
</body>
</html>
