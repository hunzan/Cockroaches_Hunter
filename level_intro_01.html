<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>第一關介紹 - 儲藏室</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>
  <style>
    :root{
      --overlay: rgba(0,0,0,.38);
      --glass: rgba(255,255,255,.08);
      --bd: rgba(255,255,255,.18);
      --accent: #ffd166;
      --safe-bottom: env(safe-area-inset-bottom);
    }

    /* 背景與淡入 */
    body {
      margin: 0; color:#fff;
      background: #000 url("assets/images/game_bg1.png") center/cover no-repeat fixed;
      opacity: 0; transition: opacity .45s ease;
      -webkit-tap-highlight-color: transparent;
    }
    body.ready { opacity: 1; }

    /* 版心容器：桌機寬、手機左右內距 */
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: clamp(.8rem, 2.8vw, 1.25rem);
    }

    /* 卡片區塊：玻璃感、內距、圓角 */
    section {
      margin: clamp(.75rem, 2.2vw, 1.2rem) 0;
      padding: clamp(.75rem, 2.5vw, 1.15rem);
      border-radius: 16px;
      background: var(--overlay);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(4px);
      box-shadow: 0 8px 26px rgba(0,0,0,.35);
    }

    h1 { text-align:center; margin:.25rem 0 1rem; }
    h2 { text-align:center; margin:.2rem 0 .6rem; }

    /* 鍵帽樣式（觸控更大顆） */
    .kbd{
      display:inline-block;
      padding:.18rem .48rem;
      border:1px solid #aaa;
      border-radius: 8px;
      background:#fff; color:#111;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: .95rem;
    }
    @media (max-width: 640px){
      .kbd{ padding:.28rem .58rem; border-width:2px; font-size:1rem; }
    }

    /* 蟑螂卡片：RWD 排版 */
    .bug {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items: center;
    }
    @media (min-width: 760px){
      .bug { grid-template-columns: 320px 1fr; gap: 18px; }
    }
    .bug img{
      width: 100%; height: auto; display:block;
      border-radius: 14px;
      background: var(--glass);
      border:1px solid var(--bd);
      padding:.25rem;
    }

    /* 主要行動按鈕（桌機置中；手機固定在底部） */
    .cta-wrap{
      text-align:center;
      margin-top: 1.2rem;
    }
    #startBtn{
      appearance:none; border:0; cursor:pointer;
      font-weight: 900; letter-spacing:.02em;
      font-size: clamp(1.05rem, 2.8vw, 1.2rem);
      padding: .75rem 1.4rem;
      border-radius: 999px;
      background: var(--accent); color:#222;
      transition: transform .08s ease, box-shadow .12s ease;
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      touch-action: manipulation;
    }
    #startBtn:active { transform: translateY(1px); }

    /* 手機：固定底部大按鈕（不擋內容，可滾到最底也看得到） */
    @media (max-width: 760px){
      .cta-fixed {
        position: sticky; bottom: 0; z-index: 50;
        padding: .6rem .8rem calc(.6rem + var(--safe-bottom));
        background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,.55) 45%, rgba(0,0,0,.75) 100%);
        margin: 0 -1rem; /* 撐到滿版心寬 */
      }
      .cta-fixed #startBtn { width: 100%; }
    }

    /* Skip link（聚焦才顯示） */
    .skip-link{
      position: fixed; left: 12px; top: 10px;
      transform: translateY(-150%);
      background: #000; color:#fff;
      padding:.5rem .75rem; border-radius: 10px;
      border:2px solid var(--accent);
      box-shadow:0 4px 18px rgba(0,0,0,.45);
      z-index:10000;
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .skip-link:focus, .skip-link:focus-visible{
      transform: translateY(0);
      outline: none;
      box-shadow:0 6px 24px rgba(0,0,0,.6);
    }

    /* 焦點可見（鍵盤） */
    [tabindex="-1"]:focus, section:focus, #startBtn:focus {
      outline: 3px solid var(--accent); outline-offset: 2px;
    }

    /* 視覺隱藏（給 SR） */
    .sr-only {
      position:absolute!important; width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden; clip:rect(0,0,1px,1px); white-space:nowrap; border:0;
    }
  </style>
</head>
<body class="level-intro">
  <!-- Skip：跳主內容或直接到開始鈕 -->
  <a href="#main" class="skip-link" id="skipToMain" aria-label="跳到主內容，開始聽本關說明">跳到主內容</a>
  <a href="#startBtn" class="skip-link" style="top:56px" id="skipToStart" aria-label="跳到開始按鈕，直接進入遊戲">跳到開始按鈕</a>

  <main class="wrap" id="main" tabindex="-1" aria-label="第一關介紹主內容">
    <h1>第 1 關：儲藏室</h1>

    <section id="a11yBlock" aria-labelledby="a11yTitle" tabindex="-1">
      <h2 id="a11yTitle">螢幕報讀使用者必看</h2>
      <p>
        進入關卡後，請先按 <span class="kbd">NVDA</span> + <span class="kbd">空白</span> 切到<strong>焦點模式</strong>，再用方向鍵操作。
      </p>
      <ul>
        <li>移動：<span class="kbd">←</span> <span class="kbd">→</span>（本關僅左右）</li>
        <li>掃描位置：<span class="kbd">空白鍵</span></li>
        <li>武器：<span class="kbd">1</span> 噴火槍、<span class="kbd">2</span> 香氛噴霧、<span class="kbd">3</span> 藍白拖</li>
        <li>攻擊：<span class="kbd">Enter</span></li>
        <li>若方向鍵沒反應，請再按一次 <span class="kbd">NVDA</span> + <span class="kbd">空白</span></li>
      </ul>
    </section>

    <section>
      <h2>場地形式</h2>
      <p>橫向 7 格走道，使用左右方向鍵平移。</p>
    </section>

    <section>
      <h2>本關將遇到的蟑螂</h2>
      <article class="bug" aria-label="俗辣強">
        <img src="assets/images/cockroaches/k1.png" alt="俗辣強，鬼鬼祟祟正在偷吃麵包。">
        <div>
          <h3 style="margin:.25rem 0 .35rem">俗辣強</h3>
          <p>最低階的小兵蟑螂，四處爬行、容易受驚嚇。<br>弱點：噴火槍、香氛噴霧、藍白拖。</p>
        </div>
      </article>
    </section>

    <section>
      <h2>操作方式</h2>
      <ul>
        <li>移動：<span class="kbd">←</span> <span class="kbd">→</span></li>
        <li>掃描：<span class="kbd">空白鍵</span></li>
        <li>切換武器：<span class="kbd">1</span>、<span class="kbd">2</span>、<span class="kbd">3</span></li>
        <li>攻擊：<span class="kbd">Enter</span></li>
      </ul>
    </section>

    <section id="goalSection" tabindex="-1" aria-labelledby="goalTitle">
      <h2 id="goalTitle">破關目標 🎯</h2>
      <p>俗辣強 10 隻。</p>
    </section>

    <!-- SR 用 live 區＆結尾哨兵 -->
    <div id="srHint" class="sr-only" role="status" aria-live="polite"></div>
    <div id="endSentinel" class="sr-only" tabindex="0" aria-label="已到說明結尾，將前往開始按鈕"></div>

    <!-- 桌機置中按鈕；手機以 sticky 底列呈現 -->
    <div class="cta-wrap cta-fixed">
      <button id="startBtn" aria-describedby="startDesc">進入第一關</button>
      <span id="startDesc" class="sr-only">按下將前往第一關遊戲。</span>
    </div>
  </main>

  <!-- BGM -->
  <audio id="bgm" src="assets/sounds/game_01.mp3" loop preload="auto" autoplay muted playsinline></audio>

  <script>
    /* ==== 音訊：初始化 + 解鎖（行動裝置保險） ==== */
    AudioFX.init();
    const bgm = document.getElementById('bgm');
    AudioFX.register(bgm);

    // 第一次互動：解除靜音並淡入
    (function(){
      let armed = false;
      function fadeIn(audio, vol=0.6, ms=900){
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) { audio.volume = vol; return; }
        audio.volume = 0;
        const steps = 18, delta = vol/steps, step = Math.ceil(ms/steps);
        let i = 0; const t = setInterval(()=>{ i++; audio.volume = Math.min(vol, audio.volume + delta); if(i>=steps) clearInterval(t); }, step);
      }
      function arm(){
        if (armed) return; armed = true;
        try { AudioFX.ensure(); } catch(_){}
        try { bgm.muted = false; } catch(_){}
        bgm.play().then(()=> fadeIn(bgm, .55, 900)).catch(()=>{ /* 靜音失敗就算了 */ });
        document.removeEventListener('pointerdown', arm, true);
        document.removeEventListener('keydown', arm, true);
      }
      document.addEventListener('pointerdown', arm, true);
      document.addEventListener('keydown', arm, true);
    })();
  </script>

  <script>
    /* ==== 路由 ==== */
    function goLevel1(){
      try { sessionStorage.setItem('needFocusModeHint', '1'); } catch(_){}
      location.href = 'game_01.html';
    }

    /* ==== 可及性與導覽 ==== */
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('ready');

      const srHint = document.getElementById('srHint');
      const firstBlock = document.getElementById('a11yBlock');
      const skipMain = document.getElementById('skipToMain');
      const skipStart = document.getElementById('skipToStart');
      const startBtn  = document.getElementById('startBtn');
      const endSentinel = document.getElementById('endSentinel');

      // 初次進頁，把焦點放在第一區塊
      firstBlock?.focus({ preventScroll: true });
      srHint.textContent = '提示：進入關卡後，請按 NVDA 加 空白 切換到焦點模式，再用方向鍵操作。';

      // Skip → 主內容
      function focusFirst(e){ e?.preventDefault(); firstBlock?.focus(); }
      skipMain.addEventListener('click', focusFirst);
      skipMain.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') focusFirst(e); });

      // Skip → 開始按鈕
      function focusStart(e){ e?.preventDefault(); startBtn?.focus(); }
      skipStart.addEventListener('click', focusStart);
      skipStart.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') focusStart(e); });

      // 內容尾端 → 自動把焦點移到開始按鈕
      endSentinel.addEventListener('focus', () => {
        srHint.textContent = '已到說明結尾，前往開始按鈕。';
        setTimeout(()=> startBtn?.focus(), 0);
      });

      // 開始按鈕
      startBtn.addEventListener('click', goLevel1);
      startBtn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); goLevel1(); }
      });

      // 桌機鍵盤快速開始（避免打斷閱讀：只有焦點在按鈕時生效）
      document.addEventListener('keydown', (e)=>{
        if (e.isComposing) return;
        if ((e.key === 'Enter' || e.key === ' ') && document.activeElement === startBtn){
          e.preventDefault(); goLevel1();
        }
      });
    });
  </script>
</body>
</html>
