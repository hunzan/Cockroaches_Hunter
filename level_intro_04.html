<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>第四關介紹 - 客廳</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>
  <style>
    :root{
      --overlay: rgba(0,0,0,.38);
      --glass: rgba(255,255,255,.08);
      --bd: rgba(255,255,255,.18);
      --accent: #ffd166;
      --safe-bottom: env(safe-area-inset-bottom);
    }

    /* 背景與淡入 */
    body{
      margin:0; color:#fff;
      background:#000 url("assets/images/game_bg4.png") center/cover no-repeat fixed;
      opacity:0; transition:opacity .45s ease;
      -webkit-tap-highlight-color: transparent;
    }
    body.ready{ opacity:1; }

    /* 版心與卡片 */
    .wrap{ max-width:980px; margin:0 auto; padding:clamp(.8rem,2.8vw,1.25rem); }
    section{
      margin:clamp(.75rem,2.2vw,1.2rem) 0;
      padding:clamp(.75rem,2.5vw,1.15rem);
      border-radius:16px;
      background:var(--overlay);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(4px);
      box-shadow:0 8px 26px rgba(0,0,0,.35);
    }
    h1{ text-align:center; margin:.25rem 0 1rem; }
    h2{ text-align:center; margin:.2rem 0 .6rem; }

    /* 鍵帽樣式（觸控更大） */
    .kbd{
      display:inline-block; padding:.18rem .48rem;
      border:1px solid #aaa; border-radius:8px;
      background:#fff; color:#111;
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:.95rem;
    }
    @media (max-width:640px){ .kbd{ padding:.28rem .58rem; border-width:2px; font-size:1rem; } }

    /* 蟑螂卡片 RWD */
    .bug{ display:grid; grid-template-columns:1fr; gap:12px; align-items:center; }
    @media (min-width:760px){
      .bug{ grid-template-columns:320px 1fr; gap:18px; }
    }
    .bug img{
      width:100%; height:auto; display:block;
      border-radius:14px; background:var(--glass);
      border:1px solid var(--bd); padding:.25rem;
    }

    /* 主要行動按鈕（桌機置中；手機 sticky） */
    .cta-wrap{ text-align:center; margin-top:1.2rem; }
    #startBtn{
      appearance:none; border:0; cursor:pointer;
      font-weight:900; letter-spacing:.02em;
      font-size:clamp(1.05rem,2.8vw,1.2rem);
      padding:.75rem 1.4rem; border-radius:999px;
      background:var(--accent); color:#222;
      transition:transform .08s ease, box-shadow .12s ease;
      box-shadow:0 8px 20px rgba(0,0,0,.35);
      touch-action: manipulation;
    }
    #startBtn:active{ transform:translateY(1px); }

    @media (max-width:760px){
      .cta-fixed{
        position:sticky; bottom:0; z-index:50;
        padding:.6rem .8rem calc(.6rem + var(--safe-bottom));
        background:linear-gradient(180deg, transparent 0%, rgba(0,0,0,.55) 45%, rgba(0,0,0,.75) 100%);
        margin:0 -1rem;
      }
      .cta-fixed #startBtn{ width:100%; }
    }

  /* 1) 預設：視覺隱藏（仍可被 SR 看見、可聚焦） */
  .skip-link{
    position:absolute !important;
    width:1px; height:1px;
    padding:0; margin:-1px;
    overflow:hidden; clip:rect(0,0,0,0);
    white-space:nowrap; border:0;
  }

  /* 2) 取得焦點：才顯示並定位在左上角 */
  .skip-link:focus,
  .skip-link:focus-visible{
    position:fixed !important;
    left:12px;
    top:12px;         /* 第二顆你已內聯 top:56px 會覆蓋這裡，OK */
    z-index:10000;
    clip:auto; width:auto; height:auto; overflow:visible;
    padding:.5rem .75rem; margin:0; white-space:normal; border:2px solid var(--accent);
    border-radius:10px;
    background:#000; color:#fff;
    box-shadow:0 6px 24px rgba(0,0,0,.6);
  }
    @media (hover:none) {
    .skip-link{ /* 保持 SR 可聚焦即可，視覺仍隱藏 */ }
    }

    /* 焦點可見（鍵盤） */
    [tabindex="-1"]:focus, section:focus, #startBtn:focus {
      outline: 3px solid var(--accent); outline-offset: 2px;
    }

    /* 視覺隱藏（給 SR） */
    .sr-only {
      position:absolute!important; width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden; clip:rect(0,0,1px,1px); white-space:nowrap; border:0;
    }
  </style>
</head>
<body class="level-intro">
  <!-- 隱藏的跳轉連結（聚焦才顯示） -->
  <a href="#main" class="skip-link" id="skipToMain" aria-label="跳到主內容，開始聽本關說明">跳到主內容</a>
  <a href="#startBtn" class="skip-link" style="top:56px" id="skipToStart" aria-label="跳到開始按鈕，直接進入遊戲">跳到開始按鈕</a>

  <main class="wrap" id="main" tabindex="-1" aria-label="第四關介紹主內容">
    <h1>第 4 關：客廳</h1>

    <!-- A11Y 區塊 -->
    <section id="a11yBlock" aria-labelledby="a11yTitle" tabindex="-1">
      <h2 id="a11yTitle">螢幕報讀使用者必看</h2>
      <p>
        進入關卡後，請先按 <span class="kbd">NVDA</span> + <span class="kbd">空白</span> 切到<strong>焦點模式</strong>，再用方向鍵操作。
      </p>
      <ul>
        <li>方向鍵：<span class="kbd">↑</span> <span class="kbd">↓</span> <span class="kbd">←</span> <span class="kbd">→</span></li>
        <li>定位輔助：<span class="kbd">空白鍵</span> 掃描蟑螂位置</li>
        <li>武器：<span class="kbd">1</span> 噴火槍、<span class="kbd">2</span> 香氛噴霧、<span class="kbd">3</span> 藍白拖、<span class="kbd">4</span> 毒餌</li>
        <li>攻擊：<span class="kbd">Enter</span></li>
        <li>若方向鍵沒反應，請再按一次 <span class="kbd">NVDA</span> + <span class="kbd">空白</span></li>
      </ul>
    </section>

    <!-- 場地形式 -->
    <section>
      <h2>場地形式</h2>
      <p>7 × 7 正方形格子地圖，可上下左右移動，但要避開傢具位置。</p>
    </section>

    <!-- 家具配置與碰撞規則 -->
    <section>
      <h2>家具位置說明 ⚠️ 不可碰撞</h2>
      <ul>
        <li>中央沙發茶几區：<strong>3 × 2</strong>，位於<strong>第 3–4 行 × 第 3–5 列</strong>（客廳中央）。</li>
        <li>下方電視區：<strong>3 × 1</strong>，位於<strong>第 7 行 × 第 3–5 列</strong>（最下方中間靠牆）。</li>
      </ul>
      <p><strong>💥碰撞規則：</strong>家具皆為障礙物，<u>不可穿越</u>。第一次撞到會語音提醒；<u>同一區域第二次硬撞</u>會受傷，<strong>扣 1 血、扣 1 金幣</strong>。</p>
    </section>

    <!-- 新蟑螂品種 -->
    <section>
      <h2>本關將會遇到的新蟑螂 🪳</h2>
      <article class="bug" aria-label="軍師蟑到爆">
        <img src="assets/images/cockroaches/k4.png" alt="軍師蟑到爆，手持室內平面圖指指點點，指揮小兵前進。">
        <div>
          <h3 style="margin:.25rem 0 .35rem">軍師蟑到爆</h3>
          <p>戰術謀略型蟑螂，領地感與號召力超強，叫聲是「輸贏」。</p>
          <p>弱點：毒餌；或被出題考倒人類想法反被破解（解題成功即可收服）。</p>
        </div>
      </article>
    </section>

    <!-- 破關目標 -->
    <section id="goalSection" tabindex="-1" aria-labelledby="goalTitle">
      <h2 id="goalTitle">破關目標 🎯</h2>
      <p>俗辣強 10 隻、飛天強尼 10 隻、主管強強棍 5 隻、軍師蟑到爆 2 隻。</p>
    </section>

    <!-- SR 提示與哨兵 -->
    <div id="srHint" class="sr-only" role="status" aria-live="polite"></div>
    <div id="endSentinel" class="sr-only" tabindex="0" aria-label="已到說明結尾，將前往開始按鈕"></div>

    <!-- CTA -->
    <div class="cta-wrap cta-fixed">
      <button id="startBtn" aria-describedby="startDesc">進入第四關</button>
      <span id="startDesc" class="sr-only">按下將前往第四關遊戲。</span>
    </div>
  </main>

  <!-- BGM -->
  <audio id="bgm" src="assets/sounds/game_04.mp3" loop preload="auto" autoplay muted playsinline></audio>

  <script>
    /* ==== 音訊初始化與解鎖（行動裝置） ==== */
    AudioFX.init();
    const bgm = document.getElementById('bgm');
    AudioFX.register(bgm);

    (function(){
      let armed = false;
      function fadeIn(audio, vol=0.6, ms=900){
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) { audio.volume = vol; return; }
        audio.volume = 0;
        const steps = 18, delta = vol/steps, step = Math.ceil(ms/steps);
        let i = 0; const t = setInterval(()=>{ i++; audio.volume = Math.min(vol, audio.volume + delta); if(i>=steps) clearInterval(t); }, step);
      }
      function arm(){
        if (armed) return; armed = true;
        try { AudioFX.ensure(); } catch(_){}
        try { bgm.muted = false; } catch(_){}
        bgm.play().then(()=> fadeIn(bgm, .55, 900)).catch(()=>{ /* 自動播放被擋就保持靜音 */ });
        document.removeEventListener('pointerdown', arm, true);
        document.removeEventListener('keydown', arm, true);
      }
      document.addEventListener('pointerdown', arm, true);
      document.addEventListener('keydown', arm, true);
    })();
  </script>

  <script>
    /* ==== 導頁 ==== */
    function goLevel4(){
      try { sessionStorage.setItem('needFocusModeHint', '4'); } catch(_){}
      location.href = 'game_04.html';
    }

    /* ==== 可及性與導覽 ==== */
    document.addEventListener('DOMContentLoaded', ()=>{
      document.body.classList.add('ready');

      const srHint = document.getElementById('srHint');
      const firstBlock = document.getElementById('a11yBlock');
      const skipMain = document.getElementById('skipToMain');
      const skipStart = document.getElementById('skipToStart');
      const startBtn  = document.getElementById('startBtn');
      const endSentinel = document.getElementById('endSentinel');

      // 初次進頁：聚焦第一區塊
      firstBlock?.focus({ preventScroll:true });
      srHint.textContent = '提示：進入關卡後，請按 NVDA 加 空白 切換到焦點模式，再用方向鍵操作。';

      // Skip → 主內容
      function focusFirst(e){ e?.preventDefault(); firstBlock?.focus(); }
      skipMain.addEventListener('click', focusFirst);
      skipMain.addEventListener('keydown', e=>{ if (e.key==='Enter'||e.key===' ') focusFirst(e); });

      // Skip → 開始按鈕
      function focusStart(e){ e?.preventDefault(); startBtn?.focus(); }
      skipStart.addEventListener('click', focusStart);
      skipStart.addEventListener('keydown', e=>{ if (e.key==='Enter'||e.key===' ') focusStart(e); });

      // 內容尾端 → 自動把焦點送到開始按鈕
      endSentinel.addEventListener('focus', ()=>{
        srHint.textContent = '已到說明結尾，前往開始按鈕。';
        setTimeout(()=> startBtn?.focus(), 0);
      });

      // 只在按鈕聚焦時，Enter/Space 才會啟動
      startBtn.addEventListener('click', goLevel4);
      startBtn.addEventListener('keydown', (e)=>{
        if (e.key==='Enter' || e.key===' '){ e.preventDefault(); goLevel4(); }
      });
    });
  </script>
</body>
</html>
