<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>開場動畫 - 進擊的蟑螂</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="style.css" />
  <script>
(function () {
  // 讀上一頁留下的旗子，10 秒內算有效
  const ARMED_MS = 10_000;
  const armedAt = Number(sessionStorage.getItem('audioArmedAt') || 0);
  const recentlyArmed = armedAt && (Date.now() - armedAt) < ARMED_MS;

  // 早一步初始化你們的音訊工具（若可用）
  try { window.AudioFX?.init?.(); } catch (_){}

  // 等到 DOM 有 <audio id="introAudio"> 就馬上播
  function tryPlayIntro() {
    const a = document.getElementById('introAudio');
    if (!a) return false;

    // 建議：標上 playsinline/autoplay/preload，在 HTML 也寫上
    a.setAttribute('playsinline', '');
    a.setAttribute('preload', 'auto');

    // 若上一頁剛解鎖過，就先強制 ensure 一次再播
    if (recentlyArmed) {
      try { window.AudioFX?.ensure?.(); } catch (_){}
      // 先把 BGM 壓低（若你有 BGM）
      const bgm = document.getElementById('bgm');
      if (bgm) { try { bgm.volume = 0.2; } catch(_){} }
    }

    // 立刻嘗試播放；失敗就改在第一次手勢時再播
    a.play().catch(() => {
      const once = () => {
        document.removeEventListener('pointerdown', once, true);
        document.removeEventListener('keydown', once, true);
        try { window.AudioFX?.ensure?.(); } catch (_){}
        a.play().catch(()=>{ /* 仍失敗就作罷 */ });
      };
      document.addEventListener('pointerdown', once, true);
      document.addEventListener('keydown', once, true);
    });

    // 播完再把 BGM 拉回來（若有）
    a.addEventListener('ended', () => {
      const bgm = document.getElementById('bgm');
      if (bgm) { try { bgm.volume = 1.0; } catch(_){} }
    }, { once: true });

    // 用過就清旗，避免回上一頁再進來誤觸
    sessionStorage.removeItem('audioArmedAt');
    return true;
  }

  // DOM 一出來就嘗試；同時備用 requestAnimationFrame 保證更早觸發
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', tryPlayIntro, { once: true });
  } else {
    tryPlayIntro();
  }
  requestAnimationFrame(tryPlayIntro);
})();
</script>

  <script>window.ASSETS_ROOT = window.ASSETS_ROOT || "/";</script>
  <script src="js/core/audio-unlocker.js"></script>
  <style>
    :root{
      --overlay: rgba(0,0,0,.35);
      --accent: #ffd166;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    /* 背景：桌機固定、手機可滾動 */
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
      color:#fff;
      background: #000 url("assets/images/start_bg.png") no-repeat center center fixed;
      background-size: cover;
      -webkit-tap-highlight-color: transparent;
    }
    main{
      max-width: 980px;
      margin: 4vh auto;
      padding: 1.25rem;
      background: var(--overlay);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 16px;
      backdrop-filter: blur(6px);
      text-shadow: 0 1px 2px #000;
    }

    /* 版面：桌機左右、手機直向堆疊 */
    .hero {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 1rem;
      align-items: center;
    }
    @media (max-width: 720px){
      .hero { grid-template-columns: 1fr; text-align: center; }
    }

    h1{ margin: 0 0 .75rem; text-align: center; }
    #playerName{ font-size: clamp(1.1rem, 2.3vw, 1.4rem); font-weight: 800; margin: .25rem 0 .75rem; }

    .role-wrap{
      display:grid; place-items:center;
    }
    img.role {
      border-radius: 14px;
      width: min(240px, 55vw);
      height: auto;
      background: rgba(255,255,255,.12);
      border: 2px solid rgba(255,255,255,.25);
      box-shadow: 0 6px 20px rgba(0,0,0,.45);
    }

    #introText{
      margin: .5rem 0 0;
      line-height: 1.85;
      font-weight: 600;
      opacity: 0;
      animation: fadeIn 800ms ease both;
      font-size: clamp(1rem, 2.2vw, 1.1rem);
      text-align: left;
    }
    @media (max-width: 720px){ #introText{ text-align: center; } }

    /* 進場淡入（尊重偏好減少動畫） */
    @keyframes fadeIn { from { opacity:0; transform: translateY(12px) } to { opacity:1; transform:none } }
    @media (prefers-reduced-motion: reduce){
      #introText{ animation: none; opacity: 1; }
    }

    /* 底部行動列（大拇指友善） */
    .actions {
      display: flex; flex-wrap: wrap; gap: .75rem;
      justify-content: center;
      margin: 1.25rem 0 0;
      padding-bottom: calc(12px + var(--safe-bottom));
    }
    .btn {
      appearance: none; border: 0; border-radius: 999px;
      padding: .7rem 1.4rem; font-size: 1.05rem; font-weight: 800;
      background: var(--accent); color: #222; cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,.35);
      transition: transform .08s ease, filter .15s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn.alt {
      background: rgba(255,255,255,.12);
      color:#fff; border: 1px solid rgba(255,255,255,.3);
      font-weight: 700;
    }
    .btn:focus-visible{ outline: 3px solid #fff; outline-offset: 2px; }

    /* Skip link（鍵盤） */
    .skip-link{
      position: fixed; left: 12px; top: 10px; transform: translateY(-160%);
      background:#000; color:#fff; padding:.5rem .75rem; border-radius:10px;
      border:2px solid var(--accent); box-shadow:0 4px 18px rgba(0,0,0,.45); z-index:9999;
      transition: transform .15s ease;
    }
    .skip-link:focus, .skip-link:focus-visible{ transform: translateY(0); }

    /* 只給 SR 用的隱藏 class */
    .sr-only {
      position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">跳到主內容</a>

  <main id="main" tabindex="-1" aria-label="開場動畫主內容">
    <h1>勇者蟑螂獵人</h1>

    <section class="hero" aria-labelledby="playerHeading">
      <div class="role-wrap">
        <img id="playerAvatar" class="role" src="" alt="玩家角色圖像">
      </div>
      <div>
        <p id="playerHeading" class="sr-only">玩家資訊</p>
        <p id="playerName" aria-live="polite"></p>

        <p id="introText">
          那一天……人類想起了被蟑螂支配的恐懼。<br>
          傳說中的救世主──勇者蟑螂獵人於是誕生！
        </p>
      </div>
    </section>

    <div class="actions" role="group" aria-label="頁面操作">
      <button id="nextBtn" class="btn" aria-describedby="nextHint">前往說明頁</button>
      <span id="nextHint" class="sr-only">鍵盤按 Enter 也可前往說明頁。</span>
    </div>

    <!-- 旁白 & BGM -->
    <audio id="introAudio"
       src="assets/sounds/game_intro.mp3"
       autoplay
       playsinline
       preload="auto"></audio>

    <audio id="bgm" src="" loop preload="auto"></audio>

    <!-- SR 狀態 -->
    <div id="srLive" class="sr-only" aria-live="polite" aria-atomic="true"></div>
  </main>

  <!-- 在 BGM 之後初始化/登記 -->
  <script>
    // 1) 初始化（可多次呼叫沒關係）
    AudioFX.init();

    // 2) 依 ASSETS_ROOT 設定音檔路徑並登記
    const root = String(window.ASSETS_ROOT || "");
    const bgm = document.getElementById('bgm');
    const introAudio = document.getElementById('introAudio');
    bgm.src = root + "assets/sounds/start_theme.mp3";
    introAudio.src = root + "assets/sounds/game_intro.mp3";

    AudioFX.register(bgm);
    AudioFX.register(introAudio); // 想用 AudioFX 統一控管時可登記

    // （可選）遊戲就緒事件時再保險叫醒
    window.addEventListener('game-ready', () => { try { AudioFX.ensure(); } catch(_) {} });
  </script>

  <script>
    /* ========= 資料讀取與顯示 ========= */
    const player = (() => {
      const p = JSON.parse(localStorage.getItem("bugSlayerPlayer") || "{}");
      p.name ??= "無名勇者";
      p.avatar ??= root + "assets/images/hunters/kinbah.png";
      p.hp ??= 10;
      p.coins ??= 10;
      p.weaponUsage ??= { fire: 10, spray: 10, slipper: 10 };
      try { localStorage.setItem("bugSlayerPlayer", JSON.stringify(p)); } catch(_){}
      return p;
    })();

    const roleNameMap = {
      "kinbah": "金巴",
      "mailah": "麥拉",
      "khaupe": "考盃",
      "holah": "赫拉",
      "chinaikhun": "金．艾捆",
      "chiaulaipeh": "郊．萊北",
      "mienphapan": "綿葩．坂",
      "hamchuniok": "罕族．拗"
    };
    function pickRoleName(avatarPath){
      try{
        const file = (avatarPath || "").split("/").pop();        // e.g. kinbah.png
        const base = (file || "").replace(/\.\w+$/,"");          // kinbah
        return roleNameMap[base] || "勇者";
      }catch(_){ return "勇者"; }
    }

    const roleDisplay = pickRoleName(player.avatar);
    const heroTitle = `${roleDisplay}．${player.name}`;

    const nameEl = document.getElementById("playerName");
    nameEl.textContent = `勇者 ${heroTitle} 登場！`;

    const avatar = document.getElementById("playerAvatar");
    avatar.src = player.avatar;
    avatar.alt = `角色 ${roleDisplay} 的圖像`;

    /* ========= 互動／導頁 ========= */
    const nextBtn = document.getElementById("nextBtn");
    const skipBtn = document.getElementById("skipBtn");
    nextBtn.addEventListener("click", () => { location.href = "tutorial.html"; });

    // Enter 也能前往（避免輸入框干擾：本頁無輸入框）
    document.addEventListener("keydown", (e) => {
      if (e.isComposing) return;
      if (e.key === "Enter") {
        e.preventDefault();
        nextBtn.click();
      }
    });

    /* ========= 語音提示（可關閉／不擾人） ========= */
    function speak(text){
      try{
        if (!("speechSynthesis" in window) || !text) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "zh-TW"; u.rate = 1.35; u.pitch = 1.0; u.volume = 1.0;
        speechSynthesis.cancel(); speechSynthesis.speak(u);
      }catch(_){}
    }
    // 首次進頁提示（避免重覆干擾）
    let spokenOnce = false;
    function srHintOnce(){
      if (spokenOnce) return;
      spokenOnce = true;
      speak(`勇者 ${heroTitle}。按 Enter 或點按按鈕前往說明頁。`);
    }
    // 第一次點、按鍵或觸控時說一次
    document.addEventListener("click", srHintOnce, { once:true });
    document.addEventListener("keydown", (e)=>{ if(!e.metaKey && !e.ctrlKey) srHintOnce(); }, { once:true });
    document.addEventListener("touchstart", srHintOnce, { once:true, passive:true });

    /* ========= 音訊解鎖 + BGM 淡入 ========= */
    (function () {
      if (!bgm) return;
      let armed = false;
      function fadeInAudio(audio, target = 0.6, durMs = 900) {
        if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
          audio.volume = target; return;
        }
        audio.volume = 0;
        const steps = 18, delta = target / steps, stepMs = Math.ceil(durMs / steps);
        let i = 0;
        const t = setInterval(() => {
          i++;
          audio.volume = Math.min(target, audio.volume + delta);
          if (i >= steps) clearInterval(t);
        }, stepMs);
      }
      function armAndPlay() {
        if (armed) return;
        armed = true;
        try { AudioFX.ensure?.(); } catch(_){}
        // 先播旁白，再開 BGM（避免打架）
        introAudio.play().catch(()=>{ /* 若被阻擋就算了 */ });
        // BGM 稍晚一點淡入
        setTimeout(() => {
          bgm.play().then(() => fadeInAudio(bgm, 0.55, 900)).catch(()=>{});
        }, 400);
      }
      document.addEventListener("keydown", armAndPlay,  { once: true });
      document.addEventListener("click",   armAndPlay,  { once: true });
      document.addEventListener("touchstart", armAndPlay, { once: true, passive: true });
      window.addEventListener("beforeunload", () => { try { bgm.pause(); } catch(e) {} });
    })();

    /* ========= 旁白播完可自動前往（若需要就打開） ========= */
    // introAudio.addEventListener("ended", () => { location.href = "tutorial.html"; });

    /* ========= 無障礙：跳到主內容時，把焦點放在標題 ========= */
    document.querySelector('.skip-link')?.addEventListener('click', (e)=>{
      e.preventDefault();
      document.getElementById('main')?.focus({ preventScroll: true });
      // 讓 SR 知道焦點移動
      const live = document.getElementById('srLive');
      if (live){ live.textContent = ''; setTimeout(()=> live.textContent = '已跳到主內容。', 0); }
    });
  </script>
</body>
</html>
