<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>第 1 關：戰鬥開始！ - 進擊的蟑螂</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />

  <link rel="stylesheet" href="style.css" />
  <script src="js/core/modes.js"></script>
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>

  <style>
    html, body { min-height: 100svh; }
    body {
      margin: 0;
      padding: 0;
      background: url("assets/images/game_bg1.png") no-repeat center center fixed;
      background-size: cover;
      font-family: sans-serif;
      color: #111;
    }

    /* 桌機/一般：正常排版；行動版會把狀態做成頂部膠囊、縮小標題 */
    main { padding: .75rem 1rem 1rem; }
    h1 {
      text-align:center; color:#fff;
      text-shadow:0 2px 8px rgba(0,0,0,.45);
      margin:.75rem 0;
    }

    /* === 遊戲舞台（第一關單列 7 格；窄螢幕可自動換行） === */
    #gameArea{
      display: flex;
      justify-content: center;
      margin: .75rem auto 0;
      gap: 0.45rem;
      outline: none;
      touch-action: none;               /* 手勢自處理，避免側滑返回 */
      -webkit-tap-highlight-color: transparent;
      max-width: min(94vw, 760px);
      flex-wrap: wrap;
    }
    .tile {
      width: clamp(38px, 8vw, 52px);
      height: clamp(38px, 8vw, 52px);
      border: 2px solid #333;
      font-size: 1.02rem;
      text-align: center;
      line-height: clamp(38px, 8vw, 52px);
      background:rgba(238,238,238,0.6);  /* ← 半透明灰色 */
      border-radius: 8px;
      user-select: none;
    }
    .tile.player { background-color: #cce5ff; }
    .tile.bug    { background-color: #f8d7da; }

    #message {
      margin-top: .6rem; font-weight: bold; text-align: center;
      color:#fff; text-shadow:0 2px 8px rgba(0,0,0,.45);
      min-height: 1.2em;
    }

    /* 視障友善隱形樣式 */
    .sr-only {
      position:absolute !important;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }

    /* Skip link */
    .skip-link {
      position: fixed; left: 12px; top: -9999px;
      background: #ffd452; color: #111; padding: .5rem .75rem; border-radius: 8px;
      text-decoration: none; box-shadow: 0 2px 6px rgba(0,0,0,.3); z-index: 1000;
    }
    .skip-link:focus, .skip-link:focus-visible { top: 12px; outline: 2px solid #222; }

    /* 右下勇者貼紙：不攔截點擊，固定於右下 */
    .hero-sticker{
      position: fixed;
      right: 12px;
      bottom: calc(12px + env(safe-area-inset-bottom));
      width: min(21vw, 160px);
      max-width: 200px;
      height: auto;
      opacity: .95;
      pointer-events: none;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,.45));
      z-index: 10;
    }
    @media (max-width: 480px){
      .hero-sticker{ width: 26vw; opacity: .9; }
    }

    /* 狀態列（桌機用） */
    #playerStatus {
      margin: .5rem auto 0;
      padding: .5rem .75rem;
      max-width: 960px;
      background: rgba(255,255,255,.15);
      border-radius: 10px;
      color:#fff;
      text-shadow:0 2px 8px rgba(0,0,0,.45);
    }

    /* ===== 行動版極簡：縮小標題 + 狀態浮動膠囊 ===== */
    @media (pointer: coarse) {
      h1{
        font-size: 1.05rem;
        font-weight: 600;
        margin: .25rem 0 .1rem;
      }
      #playerStatus{
        position: fixed;
        top: calc(8px + env(safe-area-inset-top));
        left: 8px; right: 8px; z-index: 18;
        display:flex; flex-wrap:wrap; gap:.25rem .6rem; align-items:center;
        padding:.35rem .6rem;
        background: rgba(0,0,0,.35);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        border-radius: 12px;
        font-size: .9rem; line-height: 1.2; color:#fff;
        text-shadow: 0 1px 3px rgba(0,0,0,.35);
      }
      main{ padding-top: calc(2.6rem + env(safe-area-inset-top)); }
      .tile{
        width: clamp(36px, 7.4vw, 50px);
        height: clamp(36px, 7.4vw, 50px);
        line-height: clamp(36px, 7.4vw, 50px);
        font-size: .98rem;
        border-radius: 7px;
      }
    }

    /* === 手機專用：左下「武器選單」浮動鈕 + 直列子選單 === */
    #weaponToggle{
      position: fixed;
      left: 12px;
      bottom: calc(12px + env(safe-area-inset-bottom));
      z-index: 25;
      background: #ffd452;
      color: #222;
      border: none;
      border-radius: 50%;
      width: 52px; height: 52px;
      font-size: 1.25rem;
      box-shadow: 0 3px 10px rgba(0,0,0,.3);
      display: none;          /* 預設桌機隱藏 */
    }
    #weaponMenu{
      position: fixed;
      left: 12px;
      bottom: calc(72px + env(safe-area-inset-bottom));
      display: none;
      flex-direction: column;
      gap: .35rem;
      z-index: 26;
    }
    #weaponMenu button{
      background: #ffd452;
      color: #222;
      border: none; border-radius: 10px;
      font-size: .9rem;
      padding: .42rem .55rem;
      min-width: 68px;
      box-shadow: 0 3px 8px rgba(0,0,0,.25);
    }
    #weaponMenu button:disabled{ opacity:.55; filter:saturate(.7); }
    #weaponToggle{ display: inline-flex; align-items:center; justify-content:center; }
  </style>
</head>
<body class="stage1">

  <a href="#weaponToggle" class="skip-link">跳到武器選單</a>

  <main>
    <h1>儲藏室有怪聲音...</h1>

    <section id="playerStatus" aria-label="玩家狀態">
      <div>勇者：<span id="playerName">---</span></div>
      <div>血量：<span id="playerHP">---</span></div>
      <div>金幣：<span id="playerCoins">---</span></div>
      <div><span id="weaponStatus">---</span></div>
      <div id="srStatus" aria-live="polite" aria-atomic="true" role="status" class="sr-only"></div>
    </section>
    <br><br>

    <p id="a11yHelp" class="sr-only">
      使用方向鍵左右移動，空白鍵掃描，Enter 攻擊；行動裝置可左右滑動移動、單擊掃描、雙擊攻擊。數字 1–7 切換武器。
    </p>

    <div id="gameArea" role="group" aria-describedby="a11yHelp" aria-label="遊戲場地，共橫向七格" tabindex="0"></div>

    <div id="message" aria-live="assertive"></div>

    <audio id="voicePlayer" src="" hidden></audio>
  </main>

  <!-- 手機：武器浮動按鈕 + 子選單 -->
  <button id="weaponToggle" aria-label="武器選單" aria-haspopup="menu" aria-expanded="false">⚔️</button>
  <div id="weaponMenu" role="menu" aria-label="武器選單">
    <button role="menuitem" data-wpn="fire"    aria-keyshortcuts="1">1️⃣ 噴火槍</button>
    <button role="menuitem" data-wpn="spray"   aria-keyshortcuts="2">2️⃣ 噴霧</button>
    <button role="menuitem" data-wpn="slipper" aria-keyshortcuts="3">3️⃣ 藍白拖</button>
    <button role="menuitem" data-wpn="bait"    aria-keyshortcuts="4" disabled>4️⃣ 毒餌</button>
    <button role="menuitem" data-wpn="cat"     aria-keyshortcuts="5" disabled>5️⃣ 養貓</button>
    <button role="menuitem" data-wpn="vote"    aria-keyshortcuts="6" disabled>6️⃣ 連署</button>
    <button role="menuitem" data-wpn="recall"  aria-keyshortcuts="7" disabled>7️⃣ 罷免</button>
  </div>

  <!-- BGM -->
  <audio id="bgm" src="assets/sounds/game_01.mp3" loop preload="auto"></audio>

  <script>
    /* BGM 解鎖與登記 */
    AudioFX.init();
    const bgm = document.getElementById('bgm');
    AudioFX.register(bgm);
    window.addEventListener('game-ready', () => { try { AudioFX.ensure(); } catch(_) {} });
  </script>

  <!-- 內容與核心 -->
  <script src="js/content/bugs.js"></script>
  <script src="js/content/levels.js"></script>

  <script src="js/core/game-core.js"></script>
  <script src="js/core/mode-lane.js"></script>
  <script src="js/render/furniture.js"></script>
  <script src="js/core/mode-grid.js"></script>

  <script src="js/a11y/focus-hints.js"></script>
  <script src="js/a11y/announce-arbiter.js"></script>
  <script src="js/a11y/spawn-conductor.js"></script>

  <script src="js/boot/game_l1.js"></script>
  <script src="js/core/keys.js"></script>
  <script src="js/core/retry.js"></script>
  <script> Retry.rememberLevel(); </script>

    <!-- SR 專用控制疊層（VoiceOver/TalkBack） -->
  <div id="srControlOverlay" aria-hidden="false" aria-label="觸控控制面板">
    <div id="srDpad" class="pad" role="group" aria-label="方向操作">
      <span class="empty" aria-hidden="true"></span>
      <button type="button" data-key="ArrowUp"    aria-label="向上">↑</button>
      <span class="empty" aria-hidden="true"></span>

      <button type="button" data-key="ArrowLeft"  aria-label="向左">←</button>
      <span class="empty" aria-hidden="true"></span>
      <button type="button" data-key="ArrowRight" aria-label="向右">→</button>

      <span class="empty" aria-hidden="true"></span>
      <button type="button" data-key="ArrowDown"  aria-label="向下">↓</button>
      <span class="empty" aria-hidden="true"></span>
    </div>

    <div id="srEnter" class="pad" role="group" aria-label="確認動作">
      <button type="button" data-key="Enter" aria-label="確認">ENTER</button>
    </div>
  </div>

  <button id="srToggle" type="button" aria-pressed="false" aria-label="切換觸控控制面板">控制：自動</button>

  <!-- 鍵盤初始化（boot 完成/或 game-ready 後） -->
  <script>
    document.addEventListener('game-ready', () => {
      const stage = document.getElementById('gameArea');
      Keys.init({
        stageEl: stage,
        scanFn: () => window.scanArea?.(),
        activeGuardFn: () => window.gameActive !== false
      });
    }, { once:true });
  </script>

<script>
(function(){
  // 直接呼叫你的動作 API，避免鍵盤事件路徑不一致
  function act(key){
    switch(key){
      case 'ArrowLeft':  return window.moveLeft?.();
      case 'ArrowRight': return window.moveRight?.();
      case 'ArrowUp':    return window.moveUp?.();
      case 'ArrowDown':  return window.moveDown?.();
      case 'Enter':      return window.attack?.();
      case 'Scan':       return window.scanArea?.();
    }
  }

  // ===== 全螢幕手勢參數 =====
  const G = {
    active:false, startX:0, startY:0,
    lastTapTime:0, lastTapX:0, lastTapY:0,
    singleTapTimer:null,
    threshold:24, edge:10, dblTime:280, dblDist:24
  };

  function isInSafeArea(x, y){
    const w = innerWidth, h = innerHeight, e = G.edge;
    return (x>e && x<w-e && y>e && y<h-e);
  }
  function isInteractiveTarget(el){
    return !!el.closest?.(
      '#catDialog:not([hidden]), #weaponMenu,'+
      'button, a, input, select, textarea,'+
      '[role="button"], [role="dialog"], [aria-haspopup]'
    );
  }

  function onTouchStart(e){
    const t = e.changedTouches?.[0]; if(!t) return;
    if (e.touches?.length > 1) return;                // 多指忽略
    if (!isInSafeArea(t.clientX, t.clientY)) return;  // 邊緣保護
    if (isInteractiveTarget(e.target)) return;        // 讓 UI 自己處理
    if (window.gameActive === false) return;

    G.active = true;
    G.startX = t.clientX;
    G.startY = t.clientY;
  }

  function onTouchEnd(e){
    const t = e.changedTouches?.[0]; if(!t) return;

    const dx = t.clientX - G.startX;
    const dy = t.clientY - G.startY;
    const ax = Math.abs(dx), ay = Math.abs(dy);

    // 若是滑動（超過閾值）→ 直接移動
    if (G.active && (ax >= G.threshold || ay >= G.threshold)){
      G.active = false;
      if (ax > ay) act(dx>0 ? 'ArrowRight' : 'ArrowLeft');
      else         act(dy>0 ? 'ArrowDown'  : 'ArrowUp');
      // 滑動就不做點擊判斷
      clearSingleTap();
      return;
    }

    // 否則當作「點擊序列」→ 雙擊=攻擊，否則延遲觸發掃描
    handleTap(t);
    G.active = false;
  }

  function handleTap(t){
    const now = performance.now();
    const dt  = now - G.lastTapTime;
    const dd  = Math.max(Math.abs(t.clientX - G.lastTapX), Math.abs(t.clientY - G.lastTapY));

    // 記錄這次點擊
    G.lastTapTime = now;
    G.lastTapX = t.clientX;
    G.lastTapY = t.clientY;

    // 若在雙擊門檻內 → 立刻攻擊，並取消單擊掃描
    if (dt <= G.dblTime && dd <= G.dblDist){
      clearSingleTap();
      act('Enter');        // 雙擊 = 攻擊
      G.lastTapTime = 0;   // 重置，避免三連擊誤判
      return;
    }

    // 否則安排單擊 → 掃描（等雙擊時間過了再執行）
    clearSingleTap();
    G.singleTapTimer = setTimeout(()=>{
      act('Scan');         // 單擊 = 掃描
      G.singleTapTimer = null;
    }, G.dblTime + 10);
  }

  function clearSingleTap(){
    if (G.singleTapTimer){ clearTimeout(G.singleTapTimer); G.singleTapTimer = null; }
  }

  // ✅ 更穩的觸控判斷 + 綁在 document（全頁有效）
  const supportsTouch =
    ('ontouchstart' in window) ||
    (navigator.maxTouchPoints && navigator.maxTouchPoints > 0) ||
    matchMedia('(pointer:coarse)').matches;

  if (supportsTouch) {
    document.addEventListener('touchstart', onTouchStart, { passive:true });
    document.addEventListener('touchend',   onTouchEnd,   { passive:true });
  }

    // ===== 2) 螢幕閱讀器情境：顯示 SR 控制疊層（可聚焦按鈕） =====
    // 無法直接偵測「SR 是否開啟」，所以提供：
    //  (a) 启发式：若按鈕被聚焦/雙擊有效，我們保持疊層顯示
    //  (b) 手動切換：srToggle
    const overlay = document.getElementById('srControlOverlay');
    const dpad = document.getElementById('srDpad');
    const enterPad = document.getElementById('srEnter');
    const toggleBtn = document.getElementById('srToggle');

    function showOverlay(){ document.body.classList.add('show-sr-overlay'); toggleBtn.setAttribute('aria-pressed','true'); toggleBtn.textContent = '控制：開啟'; }
    function hideOverlay(){ document.body.classList.remove('show-sr-overlay'); toggleBtn.setAttribute('aria-pressed','false'); toggleBtn.textContent = '控制：自動'; }

    // 預設策略：
    //  - 若偵測到螢幕閱讀器可能攔截滑動（玩家抱怨移不動），可以按右上角「控制：自動」手動開啟
    toggleBtn?.addEventListener('click', ()=>{
      const on = document.body.classList.toggle('show-sr-overlay');
      toggleBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
      toggleBtn.textContent = on ? '控制：開啟' : '控制：自動';
    });

    // 讓 D-pad / ENTER 鈕用 act 觸發
    function wireSrPad(){
      const dpad = document.getElementById('srDpad');
      const enterPad = document.getElementById('srEnter');
      const hook = (root)=> root?.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-key]'); if(!btn) return;
        act(btn.getAttribute('data-key'));
      });
      hook(dpad); hook(enterPad);
    }
    wireSrPad();

    // 你也可以在切換「養貓對話」、「測驗視窗」時，暫時自動開/關疊層：
    window.addEventListener('quiz-open',  ()=> showOverlay());   // 測驗期間建議用按鈕操作
    window.addEventListener('quiz-close', ()=> hideOverlay());

    // 若你想「自動判斷 SR 可能開啟 → 顯示疊層」，
    // 可以觀察使用者嘗試滑動卻 5 秒內沒有任何移動成功事件，再自動 showOverlay()。
    // 這裡先留介面（避免誤判），保守交由玩家手動切換。
  })();
  </script>

  <!-- A11Y 初始化 -->
  <script>
    document.addEventListener('game-ready', () => {
      const stageEl = document.getElementById('gameArea');
      window.__focusHints = A11YFocusHints.install({
        stageEl,
        hintText: '提示：已進入遊戲。NVDA 使用者請按 NVDA 加 空白，切換到焦點模式，再用方向鍵操作。'
      });

      window.__arb = A11YArbiter.install({
        hpEl:   document.getElementById('playerHP'),
        coinEl: document.getElementById('playerCoins'),
        wpnEl:  document.getElementById('weaponStatus'),
        srEl:   document.getElementById('srStatus'),
      });

      window.__sc = SpawnConductor.install({
        srEl: document.getElementById('srStatus'),
      });
    });

    window.addEventListener('beforeunload', () => {
      try { window.__focusHints?.destroy(); } catch(_){}
    });
  </script>

  <!-- 勇者名稱貼圖補丁（維持「角色名．暱稱」顯示） -->
  <script>
  ;(() => {
    "use strict";
    const roleMap = {
      "kinbah.png": "金巴","mailah.png": "麥拉","khaupe.png": "考盃","holah.png": "赫拉",
      "chinaikhun.png": "金．艾捆","chiaulaipeh.png": "郊．萊北","mienphapan.png": "綿葩．坂","hamchuniok.png": "罕族．拗"
    };
    const fileKey = (p)=> (String(p||'').split('#')[0].split('?')[0].split('/').pop()||'').toLowerCase();
    function readHero(){
      let p={}; try{ p=JSON.parse(localStorage.getItem("bugSlayerPlayer")||"{}"); }catch(_){}
      const name=p?.name||"無名勇者", avatarPath=p?.avatar||"", roleName=roleMap[fileKey(avatarPath)]||"未知勇者";
      return { name, roleName, avatarPath };
    }
    function initHeroUI(){
      const { name, roleName, avatarPath } = readHero();
      const elName = document.getElementById("playerName");
      if (elName) elName.textContent = `${roleName}．${name}`;
      let sticker = document.getElementById("heroSticker");
      if (!sticker) {
        sticker = document.createElement("img");
        sticker.id = "heroSticker";
        sticker.className = "hero-sticker";
        sticker.alt = ""; sticker.setAttribute("aria-hidden","true");
        document.body.appendChild(sticker);
      }
      sticker.style.display = avatarPath ? "" : "none";
      if (avatarPath) sticker.src = avatarPath;
    }
    function patchUpdateUI(){
      if (!window.Core || typeof Core.updateUI !== "function") return false;
      if (Core.__patchedHeroName) return true;
      const orig = Core.updateUI.bind(Core);
      Core.updateUI = function(){
        orig();
        const { name, roleName } = readHero();
        const elName = document.getElementById("playerName");
        if (elName) elName.textContent = `${roleName}．${name}`;
      };
      Core.__patchedHeroName = true; return true;
    }
    function ensurePatched(){
      if (patchUpdateUI()) return;
      const t0=Date.now(), timer=setInterval(()=>{ if (patchUpdateUI() || Date.now()-t0>5000) clearInterval(timer); },120);
    }
    document.addEventListener("DOMContentLoaded", initHeroUI);
    document.addEventListener("game-ready", () => { initHeroUI(); ensurePatched(); }, { once:true });
    window.addEventListener("load", ensurePatched, { once:true });
  })();
  </script>

  <!-- 等 TTS 完整後再生第一隻 -->
  <script>
  (function(){
    document.addEventListener('game-ready', async function(){
      try {
        window.__gateOpen = true;
        while (window.Core && Core._speechDepth > 0) {
          await new Promise(r => setTimeout(r, 120));
        }
        window.__gateOpen = false;
        if (window.Core && typeof Core.spawnBug === 'function') Core.spawnBug();
      } catch(_) {}
    }, { once: true });
  })();
  </script>

  <!-- 模式切換（Shift+M） -->
  <script>
    Modes.applyModeOnLoad();
    Modes.bindQuickToggle();
  </script>
  <!-- 手機：武器浮動選單控制 -->
  <script>
  (function(){
    const toggle = document.getElementById('weaponToggle');
    const menu   = document.getElementById('weaponMenu');
    if (!toggle || !menu) return;

    let open = false;
    const show = ()=>{ menu.style.display='flex'; toggle.setAttribute('aria-expanded','true'); open=true; };
    const hide = ()=>{ menu.style.display='none';  toggle.setAttribute('aria-expanded','false'); open=false; };
    const toggleMenu = ()=>{ open ? hide() : show(); };

    toggle.addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); });

    // 點外面自動收起
    document.addEventListener('click', (e)=>{
      if (open && !menu.contains(e.target) && e.target!==toggle){ hide(); }
    });

    // 點子按鈕 → 換武器
    menu.addEventListener('click',(e)=>{
      const btn=e.target.closest('button[data-wpn]');
      if(!btn || btn.disabled) return;
      window.changeWeapon?.(btn.dataset.wpn);
      hide();
    });

    // 第一關啟用 1~3
    ['fire','spray','slipper'].forEach(id=>{
      menu.querySelector(`button[data-wpn="${id}"]`)?.removeAttribute('disabled');
    });
  })();
  </script>

  <!-- SR live region 噪音門 -->
  <script>
  (function (w) {
    'use strict';
    const LIVE_SELECTORS = ['#srStatus','#message','[role="status"][aria-live]','[aria-live="polite"]','[aria-live="assertive"]'];
    const getLiveNodes = () => { const set=new Set(); LIVE_SELECTORS.forEach(sel=>{ document.querySelectorAll(sel).forEach(n=>set.add(n)); }); return Array.from(set); };
    const original = new WeakMap();
    function mute(){ getLiveNodes().forEach(n=>{ if(!original.has(n)) original.set(n, n.getAttribute('aria-live')||''); n.setAttribute('aria-live','off'); }); document.body.setAttribute('aria-busy','true'); }
    function unmute(){ getLiveNodes().forEach(n=>{ const v=original.get(n); if(v===null||v==='') n.removeAttribute('aria-live'); else n.setAttribute('aria-live',v); }); document.body.removeAttribute('aria-busy'); }
    const busy = ()=> !!(w.Core && typeof Core._speechDepth==='number' && Core._speechDepth>0) || !!(w.speechSynthesis && speechSynthesis.speaking);
    (function watch(){ let m=false; setInterval(()=>{ const b=busy(); if(b && !m){ mute(); m=true; } else if(!b && m){ unmute(); m=false; } }, 120); })();
    w.addEventListener?.('quiz-open',  mute);
    w.addEventListener?.('quiz-close', unmute);
    w.addEventListener?.('beforeunload', unmute);
  })(window);
  </script>
</body>
</html>
