<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ç¬¬ 1 é—œï¼šæˆ°é¬¥é–‹å§‹ï¼ - é€²æ“Šçš„èŸ‘è‚</title>
  <link rel="stylesheet" href="style.css" />
  <script src="js/core/modes.js"></script>
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: url("assets/images/game_bg1.png") no-repeat center center fixed;
      background-size: cover; /* è®“åœ–ç‰‡å¡«æ»¿è¢å¹• */
      font-family: sans-serif;
    }
    #gameArea {
      display: flex;
      justify-content: center;
      margin: 1rem auto;
      gap: 0.5rem;
    }
    .tile {
      width: 50px;
      height: 50px;
      border: 2px solid #333;
      font-size: 1.5rem;
      text-align: center;
      line-height: 50px;
      background-color: #eee;
    }
    .tile.player { background-color: #cce5ff; }
    .tile.bug    { background-color: #f8d7da; }
    #touchControls {
      margin: 1rem auto;
      text-align: center;
    }
    #touchControls button { font-size: 1rem; margin: 0.3rem; }
    #message { margin-top: 1rem; font-weight: bold; text-align: center; }
      /* è¦–éšœå‹å–„çš„éš±å½¢æ¨£å¼ï¼ˆè¢å¹•é–±è®€å™¨å¯è®€ï¼‰ */
  .sr-only {
    position:absolute !important;
    width:1px;height:1px;
    padding:0;margin:-1px;
    overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
  }
    /* å‹‡è€…è²¼åœ–ï¼ˆå³ä¸‹è§’è£é£¾ï¼Œä¸æ“‹æ“ä½œï¼‰ */
  .hero-sticker{
    position: fixed;
    right: 12px;
    bottom: 12px;
    width: min(22vw, 180px);
    max-width: 220px;
    height: auto;
    opacity: .95;
    pointer-events: none;                 /* â˜… ä¸æ””æˆªæ»‘é¼ /è§¸æ§ */
    filter: drop-shadow(0 6px 18px rgba(0,0,0,.45));
    z-index: 10;
  }
  @media (max-width: 480px){
    .hero-sticker{ width: 28vw; opacity: .9; }
  }
  </style>
</head>
<body class="stage1">
  <main>
    <h1>å„²è—å®¤æœ‰æ€ªè²éŸ³...</h1>

    <!-- ç©å®¶ç‹€æ…‹å€å¡Š -->
    <section id="playerStatus" aria-label="ç©å®¶ç‹€æ…‹" style="margin: 1rem 0; font-weight: bold;">
      <div>å‹‡è€…ï¼š<span id="playerName">---</span></div>
      <div>è¡€é‡ï¼š<span id="playerHP">---</span></div>
      <div>é‡‘å¹£ï¼š<span id="playerCoins">---</span></div>
      <div><span id="weaponStatus">---</span></div>
        <!-- çµ¦è¢å¹•å ±è®€å™¨ç”¨çš„éš±å½¢æ‘˜è¦ -->
      <div id="srStatus" aria-live="polite" aria-atomic="true" role="status" class="sr-only"></div>
    </section>

    <!-- è§¸æ§æ§åˆ¶ -->
    <div id="touchControls">
      <button onclick="moveLeft()">â¬…ï¸ å·¦ç§»</button>
      <button onclick="moveRight()">â¡ï¸ å³ç§»</button>
      <button onclick="scanArea()">ğŸ” æƒæ</button>
      <button onclick="attack()">ğŸ”¥ æ”»æ“Š</button>
      <button onclick="changeWeapon('fire')">1ï¸âƒ£ å™´ç«æ§</button>
      <button onclick="changeWeapon('spray')">2ï¸âƒ£ é¦™æ°›å™´éœ§</button>
      <button onclick="changeWeapon('slipper')">3ï¸âƒ£ è—ç™½æ‹–</button>
    </div>

    <!-- éŠæˆ²å ´åœ° -->
    <div id="gameArea" role="group" aria-describedby="a11yHelp" aria-label="éŠæˆ²å ´åœ°ï¼Œå…±æ©«å‘ä¸ƒæ ¼" tabindex="0"></div>

    <div id="message" aria-live="assertive"></div>

    <!-- æ’­éŸ³ç”¨ audio -->
    <audio id="voicePlayer" src="" hidden></audio>
  </main>
  <audio id="bgm" src="assets/sounds/game_01.mp3" loop preload="auto"></audio> <!-- 01 é—œ -->

    <!-- åœ¨ BGM ä¹‹å¾Œåˆå§‹åŒ–/ç™»è¨˜ -->
  <script>
    // 1) åˆå§‹åŒ–ï¼ˆå¯æ—©å°±å‘¼å«ï¼Œå¤šæ¬¡ä¹Ÿæ²’äº‹ï¼‰
    AudioFX.init();

    // 2) ç™»è¨˜è¦è§£é–/æ’­æ”¾çš„ BGMï¼ˆä¸€å®šè¦åœ¨ <audio> ä¹‹å¾Œï¼‰
    const bgm = document.getElementById('bgm');
    AudioFX.register(bgm);

    // ï¼ˆå¯é¸ï¼‰ç•¶ä½ åˆ‡åˆ°ç„¦é»æ¨¡å¼ã€æˆ–æƒæéµæœ‰è¢«è§¸ç™¼æ™‚ï¼Œä¿éšªå«é†’ä¸€æ¬¡
    window.addEventListener('game-ready', () => { try { AudioFX.ensure(); } catch(_) {} });
  </script>

  <script src="js/content/bugs.js"></script>
  <script src="js/content/levels.js"></script>

  <script src="js/core/game-core.js"></script>
  <script src="js/core/mode-lane.js"></script>
  <script src="js/render/furniture.js"></script>
  <script src="js/core/mode-grid.js"></script>

  <script src="js/a11y/focus-hints.js"></script>
  <script src="js/a11y/announce-arbiter.js"></script>
  <script src="js/a11y/spawn-conductor.js"></script>

  <script src="js/boot/game_l1.js"></script>
  <script src="js/core/keys.js"></script>
  <script src="js/core/retry.js"></script>
  <script> Retry.rememberLevel(); </script>

  <script>
    // boot å®Œæˆ/æˆ– game-ready ä¹‹å¾Œå‘¼å«ä¸€æ¬¡
    document.addEventListener('game-ready', () => {
      const stage = document.getElementById('gameArea'); // â˜… å…ˆæŠ“ DOM
      Keys.init({
        stageEl: stage,
        scanFn: () => window.scanArea?.(),
        activeGuardFn: () => window.gameActive !== false // å¯é¸ï¼šé‡åˆ°æ¸¬é©—/å°è©±æ™‚åœç”¨
      });
    }, { once:true });
  </script>

  <script>
  /* === A11Y åˆå§‹åŒ–ï¼šé€²å ´ç„¦é»æç¤º + SR ç‹€æ…‹å ±è®€ä»²è£ === */
  document.addEventListener('game-ready', () => {
    const stageEl = document.getElementById('gameArea');
    window.__focusHints = A11YFocusHints.install({
      stageEl,
      hintText: 'æç¤ºï¼šå·²é€²å…¥éŠæˆ²ã€‚NVDA ä½¿ç”¨è€…è«‹æŒ‰ NVDA åŠ  ç©ºç™½ï¼Œåˆ‡æ›åˆ°ç„¦é»æ¨¡å¼ï¼Œå†ç”¨æ–¹å‘éµæ“ä½œã€‚',
    });

    window.__arb = A11YArbiter.install({
      hpEl:   document.getElementById('playerHP'),
      coinEl: document.getElementById('playerCoins'),
      wpnEl:  document.getElementById('weaponStatus'),
      srEl:   document.getElementById('srStatus'),
    });

    window.__sc = SpawnConductor.install({
      srEl: document.getElementById('srStatus'),
      // ttsBusyFn: () => (Core._speechDepth > 0) || (speechSynthesis?.speaking)
    });
  });

  // åˆ‡é æˆ–é‡è¼‰æ™‚ï¼Œå–„å¾Œé‚„åŸ role/tabindex ç­‰
  window.addEventListener('beforeunload', () => {
    try { window.__focusHints?.destroy(); } catch(_){}
  });
  </script>

  <script>
  ;(() => {
    "use strict";

    // === æª”å â†’ ä¸­æ–‡è§’è‰²åï¼ˆå…¨éƒ¨å°å¯« keyï¼‰ ===
    const roleMap = {
      "kinbah.png": "é‡‘å·´",
      "mailah.png": "éº¥æ‹‰",
      "khaupe.png": "è€ƒç›ƒ",
      "holah.png": "èµ«æ‹‰",
      "chinaikhun.png": "é‡‘ï¼è‰¾æ†",
      "chiaulaipeh.png": "éƒŠï¼èŠåŒ—"
    };

    // å¯é å–æª”åï¼ˆå» query/hashï¼Œè½‰å°å¯«ï¼‰
    function fileKey(path){
      if (!path || typeof path !== "string") return "";
      const clean = path.split("#")[0].split("?")[0];
      const file  = clean.split("/").pop() || "";
      return file.toLowerCase();
    }

    // è®€ç©å®¶ â†’ {name, roleName, avatarPath}
    function readHero(){
      let p = {};
      try { p = JSON.parse(localStorage.getItem("bugSlayerPlayer") || "{}"); } catch {}
      const name = p?.name || "ç„¡åå‹‡è€…";
      const avatarPath = p?.avatar || "";
      const roleName = roleMap[fileKey(avatarPath)] || "æœªçŸ¥å‹‡è€…";
      return { name, roleName, avatarPath };
    }

    // åˆå§‹åŒ–å‹‡è€… UI
    function initHeroUI(){
      const { name, roleName, avatarPath } = readHero();

      // å‹‡è€…åç¨±ï¼ˆè§’è‰²ä¸­æ–‡åï¼æš±ç¨±ï¼‰
      const elName = document.getElementById("playerName");
      if (elName) elName.textContent = `${roleName}ï¼${name}`;

      // å³ä¸‹è§’è²¼åœ–ï¼ˆè£é£¾ï¼‰
      let sticker = document.getElementById("heroSticker");
      if (!sticker) {
        sticker = document.createElement("img");
        sticker.id = "heroSticker";
        sticker.className = "hero-sticker";
        sticker.alt = "";
        sticker.setAttribute("aria-hidden", "true");
        document.body.appendChild(sticker);
      }
      sticker.style.display = avatarPath ? "" : "none";
      if (avatarPath) sticker.src = avatarPath;
    }

    // æ””æˆª Core.updateUIï¼Œæ¯æ¬¡éƒ½ç¶­æŒé¡¯ç¤ºã€Œè§’è‰²ä¸­æ–‡åï¼æš±ç¨±ã€
    function patchUpdateUI(){
      if (!window.Core || typeof Core.updateUI !== "function") return false;
      if (Core.__patchedHeroName) return true;

      const orig = Core.updateUI.bind(Core);
      Core.updateUI = function(){
        orig();
        const { name, roleName } = readHero();
        const elName = document.getElementById("playerName");
        if (elName) elName.textContent = `${roleName}ï¼${name}`;
      };
      Core.__patchedHeroName = true;
      return true;
    }

    // ç¢ºä¿ patch æˆåŠŸï¼ˆäº‹ä»¶ + è¼ªè©¢ï¼‰
    function ensurePatched(){
      if (patchUpdateUI()) return;
      const t0 = Date.now();
      const timer = setInterval(() => {
        if (patchUpdateUI() || Date.now() - t0 > 5000) clearInterval(timer);
      }, 120);
    }

    document.addEventListener("DOMContentLoaded", initHeroUI);
    document.addEventListener("game-ready", () => {
      initHeroUI();
      ensurePatched();
    }, { once:true });
    window.addEventListener("load", ensurePatched, { once:true });
  })();
  </script>

  <script>
  (function(){
    // éŠæˆ²å°±ç·’ â†’ å…ˆé—œé–€ â†’ ç­‰ TTS å®Œæˆ â†’ é–‹é–€ & ç”Ÿç¬¬ä¸€éš»
    document.addEventListener('game-ready', async function(){
      try {
        // é€™æ™‚ announceLevelIntro() å·²ç¶“é–‹å§‹è¬›äº†ï¼›å…ˆæŠŠé–€é—œä¸Šï¼Œé˜²æ­¢è¬›å®Œè‡ªå‹•ç”Ÿæ€ª
        window.__gateOpen = true;

        // ç­‰åˆ° Core çš„èªéŸ³ä½”ç”¨æ¸…ç©ºï¼ˆ= é–‹å ´æ—ç™½å”¸å®Œï¼‰
        while (window.Core && Core._speechDepth > 0) {
          await new Promise(r => setTimeout(r, 120));
        }

        // é–‹é–€ & æ”¾æ€ª
        window.__gateOpen = false;
        if (window.Core && typeof Core.spawnBug === 'function') {
          Core.spawnBug();
        }
      } catch(_) {}
    }, { once: true });
  })();
  </script>
  <script>
    Modes.applyModeOnLoad();
    Modes.bindQuickToggle();

    // è‹¥ä½ æœ‰éŠæˆ²èªéŸ³ï¼Œæ¨¡å¼åˆ‡æ›æ™‚ä¹Ÿå¯è£œä¸€æ®µèªªæ˜ï¼š
    document.addEventListener('keydown', (e)=>{
      if (e.shiftKey && (e.key === 'M' || e.key === 'm')) {
        // é€™è£¡ä¸ç”¨åšåˆ¥çš„ï¼Œmodes.js æœƒè™•ç† TTS + aria äº†
      }
    });
  </script>
  <script>
  /* SRNoiseGate v1 â€” å…¨åŸŸé—œ/é–‹ live regionï¼Œé¿å… NVDA æ¶è©± */
  (function (w) {
    'use strict';
    // ä½ è¦ã€Œç®¡æ§ã€çš„ live å…ƒç´ ï¼ˆå¯è¦–éœ€æ±‚åŠ ï¼‰
    const LIVE_SELECTORS = [
      '#srStatus',  // æˆ‘å€‘çš„ç‹€æ…‹æ’­å ±
      '#message',   // å¤§å¤šæ•¸é—œå¡ç”¨ä¾†é¡¯ç¤ºæç¤º/è­¦ç¤º
      '[role="status"][aria-live]',
      '[aria-live="polite"]',
      '[aria-live="assertive"]'
    ];

    // å– DOM + å»é‡
    function getLiveNodes() {
      const set = new Set();
      LIVE_SELECTORS.forEach(sel => {
        document.querySelectorAll(sel).forEach(n => set.add(n));
      });
      return Array.from(set);
    }

    // è¨˜ä½åŸæœ¬ aria-liveï¼Œä¹‹å¾Œæ¢å¾©
    const original = new WeakMap();
    function muteLiveRegions() {
      getLiveNodes().forEach(n => {
        if (!original.has(n)) original.set(n, n.getAttribute('aria-live') || '');
        n.setAttribute('aria-live', 'off');
      });
      // å‘Šè¨´ ATï¼šé é¢æš«æ™‚å¿™ï¼Œåˆ¥å¿µè®Šæ›´ï¼ˆè¼”åŠ©æ——æ¨™ï¼‰
      document.body.setAttribute('aria-busy', 'true');
    }
    function unmuteLiveRegions() {
      getLiveNodes().forEach(n => {
        const v = original.get(n);
        if (v === null || v === '') n.removeAttribute('aria-live');
        else n.setAttribute('aria-live', v);
      });
      document.body.removeAttribute('aria-busy');
    }

    // åˆ¤æ–· TTS æ˜¯å¦å¿™ç¢Œï¼ˆCore æˆ–ç€è¦½å™¨ TTS å…¶ä¸€ï¼‰
    function ttsBusy() {
      const coreBusy  = !!(w.Core && typeof Core._speechDepth === 'number' && Core._speechDepth > 0);
      const synthBusy = !!(w.speechSynthesis && speechSynthesis.speaking);
      return coreBusy || synthBusy;
    }

    // ç›£è½å™¨ï¼šå®šæœŸæŸ¥çœ‹ç‹€æ…‹è½‰è®Šï¼Œåªåœ¨ã€Œå¿™ç¢Œâ†’ç©ºé–’ã€ã€Œç©ºé–’â†’å¿™ç¢Œã€æ™‚åˆ‡æ›
    (function startWatcher() {
      let muted = false;
      setInterval(() => {
        const busy = ttsBusy();
        if (busy && !muted) { muteLiveRegions(); muted = true; }
        else if (!busy && muted) { unmuteLiveRegions(); muted = false; }
      }, 120);
    })();

    // è‹¥æœ‰ Quiz open/close äº‹ä»¶ä¹Ÿä¸€ä½µæ›ä¸Šï¼Œé€²ä¸€æ­¥éœéŸ³
    w.addEventListener?.('quiz-open',  muteLiveRegions);
    w.addEventListener?.('quiz-close', unmuteLiveRegions);

    // é€€å‡ºé é¢æ™‚æ¸…ç†
    w.addEventListener?.('beforeunload', unmuteLiveRegions);
  })(window);
  </script>
</body>
</html>
