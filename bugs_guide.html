<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>蟑螂圖鑑</title>
  <link rel="stylesheet" href="style.css" />
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>
  <style>
    body { margin: 0; padding: 0; background: #0b0b0b url("assets/images/start_bg.png") center/cover no-repeat fixed; color: #fff; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 1.2rem; }
    h1 { margin: .5rem 0 1rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
    .card { background: rgba(0,0,0,.45); border: 1px solid #ffffff33; border-radius: 12px; padding: 12px; }
    .card img { width: 100%; height: auto; border-radius: 10px; display: block; }
    .meta { font-size: .95rem; line-height: 1.6; }
    .tag { display: inline-block; margin-right: .4rem; margin-bottom: .2rem; padding: .1rem .5rem; border-radius: 999px; background: #ffffff22; font-size: .85rem; }
    .btnbar { margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap; }
    .btn { background: #ffd452; color: #222; border: none; border-radius: 8px; padding: .5rem .9rem; cursor: pointer; }
    .btn:hover { filter: brightness(1.05); }

    /* --- 無障礙：skip link（隱藏，聚焦時顯示） --- */
    .skip-link {
      position: absolute; left: -9999px; top: 0;
      background: #ffd452; color: #111; padding: .5rem .75rem; border-radius: 8px;
      text-decoration: none; box-shadow: 0 2px 6px rgba(0,0,0,.3);
    }
    .skip-link:focus, .skip-link:focus-visible {
      left: 12px; top: 12px; z-index: 1000;
      outline: 2px solid #222;
    }
    /* 聚焦樣式，讓鍵盤使用者看得到 */
    .card:focus, .card:focus-visible {
      outline: 3px solid #ffd452; outline-offset: 2px;
    }
    /* 只給讀屏用的隱藏 class */
    .sr-only {
      position: absolute !important;
      width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0, 0, 1px, 1px); white-space: nowrap; border: 0;
    }
  </style>
</head>
<body class="guide">
  <!-- 隱藏的跳轉連結：聚焦時才顯示 -->
  <a href="#main" class="skip-link" id="skipToMain">跳到主內容</a>

  <main class="wrap" id="main" tabindex="-1" aria-label="蟑螂圖鑑主內容">
    <h1>蟑螂圖鑑</h1>
    <p>出場角色與擊殺獎勵說明：</p>

    <!-- 讀屏用 live 區（宣告跳轉與卡片提示） -->
    <div id="live" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <section class="grid" id="bugGrid" aria-label="蟑螂圖鑑卡片列表"></section>

    <div class="btnbar">
      <button class="btn" id="nextBtn" onclick="location.href='level_intro_01.html'">前往第 1 關</button>
    </div>

    <!-- 播音用 audio（若有語音檔需求） -->
    <audio id="voicePlayer" src="" hidden></audio>
  </main>

  <audio id="bgm" src="assets/sounds/cockroach_intro.mp3" loop preload="auto"></audio>

  <!-- 在 BGM 之後初始化/登記 -->
  <script>
    // 1) 初始化（可早就呼叫，多次也沒事）
    AudioFX.init();
    // 2) 登記要解鎖/播放的 BGM（一定要在 <audio> 之後）
    const bgm = document.getElementById('bgm');
    AudioFX.register(bgm);
    // （可選）當你切到焦點模式、或掃描鍵有被觸發時，保險叫醒一次
    window.addEventListener('game-ready', () => { try { AudioFX.ensure(); } catch(_) {} });
  </script>

  <!-- 先載入資料 -->
  <script src="js/content/bugs.js"></script>

  <script>
    (function () {
      const bgm = document.getElementById('bgm');
      function tryPlay() {
        bgm?.play().catch(()=>{ /* 使用者還沒互動就算了 */ });
        document.removeEventListener('click', tryPlay);
        document.removeEventListener('keydown', tryPlay);
        document.removeEventListener('touchstart', tryPlay);
      }
      document.addEventListener('click', tryPlay, { once: true });
      document.addEventListener('keydown', tryPlay, { once: true });
      document.addEventListener('touchstart', tryPlay, { once: true, passive: true });
    })();
  </script>

  <script>
  // 統一的鍵→中文對照
  const LABELS = {
    fire: "噴火槍",
    spray: "香氛噴霧",
    slipper: "藍白拖",
    flamethrower: "火焰噴射器",
    bait: "毒餌",
    vote: "被罷免",
    puzzle_lose: "比猜謎輸掉",
    cat: "貓"
  };

  function dropText(b) {
    const r = b.reward || {};
    const parts = [];
    if (r.hp)    parts.push(`🩸 血量 +${r.hp}`);
    if (r.coins) parts.push(`🪙 金幣 +${r.coins}`);
    const possible = ["fire","spray","slipper","flamethrower","bait","poison_box","vote","cat"];
    possible.forEach(k => { if (r[k]) parts.push(`${LABELS[k] || k} +${r[k]}`); });
    return parts.length ? parts.join("、") : "—";
  }

  function damageText(b) {
    const d = b.damage || {};
    const parts = [];
    if (d.hp)    parts.push(`🩸 血量 -${d.hp}`);
    if (d.coins) parts.push(`🪙 金幣 -${d.coins}`);
    return parts.length ? parts.join("、") : "—";
  }

  // ===== 產生圖片替代文字 =====
  function buildImageAlt(b) {
    if (b.imageAlt && typeof b.imageAlt === 'string') return b.imageAlt.trim();
    const bits = [];
    if (b.description) bits.push(b.description.replace(/\s+/g, ' ').trim());
    if (b.title) bits.push(b.title.replace(/\s+/g, ' ').trim());
    let alt = bits.filter(Boolean).join("，");
    if (!alt) alt = "正在出沒中的蟑螂，姿勢詭祕。";
    if (alt.length > 120) alt = alt.slice(0, 118) + "…";
    return alt;
  }

  (function renderGuide() {
    const list = (window.bugs || []);
    const grid = document.getElementById("bugGrid");
    if (!grid) return;

    grid.innerHTML = list.map((b, idx) => {
      const weaknesses = (b.weaknesses || [])
        .map(w => LABELS[w] || w)
        .map(name => `<span class="tag">${name}</span>`).join("");

      const imgAlt = buildImageAlt(b);
      const hid = `bug-h-${idx}`;
      const did = `bug-d-${idx}`;
      const aid = `bug-a-${idx}`;

      return `
        <article
          class="card"
          role="article"
          tabindex="0"
          aria-labelledby="${hid}"
          aria-describedby="${did} ${aid}"
          data-index="${idx}"
        >
          <img src="${b.image}" alt="${imgAlt}" loading="lazy" decoding="async">
          <h2 id="${hid}" style="margin:.5rem 0 .25rem">${b.name}</h2>
          <div id="${did}" class="meta">${b.title ? `${b.title}<br>` : ""}${b.description || ""}</div>
          <div class="meta" style="margin-top:.4rem">弱點：${weaknesses || "—"}</div>
          <div class="meta" style="margin-top:.4rem">被咬的後果：${damageText(b)}</div>
          <div id="${aid}" class="meta" style="margin-top:.4rem">擊殺獎勵：${dropText(b)}</div>
        </article>
      `;
    }).join("");

    // === 跳到主內容：把焦點帶到第一張卡片，並宣告給讀屏 ===
    const skip = document.getElementById('skipToMain');
    const live = document.getElementById('live');
    const firstCard = grid.querySelector('.card');
    const nextBtn = document.getElementById('nextBtn');

    function announce(msg){
      if (!live) return;
      // 重設內容以觸發 aria-live
      live.textContent = '';
      // 用 setTimeout 確保 NVDA 抓到更新
      setTimeout(()=>{ live.textContent = msg; }, 0);
    }

    function focusFirstCard() {
      if (!firstCard) return;
      // 讓讀屏知道我們真的來到主內容與第一張卡
      announce('已跳到主內容。即將介紹第一張卡片。');
      firstCard.focus();
    }

    // 點擊或按 Enter 皆可
    skip.addEventListener('click', (e)=> {
      e.preventDefault();
      focusFirstCard();
    });
    skip.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        focusFirstCard();
      }
    });

    // 每當卡片取得焦點時，播報簡短提示（避免太冗長）
    grid.addEventListener('focusin', (e)=>{
      const card = e.target.closest('.card');
      if (!card) return;
      const idx = Number(card.getAttribute('data-index') || 0);
      const h = card.querySelector('h2')?.textContent?.trim() || `卡片 ${idx+1}`;
      announce(`第 ${idx+1} 張卡片：${h}。按 Tab 可繼續聽下一張。`);
    });

    // 鍵盤友善：在最後一張卡片按 Tab，自然會到下一步按鈕
    //（DOM 順序已確保按鈕在卡片後方，所以無需額外代碼）
  })();
  </script>
</body>
</html>
