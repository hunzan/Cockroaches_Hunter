<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>èŸ‘è‚åœ–é‘‘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>
  <style>
    :root{
      --accent:#ffd452;
      --glass: rgba(255,255,255,.06);
      --glass-strong: rgba(255,255,255,.12);
      --bd: rgba(255,255,255,.18);
    }
    /* åŸºåº•ï¼ˆé»‘åº•ï¼‹èƒŒåœ–ï¼›è¡Œå‹•è£ç½®æœ€ä½³åŒ–ï¼‰ */
    body {
      margin: 0;
      color: #fff;
      background: #0b0b0b url("assets/images/start_bg.png") center/cover no-repeat fixed;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 16px; }
    h1 { margin: .5rem 0 .6rem; text-shadow: 0 2px 10px rgba(0,0,0,.6); }
    p.lead { margin: 0 0 .75rem; opacity: .9 }

    /* å¡ç‰‡ç¶²æ ¼ï¼ˆRWDï¼‰ */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }
    @media (max-width: 520px){
      .grid { grid-template-columns: 1fr; gap: 14px; }
    }

    .card {
      background: rgba(0,0,0,.45);
      border: 1px solid #ffffff33;
      border-radius: 14px;
      padding: 12px;
      display: grid;
      grid-template-rows: auto auto auto 1fr;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      cursor: pointer; /* è¡Œå‹•è£ç½®æç¤ºå¯é» */
      touch-action: manipulation;
    }
    .card:hover { transform: translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,.35); }
    .card:focus, .card:focus-visible {
      outline: 3px solid var(--accent);
      outline-offset: 2px;
      box-shadow: 0 0 0 3px rgba(255,212,82,.25);
      border-color: var(--accent);
    }
    .card img { width: 100%; height: auto; border-radius: 10px; display: block; }

    .meta { font-size: .95rem; line-height: 1.6; }
    .tag {
      display: inline-block; margin-right: .4rem; margin-bottom: .2rem;
      padding: .1rem .5rem; border-radius: 999px; background: #ffffff22;
      font-size: .85rem;
    }

    .btnbar { margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      background: var(--accent); color: #222; border: none; border-radius: 999px;
      padding: .65rem 1.1rem; cursor: pointer; font-weight: 800;
      box-shadow: 0 3px 12px rgba(0,0,0,.35);
      touch-action: manipulation;
    }
    .btn:active { transform: translateY(1px); }

    /* Skip linkï¼ˆéµç›¤èšç„¦æ‰é¡¯ç¤ºï¼‰ */
    .skip-link{
      position: absolute; left: -9999px; top: 0;
      background: var(--accent); color:#111; padding: .5rem .75rem; border-radius: 10px;
      text-decoration: none; box-shadow: 0 2px 10px rgba(0,0,0,.35);
    }
    .skip-link:focus, .skip-link:focus-visible { left: 12px; top: 12px; z-index: 1000; outline: 2px solid #222; }

    /* sr-only */
    .sr-only {
      position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0, 0, 1px, 1px); white-space: nowrap; border: 0;
    }

    /* é™ä½å‹•æ•ˆ */
    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body class="guide">
  <!-- è·³ä¸»å…§å®¹ -->
  <a href="#main" class="skip-link" id="skipToMain">è·³åˆ°ä¸»å…§å®¹</a>

  <main class="wrap" id="main" tabindex="-1" aria-label="èŸ‘è‚åœ–é‘‘ä¸»å…§å®¹">
    <h1>èŸ‘è‚åœ–é‘‘</h1>
    <p class="lead">å‡ºå ´è§’è‰²èˆ‡æ“Šæ®ºçå‹µèªªæ˜ï¼š</p>

    <!-- è®€å±ç”¨ live å€ï¼ˆå®£å‘Šè·³è½‰èˆ‡å¡ç‰‡æç¤ºï¼‰ -->
    <div id="live" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <!-- ç”¨ list/listitem çš„èªæ„ -->
    <section>
      <div class="grid" id="bugGrid" role="list" aria-label="èŸ‘è‚åœ–é‘‘å¡ç‰‡åˆ—è¡¨"></div>
    </section>

    <div class="btnbar">
      <button class="btn" id="nextBtn" type="button" onclick="location.href='level_intro_01.html'">å‰å¾€ç¬¬ 1 é—œ</button>
    </div>

    <!-- æ’­éŸ³ç”¨ï¼ˆè‹¥ç„¡ AudioFX ä¹Ÿèƒ½ fallbackï¼‰ -->
    <audio id="voicePlayer" src="" hidden></audio>
  </main>

  <!-- èƒŒæ™¯éŸ³æ¨‚ -->
  <audio id="bgm" src="assets/sounds/cockroach_intro.mp3" loop preload="auto" playsinline></audio>

  <!-- éŸ³è¨Šè§£é– / BGM ç™»è¨˜ -->
  <script>
    AudioFX.init();
    AudioFX.register(document.getElementById('bgm'));
    window.addEventListener('game-ready', () => { try { AudioFX.ensure(); } catch(_) {} });
  </script>

  <!-- å…ˆè¼‰å…¥èŸ‘è‚è³‡æ–™ -->
  <script src="js/content/bugs.js"></script>

  <!-- äº’å‹•å¾Œæ·¡å…¥ BGM -->
  <script>
    (function () {
      const bgm = document.getElementById('bgm');
      function fadeInAudio(audio, target = 0.6, durMs = 900) {
        if (!audio) return;
        audio.volume = 0;
        const steps = 18, delta = target / steps, stepMs = Math.ceil(durMs / steps);
        let i = 0;
        const timer = setInterval(() => {
          i++; audio.volume = Math.min(target, audio.volume + delta);
          if (i >= steps) clearInterval(timer);
        }, stepMs);
      }
      function tryPlay() {
        bgm?.play()?.then(()=>fadeInAudio(bgm, 0.6, 900)).catch(()=>{});
        document.removeEventListener('click', tryPlay);
        document.removeEventListener('keydown', tryPlay);
        document.removeEventListener('touchstart', tryPlay);
      }
      document.addEventListener('click', tryPlay, { once: true });
      document.addEventListener('keydown', tryPlay, { once: true });
      document.addEventListener('touchstart', tryPlay, { once: true, passive: true });
    })();
  </script>

  <!-- åœ–é‘‘æ¸²æŸ“èˆ‡äº’å‹• -->
  <script>
    // çµ±ä¸€çš„éµâ†’ä¸­æ–‡å°ç…§ï¼ˆç„¡ poison_boxï¼‰
    const LABELS = {
      fire: "å™´ç«æ§",
      spray: "é¦™æ°›å™´éœ§",
      slipper: "è—ç™½æ‹–",
      flamethrower: "ç«ç„°å™´å°„å™¨",
      bait: "æ¯’é¤Œ",
      vote: "è¢«ç½·å…",
      puzzle_lose: "æ¯”çŒœè¬è¼¸æ‰",
      cat: "è²“"
    };

    function dropText(b) {
      const r = b.reward || {};
      const parts = [];
      if (r.hp)    parts.push(`ğŸ©¸ è¡€é‡ +${r.hp}`);
      if (r.coins) parts.push(`ğŸª™ é‡‘å¹£ +${r.coins}`);
      const possible = ["fire","spray","slipper","flamethrower","bait","vote","cat"];
      possible.forEach(k => { if (r[k]) parts.push(`${LABELS[k] || k} +${r[k]}`); });
      return parts.length ? parts.join("ã€") : "â€”";
    }

    function damageText(b) {
      const d = b.damage || {};
      const parts = [];
      if (d.hp)    parts.push(`ğŸ©¸ è¡€é‡ -${d.hp}`);
      if (d.coins) parts.push(`ğŸª™ é‡‘å¹£ -${d.coins}`);
      return parts.length ? parts.join("ã€") : "â€”";
    }

    // ç”¢ç”Ÿåœ–ç‰‡æ›¿ä»£æ–‡å­—ï¼ˆä¸Šé™ 120 å­—ï¼‰
    function buildImageAlt(b) {
      if (b.imageAlt && typeof b.imageAlt === 'string') return b.imageAlt.trim();
      const bits = [];
      if (b.description) bits.push(b.description.replace(/\s+/g, ' ').trim());
      if (b.title) bits.push(b.title.replace(/\s+/g, ' ').trim());
      let alt = bits.filter(Boolean).join("ï¼Œ");
      if (!alt) alt = "æ­£åœ¨å‡ºæ²’ä¸­çš„èŸ‘è‚ï¼Œå§¿å‹¢è©­ç¥•ã€‚";
      if (alt.length > 120) alt = alt.slice(0, 118) + "â€¦";
      return alt;
    }

    (function renderGuide() {
      const list = (window.bugs || []);
      const grid = document.getElementById("bugGrid");
      if (!grid) return;

      grid.innerHTML = list.map((b, idx) => {
        const weaknesses = (b.weaknesses || [])
          .map(w => LABELS[w] || w)
          .map(name => `<span class="tag">${name}</span>`).join("");

        const imgAlt = buildImageAlt(b);
        const hid = `bug-h-${idx}`;
        const did = `bug-d-${idx}`;
        const aid = `bug-a-${idx}`;

        return `
          <article
            class="card"
            role="listitem"
            tabindex="0"
            aria-labelledby="${hid}"
            aria-describedby="${did} ${aid}"
            data-index="${idx}"
          >
            <img src="${b.image}" alt="${imgAlt}" loading="lazy" decoding="async">
            <h2 id="${hid}" style="margin:.5rem 0 .25rem">${b.name}</h2>
            <div id="${did}" class="meta">${b.title ? `${b.title}<br>` : ""}${b.description || ""}</div>
            <div class="meta" style="margin-top:.4rem">å¼±é»ï¼š${weaknesses || "â€”"}</div>
            <div class="meta" style="margin-top:.4rem">è¢«å’¬çš„å¾Œæœï¼š${damageText(b)}</div>
            <div id="${aid}" class="meta" style="margin-top:.4rem">æ“Šæ®ºçå‹µï¼š${dropText(b)}</div>
          </article>
        `;
      }).join("");

      // === è·³åˆ°ä¸»å…§å®¹ï¼šæŠŠç„¦é»å¸¶åˆ°ç¬¬ä¸€å¼µå¡ç‰‡ï¼Œä¸¦å®£å‘Šçµ¦è®€å± ===
      const skip = document.getElementById('skipToMain');
      const live = document.getElementById('live');
      const firstCard = grid.querySelector('.card');

      function announce(msg){
        if (!live) return;
        live.textContent = '';
        setTimeout(()=>{ live.textContent = msg; }, 0);
      }
      function focusFirstCard() {
        if (!firstCard) return;
        announce('å·²è·³åˆ°ä¸»å…§å®¹ã€‚å³å°‡ä»‹ç´¹ç¬¬ä¸€å¼µå¡ç‰‡ã€‚');
        firstCard.focus();
      }
      skip.addEventListener('click', (e)=>{ e.preventDefault(); focusFirstCard(); });
      skip.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); focusFirstCard(); }
      });

      // === å¡ç‰‡äº’å‹•ï¼šé»æ“Šï¼Enterï¼Space æœ—è®€é‡é»ï¼ˆæ¡Œæ©Ÿï¼‹è¡Œå‹•ï¼‰
      (function bindCardA11y() {
        const voice = document.getElementById("voicePlayer");

        function speak(text){
          if (!('speechSynthesis' in window) || !text) return;
          try{
            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = "zh-TW"; u.rate = 1.4; u.pitch = 1.0; u.volume = 1.0;
            speechSynthesis.speak(u);
          }catch(_){}
        }
        function playBugVoiceIfAny(bugName){
          // å¯é¸ï¼šè‹¥ä½ ç‚ºåœ–é‘‘æº–å‚™ voice/intro æª”ï¼Œå¯æ”¾ assets/sounds/guide/{slug}.mp3
          // æ²’æª”æ¡ˆæ™‚ä¸æœƒæœ‰è²éŸ³ï¼Œä½†ä¸å½±éŸ¿
          try{
            const slug = (bugName || "").toLowerCase().replace(/\s+/g,'_');
            const url = `${window.ASSETS_ROOT || ""}assets/sounds/guide/${slug}.mp3`;
            if (window.AudioFX?.play) {
              AudioFX.play(url);
            } else if (voice) {
              voice.pause(); voice.currentTime = 0; voice.src = url; voice.play().catch(()=>{});
            }
          }catch(_){}
        }
        function handleActivate(card){
          const name = card.querySelector('h2')?.textContent?.trim() || '';
          const desc = card.querySelector('.meta')?.textContent?.trim() || '';
          const metas = Array.from(card.querySelectorAll('.meta')).slice(1,4);
          const tail = metas.map(el => el.textContent.trim()).filter(Boolean).join('ï¼›');
          announce(`ä»‹ç´¹ï¼š${name}`);
          speak(`${name}ã€‚${desc}ã€‚${tail}ã€‚`);
          playBugVoiceIfAny(name);
        }

        grid.addEventListener('click', (e)=>{
          const card = e.target.closest('.card'); if (!card) return;
          handleActivate(card);
        });
        grid.addEventListener('keydown', (e)=>{
          if (e.altKey || e.ctrlKey || e.metaKey) return;
          if (e.key !== 'Enter' && e.key !== ' ') return;
          const card = e.target.closest('.card'); if (!card) return;
          e.preventDefault();
          handleActivate(card);
        });

        // å¡ç‰‡èšç„¦æ™‚ï¼Œçµ¦ç°¡çŸ­æç¤ºï¼ˆé¿å…å†—é•·ï¼‰
        grid.addEventListener('focusin', (e)=>{
          const card = e.target.closest('.card'); if (!card) return;
          const idx = Number(card.getAttribute('data-index') || 0);
          const h = card.querySelector('h2')?.textContent?.trim() || `å¡ç‰‡ ${idx+1}`;
          announce(`ç¬¬ ${idx+1} å¼µå¡ç‰‡ï¼š${h}ã€‚æŒ‰ Enter å¯è½è©³ç´°èªªæ˜ã€‚`);
        });
      })();
    })();
  </script>
</body>
</html>
