<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>èŸ‘è‚åœ–é‘‘</title>
  <link rel="stylesheet" href="style.css" />
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>
  <style>
    body { margin: 0; padding: 0; background: #0b0b0b url("assets/images/start_bg.png") center/cover no-repeat fixed; color: #fff; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 1.2rem; }
    h1 { margin: .5rem 0 1rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
    .card { background: rgba(0,0,0,.45); border: 1px solid #ffffff33; border-radius: 12px; padding: 12px; }
    .card img { width: 100%; height: auto; border-radius: 10px; display: block; }
    .meta { font-size: .95rem; line-height: 1.6; }
    .tag { display: inline-block; margin-right: .4rem; margin-bottom: .2rem; padding: .1rem .5rem; border-radius: 999px; background: #ffffff22; font-size: .85rem; }
    .btnbar { margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap; }
    .btn { background: #ffd452; color: #222; border: none; border-radius: 8px; padding: .5rem .9rem; cursor: pointer; }
    .btn:hover { filter: brightness(1.05); }

    /* --- ç„¡éšœç¤™ï¼šskip linkï¼ˆéš±è—ï¼Œèšç„¦æ™‚é¡¯ç¤ºï¼‰ --- */
    .skip-link {
      position: absolute; left: -9999px; top: 0;
      background: #ffd452; color: #111; padding: .5rem .75rem; border-radius: 8px;
      text-decoration: none; box-shadow: 0 2px 6px rgba(0,0,0,.3);
    }
    .skip-link:focus, .skip-link:focus-visible {
      left: 12px; top: 12px; z-index: 1000;
      outline: 2px solid #222;
    }
    /* èšç„¦æ¨£å¼ï¼Œè®“éµç›¤ä½¿ç”¨è€…çœ‹å¾—åˆ° */
    .card:focus, .card:focus-visible {
      outline: 3px solid #ffd452; outline-offset: 2px;
    }
    /* åªçµ¦è®€å±ç”¨çš„éš±è— class */
    .sr-only {
      position: absolute !important;
      width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0, 0, 1px, 1px); white-space: nowrap; border: 0;
    }
  </style>
</head>
<body class="guide">
  <!-- éš±è—çš„è·³è½‰é€£çµï¼šèšç„¦æ™‚æ‰é¡¯ç¤º -->
  <a href="#main" class="skip-link" id="skipToMain">è·³åˆ°ä¸»å…§å®¹</a>

  <main class="wrap" id="main" tabindex="-1" aria-label="èŸ‘è‚åœ–é‘‘ä¸»å…§å®¹">
    <h1>èŸ‘è‚åœ–é‘‘</h1>
    <p>å‡ºå ´è§’è‰²èˆ‡æ“Šæ®ºçå‹µèªªæ˜ï¼š</p>

    <!-- è®€å±ç”¨ live å€ï¼ˆå®£å‘Šè·³è½‰èˆ‡å¡ç‰‡æç¤ºï¼‰ -->
    <div id="live" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <section class="grid" id="bugGrid" aria-label="èŸ‘è‚åœ–é‘‘å¡ç‰‡åˆ—è¡¨"></section>

    <div class="btnbar">
      <button class="btn" id="nextBtn" onclick="location.href='level_intro_01.html'">å‰å¾€ç¬¬ 1 é—œ</button>
    </div>

    <!-- æ’­éŸ³ç”¨ audioï¼ˆè‹¥æœ‰èªéŸ³æª”éœ€æ±‚ï¼‰ -->
    <audio id="voicePlayer" src="" hidden></audio>
  </main>

  <audio id="bgm" src="assets/sounds/cockroach_intro.mp3" loop preload="auto"></audio>

  <!-- åœ¨ BGM ä¹‹å¾Œåˆå§‹åŒ–/ç™»è¨˜ -->
  <script>
    // 1) åˆå§‹åŒ–ï¼ˆå¯æ—©å°±å‘¼å«ï¼Œå¤šæ¬¡ä¹Ÿæ²’äº‹ï¼‰
    AudioFX.init();
    // 2) ç™»è¨˜è¦è§£é–/æ’­æ”¾çš„ BGMï¼ˆä¸€å®šè¦åœ¨ <audio> ä¹‹å¾Œï¼‰
    const bgm = document.getElementById('bgm');
    AudioFX.register(bgm);
    // ï¼ˆå¯é¸ï¼‰ç•¶ä½ åˆ‡åˆ°ç„¦é»æ¨¡å¼ã€æˆ–æƒæéµæœ‰è¢«è§¸ç™¼æ™‚ï¼Œä¿éšªå«é†’ä¸€æ¬¡
    window.addEventListener('game-ready', () => { try { AudioFX.ensure(); } catch(_) {} });
  </script>

  <!-- å…ˆè¼‰å…¥è³‡æ–™ -->
  <script src="js/content/bugs.js"></script>

  <script>
    (function () {
      const bgm = document.getElementById('bgm');
      function tryPlay() {
        bgm?.play().catch(()=>{ /* ä½¿ç”¨è€…é‚„æ²’äº’å‹•å°±ç®—äº† */ });
        document.removeEventListener('click', tryPlay);
        document.removeEventListener('keydown', tryPlay);
        document.removeEventListener('touchstart', tryPlay);
      }
      document.addEventListener('click', tryPlay, { once: true });
      document.addEventListener('keydown', tryPlay, { once: true });
      document.addEventListener('touchstart', tryPlay, { once: true, passive: true });
    })();
  </script>

  <script>
  // çµ±ä¸€çš„éµâ†’ä¸­æ–‡å°ç…§
  const LABELS = {
    fire: "å™´ç«æ§",
    spray: "é¦™æ°›å™´éœ§",
    slipper: "è—ç™½æ‹–",
    flamethrower: "ç«ç„°å™´å°„å™¨",
    bait: "æ¯’é¤Œ",
    vote: "è¢«ç½·å…",
    puzzle_lose: "æ¯”çŒœè¬è¼¸æ‰",
    cat: "è²“"
  };

  function dropText(b) {
    const r = b.reward || {};
    const parts = [];
    if (r.hp)    parts.push(`ğŸ©¸ è¡€é‡ +${r.hp}`);
    if (r.coins) parts.push(`ğŸª™ é‡‘å¹£ +${r.coins}`);
    const possible = ["fire","spray","slipper","flamethrower","bait","poison_box","vote","cat"];
    possible.forEach(k => { if (r[k]) parts.push(`${LABELS[k] || k} +${r[k]}`); });
    return parts.length ? parts.join("ã€") : "â€”";
  }

  function damageText(b) {
    const d = b.damage || {};
    const parts = [];
    if (d.hp)    parts.push(`ğŸ©¸ è¡€é‡ -${d.hp}`);
    if (d.coins) parts.push(`ğŸª™ é‡‘å¹£ -${d.coins}`);
    return parts.length ? parts.join("ã€") : "â€”";
  }

  // ===== ç”¢ç”Ÿåœ–ç‰‡æ›¿ä»£æ–‡å­— =====
  function buildImageAlt(b) {
    if (b.imageAlt && typeof b.imageAlt === 'string') return b.imageAlt.trim();
    const bits = [];
    if (b.description) bits.push(b.description.replace(/\s+/g, ' ').trim());
    if (b.title) bits.push(b.title.replace(/\s+/g, ' ').trim());
    let alt = bits.filter(Boolean).join("ï¼Œ");
    if (!alt) alt = "æ­£åœ¨å‡ºæ²’ä¸­çš„èŸ‘è‚ï¼Œå§¿å‹¢è©­ç¥•ã€‚";
    if (alt.length > 120) alt = alt.slice(0, 118) + "â€¦";
    return alt;
  }

  (function renderGuide() {
    const list = (window.bugs || []);
    const grid = document.getElementById("bugGrid");
    if (!grid) return;

    grid.innerHTML = list.map((b, idx) => {
      const weaknesses = (b.weaknesses || [])
        .map(w => LABELS[w] || w)
        .map(name => `<span class="tag">${name}</span>`).join("");

      const imgAlt = buildImageAlt(b);
      const hid = `bug-h-${idx}`;
      const did = `bug-d-${idx}`;
      const aid = `bug-a-${idx}`;

      return `
        <article
          class="card"
          role="article"
          tabindex="0"
          aria-labelledby="${hid}"
          aria-describedby="${did} ${aid}"
          data-index="${idx}"
        >
          <img src="${b.image}" alt="${imgAlt}" loading="lazy" decoding="async">
          <h2 id="${hid}" style="margin:.5rem 0 .25rem">${b.name}</h2>
          <div id="${did}" class="meta">${b.title ? `${b.title}<br>` : ""}${b.description || ""}</div>
          <div class="meta" style="margin-top:.4rem">å¼±é»ï¼š${weaknesses || "â€”"}</div>
          <div class="meta" style="margin-top:.4rem">è¢«å’¬çš„å¾Œæœï¼š${damageText(b)}</div>
          <div id="${aid}" class="meta" style="margin-top:.4rem">æ“Šæ®ºçå‹µï¼š${dropText(b)}</div>
        </article>
      `;
    }).join("");

    // === è·³åˆ°ä¸»å…§å®¹ï¼šæŠŠç„¦é»å¸¶åˆ°ç¬¬ä¸€å¼µå¡ç‰‡ï¼Œä¸¦å®£å‘Šçµ¦è®€å± ===
    const skip = document.getElementById('skipToMain');
    const live = document.getElementById('live');
    const firstCard = grid.querySelector('.card');
    const nextBtn = document.getElementById('nextBtn');

    function announce(msg){
      if (!live) return;
      // é‡è¨­å…§å®¹ä»¥è§¸ç™¼ aria-live
      live.textContent = '';
      // ç”¨ setTimeout ç¢ºä¿ NVDA æŠ“åˆ°æ›´æ–°
      setTimeout(()=>{ live.textContent = msg; }, 0);
    }

    function focusFirstCard() {
      if (!firstCard) return;
      // è®“è®€å±çŸ¥é“æˆ‘å€‘çœŸçš„ä¾†åˆ°ä¸»å…§å®¹èˆ‡ç¬¬ä¸€å¼µå¡
      announce('å·²è·³åˆ°ä¸»å…§å®¹ã€‚å³å°‡ä»‹ç´¹ç¬¬ä¸€å¼µå¡ç‰‡ã€‚');
      firstCard.focus();
    }

    // é»æ“Šæˆ–æŒ‰ Enter çš†å¯
    skip.addEventListener('click', (e)=> {
      e.preventDefault();
      focusFirstCard();
    });
    skip.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        focusFirstCard();
      }
    });

    // æ¯ç•¶å¡ç‰‡å–å¾—ç„¦é»æ™‚ï¼Œæ’­å ±ç°¡çŸ­æç¤ºï¼ˆé¿å…å¤ªå†—é•·ï¼‰
    grid.addEventListener('focusin', (e)=>{
      const card = e.target.closest('.card');
      if (!card) return;
      const idx = Number(card.getAttribute('data-index') || 0);
      const h = card.querySelector('h2')?.textContent?.trim() || `å¡ç‰‡ ${idx+1}`;
      announce(`ç¬¬ ${idx+1} å¼µå¡ç‰‡ï¼š${h}ã€‚æŒ‰ Tab å¯ç¹¼çºŒè½ä¸‹ä¸€å¼µã€‚`);
    });

    // éµç›¤å‹å–„ï¼šåœ¨æœ€å¾Œä¸€å¼µå¡ç‰‡æŒ‰ Tabï¼Œè‡ªç„¶æœƒåˆ°ä¸‹ä¸€æ­¥æŒ‰éˆ•
    //ï¼ˆDOM é †åºå·²ç¢ºä¿æŒ‰éˆ•åœ¨å¡ç‰‡å¾Œæ–¹ï¼Œæ‰€ä»¥ç„¡éœ€é¡å¤–ä»£ç¢¼ï¼‰
  })();
  </script>
</body>
</html>
