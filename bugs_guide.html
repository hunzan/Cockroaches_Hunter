<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>蟑螂圖鑑</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>
  <style>
    :root{
      --accent:#ffd452;
      --glass: rgba(255,255,255,.06);
      --glass-strong: rgba(255,255,255,.12);
      --bd: rgba(255,255,255,.18);
    }
    /* 基底（黑底＋背圖；行動裝置最佳化） */
    body {
      margin: 0;
      color: #fff;
      background: #0b0b0b url("assets/images/start_bg.png") center/cover no-repeat fixed;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 16px; }
    h1 { margin: .5rem 0 .6rem; text-shadow: 0 2px 10px rgba(0,0,0,.6); }
    p.lead { margin: 0 0 .75rem; opacity: .9 }

    /* 卡片網格（RWD） */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }
    @media (max-width: 520px){
      .grid { grid-template-columns: 1fr; gap: 14px; }
    }

    .card {
      background: rgba(0,0,0,.45);
      border: 1px solid #ffffff33;
      border-radius: 14px;
      padding: 12px;
      display: grid;
      grid-template-rows: auto auto auto 1fr;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      cursor: pointer; /* 行動裝置提示可點 */
      touch-action: manipulation;
    }
    .card:hover { transform: translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,.35); }
    .card:focus, .card:focus-visible {
      outline: 3px solid var(--accent);
      outline-offset: 2px;
      box-shadow: 0 0 0 3px rgba(255,212,82,.25);
      border-color: var(--accent);
    }
    .card img { width: 100%; height: auto; border-radius: 10px; display: block; }

    .meta { font-size: .95rem; line-height: 1.6; }
    .tag {
      display: inline-block; margin-right: .4rem; margin-bottom: .2rem;
      padding: .1rem .5rem; border-radius: 999px; background: #ffffff22;
      font-size: .85rem;
    }

    .btnbar { margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      background: var(--accent); color: #222; border: none; border-radius: 999px;
      padding: .65rem 1.1rem; cursor: pointer; font-weight: 800;
      box-shadow: 0 3px 12px rgba(0,0,0,.35);
      touch-action: manipulation;
    }
    .btn:active { transform: translateY(1px); }

    /* Skip link（鍵盤聚焦才顯示） */
    .skip-link{
      position: absolute; left: -9999px; top: 0;
      background: var(--accent); color:#111; padding: .5rem .75rem; border-radius: 10px;
      text-decoration: none; box-shadow: 0 2px 10px rgba(0,0,0,.35);
    }
    .skip-link:focus, .skip-link:focus-visible { left: 12px; top: 12px; z-index: 1000; outline: 2px solid #222; }

    /* sr-only */
    .sr-only {
      position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0, 0, 1px, 1px); white-space: nowrap; border: 0;
    }

    /* 降低動效 */
    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body class="guide">
  <!-- 跳主內容 -->
  <a href="#main" class="skip-link" id="skipToMain">跳到主內容</a>

  <main class="wrap" id="main" tabindex="-1" aria-label="蟑螂圖鑑主內容">
    <h1>蟑螂圖鑑</h1>
    <p class="lead">出場角色與擊殺獎勵說明：</p>

    <!-- 讀屏用 live 區（宣告跳轉與卡片提示） -->
    <div id="live" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <!-- 用 list/listitem 的語意 -->
    <section>
      <div class="grid" id="bugGrid" role="list" aria-label="蟑螂圖鑑卡片列表"></div>
    </section>

    <div class="btnbar">
      <button class="btn" id="nextBtn" type="button" onclick="location.href='level_intro_01.html'">前往第 1 關</button>
    </div>

    <!-- 播音用（若無 AudioFX 也能 fallback） -->
    <audio id="voicePlayer" src="" hidden></audio>
  </main>

  <!-- 背景音樂 -->
  <audio id="bgm" src="assets/sounds/cockroach_intro.mp3" loop preload="auto" playsinline></audio>

  <!-- 音訊解鎖 / BGM 登記 -->
  <script>
    AudioFX.init();
    AudioFX.register(document.getElementById('bgm'));
    window.addEventListener('game-ready', () => { try { AudioFX.ensure(); } catch(_) {} });
  </script>

  <!-- 先載入蟑螂資料 -->
  <script src="js/content/bugs.js"></script>

  <!-- 互動後淡入 BGM -->
  <script>
    (function () {
      const bgm = document.getElementById('bgm');
      function fadeInAudio(audio, target = 0.6, durMs = 900) {
        if (!audio) return;
        audio.volume = 0;
        const steps = 18, delta = target / steps, stepMs = Math.ceil(durMs / steps);
        let i = 0;
        const timer = setInterval(() => {
          i++; audio.volume = Math.min(target, audio.volume + delta);
          if (i >= steps) clearInterval(timer);
        }, stepMs);
      }
      function tryPlay() {
        bgm?.play()?.then(()=>fadeInAudio(bgm, 0.6, 900)).catch(()=>{});
        document.removeEventListener('click', tryPlay);
        document.removeEventListener('keydown', tryPlay);
        document.removeEventListener('touchstart', tryPlay);
      }
      document.addEventListener('click', tryPlay, { once: true });
      document.addEventListener('keydown', tryPlay, { once: true });
      document.addEventListener('touchstart', tryPlay, { once: true, passive: true });
    })();
  </script>

  <!-- 圖鑑渲染與互動 -->
  <script>
    // 統一的鍵→中文對照（無 poison_box）
    const LABELS = {
      fire: "噴火槍",
      spray: "香氛噴霧",
      slipper: "藍白拖",
      flamethrower: "火焰噴射器",
      bait: "毒餌",
      vote: "被罷免",
      puzzle_lose: "比猜謎輸掉",
      cat: "貓"
    };

    function dropText(b) {
      const r = b.reward || {};
      const parts = [];
      if (r.hp)    parts.push(`🩸 血量 +${r.hp}`);
      if (r.coins) parts.push(`🪙 金幣 +${r.coins}`);
      const possible = ["fire","spray","slipper","flamethrower","bait","vote","cat"];
      possible.forEach(k => { if (r[k]) parts.push(`${LABELS[k] || k} +${r[k]}`); });
      return parts.length ? parts.join("、") : "—";
    }

    function damageText(b) {
      const d = b.damage || {};
      const parts = [];
      if (d.hp)    parts.push(`🩸 血量 -${d.hp}`);
      if (d.coins) parts.push(`🪙 金幣 -${d.coins}`);
      return parts.length ? parts.join("、") : "—";
    }

    // 產生圖片替代文字（上限 120 字）
    function buildImageAlt(b) {
      if (b.imageAlt && typeof b.imageAlt === 'string') return b.imageAlt.trim();
      const bits = [];
      if (b.description) bits.push(b.description.replace(/\s+/g, ' ').trim());
      if (b.title) bits.push(b.title.replace(/\s+/g, ' ').trim());
      let alt = bits.filter(Boolean).join("，");
      if (!alt) alt = "正在出沒中的蟑螂，姿勢詭祕。";
      if (alt.length > 120) alt = alt.slice(0, 118) + "…";
      return alt;
    }

    (function renderGuide() {
      const list = (window.bugs || []);
      const grid = document.getElementById("bugGrid");
      if (!grid) return;

      grid.innerHTML = list.map((b, idx) => {
        const weaknesses = (b.weaknesses || [])
          .map(w => LABELS[w] || w)
          .map(name => `<span class="tag">${name}</span>`).join("");

        const imgAlt = buildImageAlt(b);
        const hid = `bug-h-${idx}`;
        const did = `bug-d-${idx}`;
        const aid = `bug-a-${idx}`;

        return `
          <article
            class="card"
            role="listitem"
            tabindex="0"
            aria-labelledby="${hid}"
            aria-describedby="${did} ${aid}"
            data-index="${idx}"
          >
            <img src="${b.image}" alt="${imgAlt}" loading="lazy" decoding="async">
            <h2 id="${hid}" style="margin:.5rem 0 .25rem">${b.name}</h2>
            <div id="${did}" class="meta">${b.title ? `${b.title}<br>` : ""}${b.description || ""}</div>
            <div class="meta" style="margin-top:.4rem">弱點：${weaknesses || "—"}</div>
            <div class="meta" style="margin-top:.4rem">被咬的後果：${damageText(b)}</div>
            <div id="${aid}" class="meta" style="margin-top:.4rem">擊殺獎勵：${dropText(b)}</div>
          </article>
        `;
      }).join("");

      // === 跳到主內容：把焦點帶到第一張卡片，並宣告給讀屏 ===
      const skip = document.getElementById('skipToMain');
      const live = document.getElementById('live');
      const firstCard = grid.querySelector('.card');

      function announce(msg){
        if (!live) return;
        live.textContent = '';
        setTimeout(()=>{ live.textContent = msg; }, 0);
      }
      function focusFirstCard() {
        if (!firstCard) return;
        announce('已跳到主內容。即將介紹第一張卡片。');
        firstCard.focus();
      }
      skip.addEventListener('click', (e)=>{ e.preventDefault(); focusFirstCard(); });
      skip.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); focusFirstCard(); }
      });

      // === 卡片互動：點擊／Enter／Space 朗讀重點（桌機＋行動）
      (function bindCardA11y() {
        const voice = document.getElementById("voicePlayer");

        function speak(text){
          if (!('speechSynthesis' in window) || !text) return;
          try{
            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = "zh-TW"; u.rate = 1.4; u.pitch = 1.0; u.volume = 1.0;
            speechSynthesis.speak(u);
          }catch(_){}
        }
        function playBugVoiceIfAny(bugName){
          // 可選：若你為圖鑑準備 voice/intro 檔，可放 assets/sounds/guide/{slug}.mp3
          // 沒檔案時不會有聲音，但不影響
          try{
            const slug = (bugName || "").toLowerCase().replace(/\s+/g,'_');
            const url = `${window.ASSETS_ROOT || ""}assets/sounds/guide/${slug}.mp3`;
            if (window.AudioFX?.play) {
              AudioFX.play(url);
            } else if (voice) {
              voice.pause(); voice.currentTime = 0; voice.src = url; voice.play().catch(()=>{});
            }
          }catch(_){}
        }
        function handleActivate(card){
          const name = card.querySelector('h2')?.textContent?.trim() || '';
          const desc = card.querySelector('.meta')?.textContent?.trim() || '';
          const metas = Array.from(card.querySelectorAll('.meta')).slice(1,4);
          const tail = metas.map(el => el.textContent.trim()).filter(Boolean).join('；');
          announce(`介紹：${name}`);
          speak(`${name}。${desc}。${tail}。`);
          playBugVoiceIfAny(name);
        }

        grid.addEventListener('click', (e)=>{
          const card = e.target.closest('.card'); if (!card) return;
          handleActivate(card);
        });
        grid.addEventListener('keydown', (e)=>{
          if (e.altKey || e.ctrlKey || e.metaKey) return;
          if (e.key !== 'Enter' && e.key !== ' ') return;
          const card = e.target.closest('.card'); if (!card) return;
          e.preventDefault();
          handleActivate(card);
        });

        // 卡片聚焦時，給簡短提示（避免冗長）
        grid.addEventListener('focusin', (e)=>{
          const card = e.target.closest('.card'); if (!card) return;
          const idx = Number(card.getAttribute('data-index') || 0);
          const h = card.querySelector('h2')?.textContent?.trim() || `卡片 ${idx+1}`;
          announce(`第 ${idx+1} 張卡片：${h}。按 Enter 可聽詳細說明。`);
        });
      })();
    })();
  </script>
</body>
</html>
