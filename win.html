<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>勝利！ - 進擊的蟑螂</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>
  <style>
    :root{
      --safe-bottom: env(safe-area-inset-bottom);
      --accent: #7CFFB2;
      --shadow: 0 10px 28px rgba(0,0,0,.45);
    }
    html, body { height: 100%; }
    body{
      margin:0; display:flex; flex-direction:column; justify-content:center; align-items:center;
      text-align:center; color:#fff; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:#000 url("assets/images/win_bg.png") center / cover no-repeat fixed;
      opacity:0; transition:opacity .45s ease;
      -webkit-tap-highlight-color: transparent;
    }
    body.ready{ opacity:1; }
    @media (min-aspect-ratio: 4/3) {
      body { background-size: contain; background-color:#000; }
    }

    main{
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.22);
      border-radius: 18px;
      padding: clamp(1rem, 3.2vw, 1.5rem);
      margin: 0 clamp(.8rem, 3.5vw, 1.2rem);
      backdrop-filter: blur(4px);
      box-shadow: var(--shadow);
      max-width: 820px;
      width: min(94vw, 840px);
    }

    h1{
      margin: .2rem 0 .8rem;
      font-size: clamp(1.7rem, 5vw, 2.4rem);
      text-shadow: 0 2px 6px rgba(0,0,0,.35);
    }
    p{
      margin: 0 0 1rem;
      line-height: 1.75;
      text-shadow: 0 2px 6px rgba(0,0,0,.35);
      font-size: clamp(1rem, 2.8vw, 1.1rem);
    }

    .btnbar{
      display:flex; gap:.75rem; flex-wrap:wrap; justify-content:center;
      margin-top: 1rem;
    }
    .btn{
      appearance:none; border:none; cursor:pointer;
      font-weight:900; letter-spacing:.02em;
      font-size: clamp(1.05rem, 3vw, 1.15rem);
      padding: .8rem 1.4rem; border-radius: 999px;
      background: var(--accent); color:#222;
      box-shadow: var(--shadow);
      transition: transform .08s ease, filter .12s ease;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ background:#ffe78a; color:#222; }
    .btn.ghost{
      background: transparent; color:#fff; border:2px solid #ffffffaa;
    }

    .cta-pad{ padding-bottom: calc(.2rem + var(--safe-bottom)); }

    .skip-link{
      position:fixed; left:12px; top:10px;
      transform: translateY(-150%);
      background:#000; color:#fff;
      padding:.5rem .75rem; border-radius:10px;
      border:2px solid #7CFFB2;
      box-shadow:0 4px 18px rgba(0,0,0,.45);
      z-index:10000;
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .skip-link:focus, .skip-link:focus-visible{
      transform: translateY(0);
      outline: none;
      box-shadow:0 6px 24px rgba(0,0,0,.6);
    }

    .sr-only{
      position:absolute!important; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,1px,1px); white-space:nowrap; border:0;
    }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">跳到主內容</a>

  <main id="main" tabindex="-1" aria-label="勝利畫面主內容" class="cta-pad">
    <h1>取得勝利！成功驅逐所有蟑螂！</h1>
    <p id="winMsg" aria-live="polite">家園恢復了和平與寧靜。</p>

    <div class="btnbar">
      <button id="replayBtn" class="btn" aria-describedby="replayDesc">再玩一次</button>
      <span id="replayDesc" class="sr-only">返回第一關。</span>

      <button id="homeBtn" class="btn ghost" aria-describedby="homeDesc">從頭開始</button>
      <span id="homeDesc" class="sr-only">清除進度並返回首頁。</span>
    </div>
  </main>

  <!-- BGM -->
  <audio id="bgm" src="assets/sounds/win.mp3" preload="auto" autoplay muted playsinline></audio>

  <script>
    // ========== 音訊初始化 ==========
    AudioFX.init();
    const bgm = document.getElementById('bgm');
    AudioFX.register(bgm);

    function speakOnce(text){
      try{
        if (!('speechSynthesis' in window)) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW'; u.rate = 1.25; u.pitch = 1.0; u.volume = 1.0;
        u.onstart = ()=>{ try{ bgm.volume = 0.25; }catch(_){} };
        u.onend   = ()=>{ try{ bgm.volume = 1.0; }catch(_){} };
        speechSynthesis.cancel(); speechSynthesis.speak(u);
      }catch(_){}
    }

    (function(){
      let armed = false;
      function arm(){
        if (armed) return; armed = true;
        try{ AudioFX.ensure(); }catch(_){}
        try{ bgm.muted = false; }catch(_){}
        bgm.play().catch(()=>{});
        document.removeEventListener('pointerdown', arm, true);
        document.removeEventListener('keydown', arm, true);
      }
      bgm.play().catch(()=>{});
      document.addEventListener('pointerdown', arm, true);
      document.addEventListener('keydown', arm, true);
    })();

    // ========== 導航 ==========
    document.addEventListener('DOMContentLoaded', ()=>{
      document.body.classList.add('ready');
      document.getElementById('main')?.focus({ preventScroll:true });

      speakOnce('取得勝利！成功驅逐所有蟑螂！家園恢復了和平與寧靜。');

      document.getElementById('replayBtn')?.addEventListener('click', ()=>{
        // 乾淨重來（保留玩家名也可以，但這裡重置）
        try{
          Object.keys(localStorage).forEach(k=>{
            if (k.startsWith('packApplied_L')) localStorage.removeItem(k);
          });
          localStorage.removeItem('bugSlayerPlayer');
          localStorage.removeItem('usedQuizKeys');
        }catch(_){}
        location.href = 'level_intro_01.html';
      });

      document.getElementById('homeBtn')?.addEventListener('click', ()=>{
        location.href = 'index.html';
      });

      // Enter 預設再玩一次
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('replayBtn')?.click();
        }
      });
    });
  </script>
</body>
</html>
