<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>全破成功！- 進擊的蟑螂</title>
  <link rel="stylesheet" href="style.css" />
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>
  <style>
  html, body { height: 100%; }
  body {
    margin: 0; display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    text-align: center; color: #fff; font-family: sans-serif;
    background: #000 url("assets/images/win_bg.png") center / cover no-repeat fixed;
    opacity: 0; transition: opacity .6s ease;
  }
  body.ready { opacity: 1; }

  @media (min-aspect-ratio: 4/3) {
    body { background-size: contain; background-color: #000; }
  }

  h1 {
    font-size: 2.2rem;
    margin: 0 0 0.5rem;
    text-shadow: 0 2px 6px rgba(0,0,0,.35);
  }
  h2 {
    font-size: 1.5rem;
    margin: 0 0 1rem;
    font-weight: 600;
    text-shadow: 0 1px 3px rgba(0,0,0,.35);
  }
  p { margin: 0 0 1.25rem; line-height: 1.7; text-shadow: 0 2px 6px rgba(0,0,0,.35); }
  button, .btn {
    font-size: 1.1rem; padding: .65rem 1.3rem;
    border: none; border-radius: 10px; cursor: pointer;
    background: #ffd452; color: #222;
  }
  button:hover, .btn:hover { filter: brightness(1.08); }
  </style>
</head>
<body>
  <main>
    <h1>恭喜破關！</h1>
    <!-- ★ 勇者暱稱將顯示在這裡 -->
    <h2 id="heroName"></h2>
    <p>成功收復所有領地，蟑螂軍團被打趴！</p>
    <div class="btnbar">
      <button class="btn" onclick="location.href='index.html'">再玩一次</button>
    </div>
  </main>

  <audio id="bgm" src="assets/sounds/win.mp3" preload="auto" autoplay muted playsinline></audio>

      <!-- 在 BGM 之後初始化/登記 -->
  <script>
    // 1) 初始化（可早就呼叫，多次也沒事）
    AudioFX.init();

    // 2) 登記要解鎖/播放的 BGM（一定要在 <audio> 之後）
    const bgm = document.getElementById('bgm');
    AudioFX.register(bgm);

    // （可選）當你切到焦點模式、或掃描鍵有被觸發時，保險叫醒一次
    window.addEventListener('game-ready', () => { try { AudioFX.ensure(); } catch(_) {} });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('ready');

      // ★ avatar → 中文名稱對照表
      const roleMap = {
        "kinbah.png": "金巴",
        "mailah.png": "麥拉",
        "khaupe.png": "考盃",
        "holah.png": "赫拉",
        "chinaikhun.png": "金．艾捆",
        "chiaulaipeh.png": "郊．萊北"
      };

      // 顯示勇者名稱
      try {
        const player = JSON.parse(localStorage.getItem("bugSlayerPlayer") || "{}");
        if (player && player.name) {
          let roleName = "";
          if (player.avatar) {
            const file = player.avatar.split("/").pop(); // 只取檔名
            roleName = roleMap[file] || "未知勇者";
          }
          document.getElementById("heroName").textContent =
            roleName ? `${roleName}．${player.name}` : player.name;
        }
      } catch(e){ console.warn("讀取玩家名稱失敗", e); }

      // 語音報讀
      const bgm = document.getElementById('bgm');
      if ('speechSynthesis' in window) {
        const u = new SpeechSynthesisUtterance("恭喜破關！成功收復所有領地，蟑螂軍團被打趴！");
        u.lang = "zh-TW";
        u.onstart = () => { bgm.volume = 0.25; };
        u.onend   = () => { bgm.volume = 1;    };
        speechSynthesis.cancel(); speechSynthesis.speak(u);
      }

      // BGM 嘗試靜音自動播，互動後解鎖
      bgm.play().catch(()=>{});
      const enableSoundOnce = () => {
        bgm.muted = false; bgm.volume = 1; bgm.play().catch(()=>{});
        document.removeEventListener('click', enableSoundOnce);
        document.removeEventListener('keydown', enableSoundOnce);
        document.removeEventListener('touchstart', enableSoundOnce);
      };
      document.addEventListener('click',      enableSoundOnce, { once:true });
      document.addEventListener('keydown',    enableSoundOnce, { once:true });
      document.addEventListener('touchstart', enableSoundOnce, { once:true, passive:true });
    });
  </script>
</body>
</html>
