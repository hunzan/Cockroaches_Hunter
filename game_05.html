<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />

  <title>第 5 關：廚房飯廳（10×10） - 進擊的蟑螂</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="style.css" />
  <script src="js/core/modes.js"></script>
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>

  <style>
    html, body { min-height: 100svh; }
    body{
      margin:0; padding:0;
      background:url("assets/images/game_bg3.png") no-repeat center center fixed;
      background-size:cover;
      font-family:sans-serif;
      color:#111;
      opacity:0; transition:opacity .6s ease;
    }
    body.ready{ opacity:1; }

    main {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    h1{ text-align:center; color:#fff; text-shadow:0 2px 8px rgba(0,0,0,.45); margin:.5rem 0 .25rem; }

    /* tile 填滿每個 grid cell，電腦/手機一致 */
    .tile{
      width:100%; height:100%;
      box-sizing:border-box;              /* ← 關鍵：邊框算進格內，就不會把舞台撐寬 */
      display:flex; align-items:center; justify-content:center;
      font-size:1.05rem;
      border:2px solid #333; border-radius:8px;
      text-align:center;
      background:rgba(238,238,238,0.6);  /* ← 半透明灰色 */
      user-select:none;
    }
    .tile.player{ background:#cce5ff; }
    .tile.bug{ background:#f8d7da; }
    .tile.hazard{ box-shadow: inset 0 0 0 3px rgba(255,255,255,.2); }

    /* 行動裝置：讓每格更緊湊，不超出螢幕 */
    @media (pointer:coarse){
      .tile{
        border-width:1px;                 /* 邊框更薄，視覺密度更好 */
        border-radius:6px;
        font-size:.95rem;                 /* 字稍微縮一點 */
      }
    }

    /* 舞台容器本身不再用 max-width 卡住，交由 JS 設定精確 px */
    #gameArea{
      margin: auto;   /* 水平+垂直置中 */
      outline:none;
      touch-action:none;
      -webkit-tap-highlight-color:transparent;
    }

    #message{
      margin-top:.6rem; font-weight:bold; text-align:center;
      color:#fff; text-shadow:0 2px 8px rgba(0,0,0,.45);
      min-height:1.2em;
    }

    /* SR-only */
    .sr-only{
      position:absolute!important; width:1px; height:1px;
      padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0);
      white-space:nowrap; border:0;
    }

  /* 基礎造型（你現有的可保留） */
  .hero-sticker{
    position:fixed; right:12px; bottom:calc(12px + env(safe-area-inset-bottom));
    width:min(21vw,160px); max-width:200px; height:auto;
    opacity:.95; pointer-events:none;
    filter:drop-shadow(0 6px 18px rgba(0,0,0,.45));
    z-index:10;
    transition: transform .18s ease, opacity .18s ease, width .18s ease;
  }

  /* 手機預設略縮，先騰一點空間 */
  @media (pointer:coarse){
    .hero-sticker{ width:min(22vw,140px); }
  }

  /* 偵測到碰撞時，用 class 做更積極的處置 */
  .hero-sticker.is-shy     { transform: scale(.88); opacity:.92; }
  .hero-sticker.is-tiny    { transform: scale(.78); opacity:.90; }
  .hero-sticker.is-hidden  { opacity:0; visibility:hidden; }

    /* 玩家狀態（桌機） */
    #playerStatus{
      margin:.4rem auto 0; padding:.5rem .75rem; max-width:960px;
      background:rgba(255,255,255,.15);
      border-radius:10px; color:#fff;
      text-shadow:0 2px 8px rgba(0,0,0,.45);
    }

    /* 行動版：縮標題、狀態膠囊 */
    @media (pointer:coarse){
      h1{ font-size:1.05rem; font-weight:600; margin:.25rem 0 .1rem; }
      #playerStatus{
        position:fixed; top:calc(8px + env(safe-area-inset-top)); left:8px; right:8px; z-index:18;
        display:flex; flex-wrap:wrap; gap:.25rem .6rem; align-items:center;
        padding:.35rem .6rem;
        background:rgba(0,0,0,.35);
        backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
        border-radius:12px;
        font-size:.9rem; line-height:1.2; color:#fff; text-shadow:0 1px 3px rgba(0,0,0,.35);
      }
      main{ padding-top:calc(2.6rem + env(safe-area-inset-top)); }
    }

    /* 手機：左下武器浮動鈕＋垂直子選單 */
    #weaponToggle{
      position:fixed; left:12px; bottom:calc(12px + env(safe-area-inset-bottom));
      z-index:25;
      background:#ffd452; color:#222; border:none; border-radius:50%;
      width:52px; height:52px; font-size:1.25rem;
      box-shadow:0 3px 10px rgba(0,0,0,.3);
      display:none;
    }
    #weaponMenu{
      position:fixed; left:12px; bottom:calc(72px + env(safe-area-inset-bottom));
      display:none; flex-direction:column; gap:.35rem; z-index:26;
    }
    #weaponMenu button{
      background:#ffd452; color:#222; border:none; border-radius:10px;
      font-size:.9rem; padding:.42rem .55rem; min-width:68px;
      box-shadow:0 3px 8px rgba(0,0,0,.25);
    }
    #weaponMenu button:disabled{ opacity:.55; filter:saturate(.7); }
    #weaponToggle{ display:inline-flex; align-items:center; justify-content:center; }
    @media (pointer:fine){
    /* 只影響滑鼠/桌機，不動手機 */
    #gameArea{
      max-width: min(96vmin, 960px);
      margin-left:auto; margin-right:auto;
      }
    }
    /* 桌機版：顯示勇者圖片 */
    @media (pointer:fine) {
      .hero-sticker { display: block; }
    }
    /* 手機版：隱藏勇者圖片 */
    @media (pointer:coarse) {
      .hero-sticker { display: none; }
    }
  </style>

</head>
<body class="stage5">
  <main>
    <h1>廚房飯廳是最後的防線</h1>

    <p class="sr-only" id="a11yHelp">
      鍵盤：上下左右移動；空白鍵掃描；Enter 攻擊；數字 1~3 切換武器。
      手機若已開啟螢幕閱讀器：二指滑動移動；單指雙擊任意位置攻擊，螢幕左下角武器選單。
      本關可用金幣向第一到三階蟑螂取得罷免連署；軍師蟑到爆無法用金幣換取連署。
      達到罷免門檻可「罷免」蟑螂王，或用 200 金幣養貓擊殺蟑螂王直到牠倒下。
    </p>

    <!-- 玩家狀態 -->
    <section id="playerStatus" aria-label="玩家狀態">
      <div>勇者：<span id="playerName">---</span></div>
      <div>血量：<span id="playerHP">---</span></div>
      <div>金幣：<span id="playerCoins">---</span></div>
      <div class="ps-recall">罷免票：<span id="recallVotes">0</span> / <span id="recallNeed">10</span></div>
      <div><span id="weaponStatus">---</span></div>
      <div id="srStatus" aria-live="polite" aria-atomic="true" role="status" class="sr-only"></div>
    </section>

    <!-- 遊戲場地（10×10，ModeGrid 設定） -->
    <div id="gameArea" role="group" aria-describedby="a11yHelp"
         aria-label="廚房飯廳戰鬥區：10乘10 格狀區域" tabindex="0"></div>

    <div id="message" aria-live="assertive"></div>

    <!-- 播音用 audio -->
    <audio id="voicePlayer" src="" hidden></audio>
  </main>

  <!-- 手機：武器浮動按鈕 + 子選單（桌機用鍵盤數字鍵） -->
  <button id="weaponToggle" aria-label="武器選單">⚔️</button>
  <div id="weaponMenu" role="menu" aria-label="武器選單">
    <button role="menuitem"
        id="btnModeToggle"
        aria-keyshortcuts="Shift+M"
        title="切換視覺/純聽覺模式（等同 Shift+M）">
      👁️ 切換模式
    </button>

    <button data-wpn="fire"    aria-keyshortcuts="1">1️⃣ 噴火槍</button>
    <button data-wpn="spray"   aria-keyshortcuts="2">2️⃣ 香氛噴霧</button>
    <button data-wpn="slipper" aria-keyshortcuts="3">3️⃣ 藍白拖</button>
    <button data-wpn="bait"    aria-keyshortcuts="4">4️⃣ 毒餌</button>
    <button data-wpn="cat"     aria-keyshortcuts="5">5️⃣ 養貓</button>
    <button data-wpn="vote"    aria-keyshortcuts="6">6️⃣ 連署</button>
    <button data-wpn="recall"  aria-keyshortcuts="7" id="btnRecallMenu">7️⃣ 罷免</button>
  </div>

  <!-- 關卡 BGM -->
  <audio id="bgm" src="assets/sounds/game_05.mp3" loop preload="auto"></audio>
  <script>
    AudioFX.init();
    AudioFX.register(document.getElementById('bgm'));
    window.addEventListener('game-ready', () => { try{ AudioFX.ensure(); }catch(_){} });
  </script>

  <!-- NEW L5：貓咪對話框（保留你原本結構與行為） -->
  <div id="catDialog" class="sr-only" hidden aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="catTitle" aria-describedby="catDesc">
    <div id="catPanel" style="position:fixed; inset:10% 15%; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.4); padding:1rem; overflow:auto;">
      <h2 id="catTitle">養貓：選擇你的戰貓（每隻 200 金幣）</h2>
      <p id="catDesc">選一隻貓咪加入你的隊伍，養貓成功後會成為針對蟑螂王的有效武器。可用 Tab 瀏覽，Enter 按下「領養」。按 Esc 可關閉。</p>
      <div id="catGrid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
        <!-- 你的 5 隻貓卡片（原樣保留） -->
        <div class="catCard" tabindex="0" data-cat="cat_01" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_01.png" alt="白貓 北下閜" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">白貓 北下閜（Pe̍h-siak-siak）</h3>
          <p style="margin:0 0 .5rem;">反應快、守門神。</p>
          <button onclick="adoptCat('cat_01')">領養 200💰</button>
        </div>
        <div class="catCard" tabindex="0" data-cat="cat_02" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_02.png" alt="虎斑 阿后" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">虎斑 阿后（A-hó）</h3>
          <p style="margin:0 0 .5rem;">力氣大、壓制王。</p>
          <button onclick="adoptCat('cat_02')">領養 200💰</button>
        </div>
        <div class="catCard" tabindex="0" data-cat="cat_03" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_03.png" alt="黑貓 歐罵瑪" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">黑貓 歐罵瑪（O͘-mà-mà）</h3>
          <p style="margin:0 0 .5rem;">冷靜、偷襲高手。</p>
          <button onclick="adoptCat('cat_03')">領養 200💰</button>
        </div>
        <div class="catCard" tabindex="0" data-cat="cat_04" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_04.png" alt="三花貓 五告揮" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">三花貓 五告揮（Ū-kàu Hoe）</h3>
          <p style="margin:0 0 .5rem;">敏捷、連擊快。</p>
          <button onclick="adoptCat('cat_04')">領養 200💰</button>
        </div>
        <div class="catCard" tabindex="0" data-cat="cat_05" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_05.png" alt="麒麟尾暹邏貓 帕嘎抓" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">麒麟尾暹邏貓 帕嘎抓（Phah Ka-choa̍h）</h3>
          <p style="margin:0 0 .5rem;">深不可測、殺氣騰騰。</p>
          <button onclick="adoptCat('cat_05')">領養 200💰</button>
        </div>
      </div>
      <div class="dialog-actions" style="margin-top:1rem; text-align:right;">
        <button class="dialog-close" id="catCloseBtn" type="button" onclick="closeCatPicker()">關閉</button>
      </div>
    </div>
  </div>

  <!-- BGM 解鎖已在上面 -->
  <script>document.addEventListener('DOMContentLoaded',()=>document.body.classList.add('ready'));</script>

  <!-- 內容與核心 -->
  <script src="js/content/bugs.js"></script>
  <script src="js/content/levels.js"></script>

  <script src="js/core/game-core.js"></script>
  <script src="js/core/mode-lane.js"></script>
  <script src="js/render/furniture.js"></script>
  <script src="js/core/mode-grid.js"></script>

  <script src="js/a11y/focus-hints.js"></script>
  <script src="js/a11y/announce-arbiter.js"></script>
  <script src="js/a11y/spawn-conductor.js"></script>

  <!-- 問答與 K4 對話（與第 4 關相同順序） -->
  <script src="js/core/quiz.js"></script>
  <script>
    window.quiz = new window.QuizEngine({
      dataUrl: 'assets/questions/questions_k4.json',
      voiceLang: 'zh-TW',
      enableTTS: true,
      readChoicesOnOpen: true,
      speakOnSelect: true
    });
    document.addEventListener('game-ready', async () => {
      try { await window.quiz.load(); } catch(e){ console.warn('[k5] quiz.load 失敗', e); }
    });
  </script>
  <script src="js/core/k4_dialog.js"></script>
  <script>
  // ★ 把 k4 對話與測驗處理綁到遊戲實例
  document.addEventListener('game-ready', (e) => {
    const game = e.detail?.game || window.game;
    if (!game) return;
    if (typeof window.bindK4Trigger === 'function')    window.bindK4Trigger(game);
    if (typeof window.bindQuizHandlers === 'function') window.bindQuizHandlers(game);
  });

  // 測驗視窗開啟時暫停輸入、關閉時恢復（保險再掛一次）
  window.addEventListener('quiz-open',  () => { window.gameActive = false; });
  window.addEventListener('quiz-close', () => { window.gameActive = true;  });
  </script>

  <script src="js/core/retry.js"></script>
  <script> Retry.rememberLevel(); </script>

  <script src="js/core/keys.js"></script>

      <!-- SR 專用控制疊層（VoiceOver/TalkBack） -->
  <div id="srControlOverlay" aria-hidden="false" aria-label="觸控控制面板">
    <div id="srDpad" class="pad" role="group" aria-label="方向操作">
      <span class="empty" aria-hidden="true"></span>
      <button type="button" data-key="ArrowUp"    aria-label="向上">↑</button>
      <span class="empty" aria-hidden="true"></span>

      <button type="button" data-key="ArrowLeft"  aria-label="向左">←</button>
      <span class="empty" aria-hidden="true"></span>
      <button type="button" data-key="ArrowRight" aria-label="向右">→</button>

      <span class="empty" aria-hidden="true"></span>
      <button type="button" data-key="ArrowDown"  aria-label="向下">↓</button>
      <span class="empty" aria-hidden="true"></span>
    </div>

    <div id="srEnter" class="pad" role="group" aria-label="確認動作">
      <button type="button" data-key="Enter" aria-label="確認">ENTER</button>
    </div>
  </div>

  <button id="srAttackFull" aria-label="攻擊（全畫面雙擊）" title="攻擊（全畫面雙擊）"></button>

  <!-- 鍵盤初始化 -->
  <script>
    document.addEventListener('game-ready', () => {
      const stage = document.getElementById('gameArea');
      Keys.init({
        stageEl: stage,
        scanFn: () => window.scanArea?.(),
        activeGuardFn: () => window.gameActive !== false
      });
    }, { once:true });
  </script>

  <script>
  (function(){
    // === 直接呼叫你的動作 API ===
    function act(key){
      switch(key){
        case 'ArrowLeft':  return window.moveLeft?.();
        case 'ArrowRight': return window.moveRight?.();
        case 'ArrowUp':    return window.moveUp?.();
        case 'ArrowDown':  return window.moveDown?.();
        case 'Enter':      return window.attack?.();
        case 'Scan':       return window.scanArea?.();
      }
    }

    // ===== 全螢幕手勢：滑動=移動；單擊=掃描；雙擊=攻擊 =====
    const G = {
      active:false, startX:0, startY:0,
      lastTapTime:0, lastTapX:0, lastTapY:0,
      singleTapTimer:null,
      threshold:24, edge:10, dblTime:280, dblDist:24
    };

    function isInSafeArea(x,y){ const w=innerWidth,h=innerHeight,e=G.edge; return (x>e && x<w-e && y>e && y<h-e); }
    function isInteractiveTarget(el){
      return !!el.closest?.(
        '#catDialog:not([hidden]), #weaponMenu,'+
        'button, a, input, select, textarea,'+
        '[role="button"], [role="dialog"], [aria-haspopup]'
      );
    }

    function onTouchStart(e){
      const t=e.changedTouches?.[0]; if(!t) return;
      if (e.touches?.length>1) return;
      if (!isInSafeArea(t.clientX,t.clientY)) return;
      if (isInteractiveTarget(e.target)) return;
      if (window.gameActive===false) return;
      G.active=true; G.startX=t.clientX; G.startY=t.clientY;
    }
    function onTouchEnd(e){
      const t=e.changedTouches?.[0]; if(!t) return;
      const dx=t.clientX-G.startX, dy=t.clientY-G.startY;
      const ax=Math.abs(dx), ay=Math.abs(dy);
      if (G.active && (ax>=G.threshold || ay>=G.threshold)){
        G.active=false;
        if (ax>ay) act(dx>0?'ArrowRight':'ArrowLeft');
        else       act(dy>0?'ArrowDown' :'ArrowUp');
        clearSingleTap(); return;
      }
      handleTap(t); G.active=false;
    }
    function handleTap(t){
      const now=performance.now();
      const dt=now-G.lastTapTime;
      const dd=Math.max(Math.abs(t.clientX-G.lastTapX), Math.abs(t.clientY-G.lastTapY));
      G.lastTapTime=now; G.lastTapX=t.clientX; G.lastTapY=t.clientY;
      if (dt<=G.dblTime && dd<=G.dblDist){
        clearSingleTap(); act('Enter'); G.lastTapTime=0; return;
      }
      clearSingleTap();
      G.singleTapTimer=setTimeout(()=>{ act('Scan'); G.singleTapTimer=null; }, G.dblTime+10);
    }
    function clearSingleTap(){ if (G.singleTapTimer){ clearTimeout(G.singleTapTimer); G.singleTapTimer=null; } }

    const supportsTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints>0) || matchMedia('(pointer:coarse)').matches;
    if (supportsTouch){
      document.addEventListener('touchstart', onTouchStart, { passive:true });
      document.addEventListener('touchend',   onTouchEnd,   { passive:true });
    }

    // ===== SR 控制面板（D-pad/Enter）配線（可選開啟） =====
    const dpad     = document.getElementById('srDpad');
    const enterPad = document.getElementById('srEnter');

    (function wireSrPad(){
      const hook = (root)=> root?.addEventListener('click', (e)=>{
        const btn=e.target.closest('button[data-key]'); if(!btn) return;
        act(btn.getAttribute('data-key'));
      });
      hook(dpad); hook(enterPad);
    })();

    // 顯示/隱藏面板 API（不再依賴 srToggle）
    function showOverlay(){
      document.body.classList.add('show-sr-overlay');
      document.querySelector('#srEnter button')?.focus({ preventScroll:true });
      setTimeout(()=>{ document.getElementById('srAttackFull')?.focus({ preventScroll:true }); }, 30);
    }
    function hideOverlay(){
      document.body.classList.remove('show-sr-overlay');
    }

    // ===== 永遠給 SR 雙擊一個焦點目標（全畫面攻擊） =====
    const fullBtn = document.getElementById('srAttackFull');
    fullBtn.addEventListener('click', ()=> act('Enter'));
    fullBtn.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); act('Enter'); } });

    function uiBlocking(){
      const catOpen  = !!document.querySelector('#catDialog:not([hidden]):not(.sr-only)');
      const menu     = document.getElementById('weaponMenu');
      const menuOpen = !!menu && getComputedStyle(menu).display!=='none';
      const quizBusy = document.body.classList.contains('quiz-open');
      const a=document.activeElement, inForm=a && /^(INPUT|SELECT|TEXTAREA)$/.test(a.tagName);
      return catOpen || menuOpen || quizBusy || inForm;
    }
    function ensureFullAttackFocus(){
      if (uiBlocking()) return;
      if (document.activeElement !== fullBtn) fullBtn.focus({ preventScroll:true });
    }
    setInterval(ensureFullAttackFocus, 1200);

    window.addEventListener('quiz-open',  ()=> document.body.classList.add('quiz-open'));
    window.addEventListener('quiz-close', ()=> { document.body.classList.remove('quiz-open'); setTimeout(ensureFullAttackFocus,80); });
    window.addEventListener('cat-open',   ()=> {});
    window.addEventListener('cat-close',  ()=> setTimeout(ensureFullAttackFocus,80));
    document.addEventListener('click',    ()=> setTimeout(ensureFullAttackFocus,120));
    document.addEventListener('DOMContentLoaded', ()=> setTimeout(ensureFullAttackFocus,200));

    // 3-A：桌機測試熱鍵（Shift+O）
    document.addEventListener('keydown', (e)=>{
      if (e.shiftKey && (e.key==='O' || e.key==='o')){
        if (document.body.classList.contains('show-sr-overlay')) hideOverlay();
        else showOverlay();
      }
    });

    // 3-B：SR 專用隱藏按鈕（你已放在 HTML 了）
    document.getElementById('srOverlayOpener')?.addEventListener('click', ()=> showOverlay());
  })();
  </script>

  <!-- A11Y 初始化（含 Quiz 忙碌偵測） -->
  <script>
  document.addEventListener('game-ready', () => {
    const stageEl = document.getElementById('gameArea');
    window.__focusHints = A11YFocusHints.install({
      stageEl,
      hintText: '提示：已進入遊戲。NVDA 使用者請按 NVDA 加 空白 切換到焦點模式，再用方向鍵操作。'
    });
    window.__arb = A11YArbiter.install({
      hpEl:   document.getElementById('playerHP'),
      coinEl: document.getElementById('playerCoins'),
      wpnEl:  document.getElementById('weaponStatus'),
      srEl:   document.getElementById('srStatus'),
      ttsBusyFn: () => (Core?._speechDepth>0) || (speechSynthesis?.speaking)
    });
    window.__sc = SpawnConductor.install({
      srEl: document.getElementById('srStatus'),
      ttsBusyFn: () => (Core?._speechDepth>0) || (speechSynthesis?.speaking)
    });
  });
  window.addEventListener('quiz-open',  () => { window.gameActive = false; });
  window.addEventListener('quiz-close', () => { window.gameActive = true;  });
  window.addEventListener('beforeunload', () => { try{ window.__focusHints?.destroy(); }catch(_){} });
  </script>

  <!-- 勇者名稱貼圖補丁（維持「角色名．暱稱」顯示） -->
  <script>
  ;(() => {
    "use strict";
    const roleMap = {
      "kinbah.png": "金巴","mailah.png": "麥拉","khaupe.png": "考盃","holah.png": "赫拉",
      "chinaikhun.png": "金．艾捆","chiaulaipeh.png": "郊．萊北","mienphapan.png": "綿葩．坂","hamchuniok.png": "罕族．拗"
    };
    const fileKey = (p)=> (String(p||'').split('#')[0].split('?')[0].split('/').pop()||'').toLowerCase();
    function readHero(){
      let p={}; try{ p=JSON.parse(localStorage.getItem("bugSlayerPlayer")||"{}"); }catch(_){}
      const name=p?.name||"無名勇者", avatarPath=p?.avatar||"", roleName=roleMap[fileKey(avatarPath)]||"未知勇者";
      return { name, roleName, avatarPath };
    }
    function initHeroUI(){
      const { name, roleName, avatarPath } = readHero();
      const elName = document.getElementById("playerName");
      if (elName) elName.textContent = `${roleName}．${name}`;
      let sticker = document.getElementById("heroSticker");
      if (!sticker) {
        sticker = document.createElement("img");
        sticker.id = "heroSticker";
        sticker.className = "hero-sticker";
        sticker.alt = ""; sticker.setAttribute("aria-hidden","true");
        document.body.appendChild(sticker);
      }
      sticker.style.display = avatarPath ? "" : "none";
      if (avatarPath) sticker.src = avatarPath;
    }
    function patchUpdateUI(){
      if (!window.Core || typeof Core.updateUI !== "function") return false;
      if (Core.__patchedHeroName) return true;
      const orig = Core.updateUI.bind(Core);
      Core.updateUI = function(){
        orig();
        const { name, roleName } = readHero();
        const elName = document.getElementById("playerName");
        if (elName) elName.textContent = `${roleName}．${name}`;
      };
      Core.__patchedHeroName = true; return true;
    }
    function ensurePatched(){
      if (patchUpdateUI()) return;
      const t0=Date.now(), timer=setInterval(()=>{ if (patchUpdateUI() || Date.now()-t0>5000) clearInterval(timer); },120);
    }
    document.addEventListener("DOMContentLoaded", initHeroUI);
    document.addEventListener("game-ready", () => { initHeroUI(); ensurePatched(); }, { once:true });
    window.addEventListener("load", ensurePatched, { once:true });
  })();
  </script>

  <script type="module" src="./js/core/input-adapter.js"></script>

  <!-- 啟動腳本（第 5 關） -->
  <script src="js/boot/game_l5.js"></script>

  <!-- 模式切換（Shift+M） -->
  <script>
    Modes.applyModeOnLoad();
    Modes.bindQuickToggle();
  </script>

  <!-- 手機：武器浮動選單控制 -->
  <script>
  (function(){
    const toggle = document.getElementById('weaponToggle');
    const menu   = document.getElementById('weaponMenu');
    if (!toggle || !menu) return;

    let open = false;
    const show = ()=>{ menu.style.display='flex'; toggle.setAttribute('aria-expanded','true'); open=true; };
    const hide = ()=>{ menu.style.display='none';  toggle.setAttribute('aria-expanded','false'); open=false; };
    const toggleMenu = ()=>{ open ? hide() : show(); };

    toggle.addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); });

    // 點外面自動收起
    document.addEventListener('click', (e)=>{
      if (open && !menu.contains(e.target) && e.target!==toggle){ hide(); }
    });

    // 點子按鈕 → 換武器
    menu.addEventListener('click',(e)=>{
      const btn=e.target.closest('button[data-wpn]');
      if(!btn || btn.disabled) return;
      window.changeWeapon?.(btn.dataset.wpn);
      hide();
    });

    // 第一關啟用 1~3
    ['fire','spray','slipper'].forEach(id=>{
      menu.querySelector(`button[data-wpn="${id}"]`)?.removeAttribute('disabled');
    });
  })();

    (function(){
      const btn = document.getElementById('btnModeToggle');
      const menu = document.getElementById('weaponMenu');
      const toggle = document.getElementById('weaponToggle');

      function closeMenu(){
        if (!menu) return;
        menu.style.display = 'none';
        toggle?.setAttribute('aria-expanded','false');
      }

      btn?.addEventListener('click', ()=>{
        // 派送與桌機相同的快捷鍵：Shift+M
        const ev = new KeyboardEvent('keydown', {
          key: 'M',
          shiftKey: true,
          bubbles: true,
          cancelable: true
        });
        document.dispatchEvent(ev);

        // 關掉選單、回到遊戲
        closeMenu();

        // 小延遲把焦點補回全畫面攻擊鈕，維持「雙擊=攻擊」的一致體驗
        setTimeout(()=> document.getElementById('srAttackFull')?.focus({ preventScroll:true }), 50);
      });
    })();

    (function(){
      const toggle = document.getElementById('weaponToggle');
      if (!toggle) return;

      let pressTimer = null;
      const HOLD_MS = 700;

      function fireToggleMode(){
        const ev = new KeyboardEvent('keydown', { key:'M', shiftKey:true, bubbles:true, cancelable:true });
        document.dispatchEvent(ev);
        setTimeout(()=> document.getElementById('srAttackFull')?.focus({ preventScroll:true }), 50);
      }

      toggle.addEventListener('touchstart', ()=>{ pressTimer = setTimeout(fireToggleMode, HOLD_MS); }, { passive:true });
      toggle.addEventListener('touchend',   ()=>{ clearTimeout(pressTimer); pressTimer=null; }, { passive:true });
      toggle.addEventListener('touchmove',  ()=>{ clearTimeout(pressTimer); pressTimer=null; }, { passive:true });
      // 也支援滑鼠長按（桌機測試用）
      toggle.addEventListener('mousedown',  ()=>{ pressTimer = setTimeout(fireToggleMode, HOLD_MS); });
      toggle.addEventListener('mouseup',    ()=>{ clearTimeout(pressTimer); pressTimer=null; });
      toggle.addEventListener('mouseleave', ()=>{ clearTimeout(pressTimer); pressTimer=null; });
    })();
  </script>

  <!-- SR 噪音門（沿用前關設定） -->
  <script>
  (function (w) {
    const Q = sel => Array.from(document.querySelectorAll(sel));
    const LIVE = ['#srStatus','#message','[role="status"][aria-live]','[aria-live="polite"]','[aria-live="assertive"]'];
    const orig = new WeakMap();
    const getNodes = () => Array.from(new Set(LIVE.flatMap(s => Q(s))));
    function mute(){ getNodes().forEach(n=>{ if(!orig.has(n)) orig.set(n, n.getAttribute('aria-live')||''); n.setAttribute('aria-live','off'); }); document.body.setAttribute('aria-busy','true'); }
    function unmute(){ getNodes().forEach(n=>{ const v=orig.get(n); if(v===null||v==='') n.removeAttribute('aria-live'); else n.setAttribute('aria-live',v); }); document.body.removeAttribute('aria-busy'); }
    const busy = ()=> !!(w.Core && Core._speechDepth>0) || !!(w.speechSynthesis && speechSynthesis.speaking);
    (function watch(){ let m=false; setInterval(()=>{ const b=busy(); if(b && !m){ mute(); m=true; } else if(!b && m){ unmute(); m=false; } }, 120); })();
    w.addEventListener?.('quiz-open',  mute);
    w.addEventListener?.('quiz-close', unmute);
    w.addEventListener?.('beforeunload', unmute);
  })(window);
  </script>

  <script>
  /* HeroSticker 自適應：避免遮到 #gameArea */
  (function () {
    const ST_ID = 'heroSticker';
    const STAGE_ID = 'gameArea';

    function byId(id){ return document.getElementById(id); }

    function overlapRatio(a, b){
      const x1 = Math.max(a.left, b.left);
      const y1 = Math.max(a.top,  b.top);
      const x2 = Math.min(a.right,b.right);
      const y2 = Math.min(a.bottom,b.bottom);
      const w = Math.max(0, x2 - x1);
      const h = Math.max(0, y2 - y1);
      const inter = w * h;
      const areaA = (a.width || (a.right - a.left)) * (a.height || (a.bottom - a.top)) || 1;
      return inter / areaA;  // 以貼紙面積為基準
    }

    function adjustSticker(){
      const st = byId(ST_ID), stage = byId(STAGE_ID);
      if (!st || !stage) return;

      // 清掉舊狀態重新評估
      st.classList.remove('is-shy','is-tiny','is-hidden');
      st.removeAttribute('aria-hidden');

      const stRect = st.getBoundingClientRect();
      const gdRect = stage.getBoundingClientRect();
      const r = overlapRatio(stRect, gdRect);

      // 判斷門檻：> 3% 視為有遮擋（邊角碰到）
      if (r > 0.03){
        st.classList.add('is-shy');
        // 再量一次（縮放後下一幀）
        requestAnimationFrame(() => {
          const r2 = overlapRatio(st.getBoundingClientRect(), stage.getBoundingClientRect());
          if (r2 > 0.02){
            st.classList.remove('is-shy');
            st.classList.add('is-tiny');
            requestAnimationFrame(() => {
              const r3 = overlapRatio(st.getBoundingClientRect(), stage.getBoundingClientRect());
              if (r3 > 0.015){
                st.classList.remove('is-tiny');
                st.classList.add('is-hidden');
                st.setAttribute('aria-hidden','true');
              }
            });
          }
        });
      }
    }

    // 觀察舞台尺寸與可視區變化
    function installObservers(){
      const st = byId(ST_ID), stage = byId(STAGE_ID);
      if (!stage) return;

      // 1) 版面改變（旋轉、軟鍵盤、位址列收合）
      if (window.visualViewport){
        visualViewport.addEventListener('resize', adjustSticker);
        visualViewport.addEventListener('scroll', adjustSticker);
      }
      window.addEventListener('resize', adjustSticker);
      window.addEventListener('orientationchange', adjustSticker);

      // 2) #gameArea 由 ModeGrid 變更為 grid/改尺寸
      try{
        const ro = new ResizeObserver(adjustSticker);
        ro.observe(stage);
      }catch(_){ /* 某些舊瀏覽器沒有 ResizeObserver */ }

      // 3) 初始與遊戲就緒後再跑一次（避免開場 TTS 前/後 layout 差異）
      adjustSticker();
      document.addEventListener('DOMContentLoaded', adjustSticker);
      window.addEventListener('load', adjustSticker);
      document.addEventListener('game-ready', () => setTimeout(adjustSticker, 80), { once:false });
    }

    // 延遲到下一輪，確保 DOM 都在（貼紙通常是 runtime 加進來）
    setTimeout(installObservers, 0);
  })();
  </script>

  <!-- 養貓 Dialog 的 A11Y 捕獲（保留你原本的行為） -->
  <script>
  (function () {
    const dialog = document.getElementById('catDialog');
    const panel  = document.getElementById('catPanel');
    if (!dialog || !panel) return;
    dialog.classList.add('sr-only'); dialog.setAttribute('hidden',''); dialog.setAttribute('aria-hidden','true');

    const capture = (e) => {
      const keys = ["Enter","Escape","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"," "];
      if (!keys.includes(e.key)) return;
      e.preventDefault(); e.stopPropagation();
      if (e.key === "Escape") { closeCatPicker?.(); return; }
      const el = document.activeElement;
      const isBtn = (el?.tagName === 'BUTTON') || (el?.getAttribute?.('role') === 'button');
      if (e.key === ' ' && isBtn) { el.click?.(); return; }
      if (e.key === 'Enter') {
        if (el?.classList?.contains('dialog-close')) { closeCatPicker?.(); return; }
        if (el?.classList?.contains('catCard')) { el.querySelector('button')?.click(); return; }
        if (isBtn) { el.click?.(); return; }
      }
      const grid = document.getElementById('catGrid'); if (!grid) return;
      const cards = Array.from(grid.querySelectorAll('.catCard')); if (!cards.length) return;
      const idx = cards.indexOf(document.activeElement); if (idx < 0) return;
      const cardW = cards[0].getBoundingClientRect().width || 200;
      const cols  = Math.max(1, Math.round(grid.clientWidth / cardW)) || 4;
      let next=null;
      if (e.key === 'ArrowRight') next = cards[Math.min(cards.length-1, idx+1)];
      if (e.key === 'ArrowLeft')  next = cards[Math.max(0, idx-1)];
      if (e.key === 'ArrowDown')  next = cards[Math.min(cards.length-1, idx+cols)];
      if (e.key === 'ArrowUp')    next = cards[Math.max(0, idx-cols)];
      next?.focus();
    };

    const isVisible = (el)=>{
      if (!el) return false;
      if (el.hasAttribute('hidden') || el.getAttribute('aria-hidden')==='true') return false;
      if (el.classList.contains('sr-only')) return false;
      const cs = getComputedStyle(el);
      return !(cs.display==='none' || cs.visibility==='hidden' || cs.opacity==='0');
    };
    const focusFirst = ()=>{
      const first = document.querySelector('#catGrid .catCard');
      (first || panel).focus();
    };

    // === NEW: 鎖/解 背景捲動，並在開啟時做一次捲動校正（手機） ===
    function lockScroll(){ document.body.classList.add('lock-scroll'); }
    function unlockScroll(){ document.body.classList.remove('lock-scroll'); }
    function ensureVisibleSoon(){
      // 等下一個 frame，確保 layout 完成後把面板捲到最上方
      requestAnimationFrame(()=>{ panel.scrollTop = 0; });
    }

    const mo = new MutationObserver(()=>{
      if (isVisible(dialog)) {
        setTimeout(()=>{
          focusFirst();
          dialog.addEventListener('keydown', capture, true);
          lockScroll();
          ensureVisibleSoon();
        }, 0);
      } else {
        dialog.removeEventListener('keydown', capture, true);
        unlockScroll();
      }
    });
    mo.observe(dialog, { attributes:true, attributeFilter:['class','hidden','aria-hidden','style'] });

    // 保留你原本的 Enter 開啟條件
    document.addEventListener('keydown', (e)=>{
      if (e.key!=='Enter' || isVisible(dialog)) return;
      const G = window.game; if (!G) return;
      if (G.state?.weapon==='cat' && !G.state?.catOwned) { openCatPicker?.(); e.preventDefault(); }
    });
  })();
  </script>
  <script type="module">
    import { mountDesktopKeymap } from "./js/core/input-desktop.js";
    const unbind = mountDesktopKeymap(document);
  </script>
</body>
</html>
