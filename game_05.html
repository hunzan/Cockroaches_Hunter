<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />

  <title>ç¬¬ 5 é—œï¼šå»šæˆ¿é£¯å»³ï¼ˆ10Ã—10ï¼‰ - é€²æ“Šçš„èŸ‘è‚</title>
  <link rel="stylesheet" href="style.css" />
  <script src="js/core/modes.js"></script>
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>

  <style>
    html, body { min-height: 100svh; }
    body{
      margin:0; padding:0;
      background:url("assets/images/game_bg3.png") no-repeat center center fixed;
      background-size:cover;
      font-family:sans-serif;
      color:#111;
      opacity:0; transition:opacity .6s ease;
    }
    body.ready{ opacity:1; }

    main {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    h1{ text-align:center; color:#fff; text-shadow:0 2px 8px rgba(0,0,0,.45); margin:.5rem 0 .25rem; }

    /* tile å¡«æ»¿æ¯å€‹ grid cellï¼Œé›»è…¦/æ‰‹æ©Ÿä¸€è‡´ */
    .tile{
      width:100%; height:100%;
      box-sizing:border-box;              /* â† é—œéµï¼šé‚Šæ¡†ç®—é€²æ ¼å…§ï¼Œå°±ä¸æœƒæŠŠèˆå°æ’å¯¬ */
      display:flex; align-items:center; justify-content:center;
      font-size:1.05rem;
      border:2px solid #333; border-radius:8px;
      text-align:center;
      background:rgba(238,238,238,0.6);  /* â† åŠé€æ˜ç°è‰² */
      user-select:none;
    }
    .tile.player{ background:#cce5ff; }
    .tile.bug{ background:#f8d7da; }
    .tile.hazard{ box-shadow: inset 0 0 0 3px rgba(255,255,255,.2); }

    /* è¡Œå‹•è£ç½®ï¼šè®“æ¯æ ¼æ›´ç·Šæ¹Šï¼Œä¸è¶…å‡ºè¢å¹• */
    @media (pointer:coarse){
      .tile{
        border-width:1px;                 /* é‚Šæ¡†æ›´è–„ï¼Œè¦–è¦ºå¯†åº¦æ›´å¥½ */
        border-radius:6px;
        font-size:.95rem;                 /* å­—ç¨å¾®ç¸®ä¸€é» */
      }
    }

    /* èˆå°å®¹å™¨æœ¬èº«ä¸å†ç”¨ max-width å¡ä½ï¼Œäº¤ç”± JS è¨­å®šç²¾ç¢º px */
    #gameArea{
      margin: auto;   /* æ°´å¹³+å‚ç›´ç½®ä¸­ */
      outline:none;
      touch-action:none;
      -webkit-tap-highlight-color:transparent;
    }

    #message{
      margin-top:.6rem; font-weight:bold; text-align:center;
      color:#fff; text-shadow:0 2px 8px rgba(0,0,0,.45);
      min-height:1.2em;
    }

    /* SR-only */
    .sr-only{
      position:absolute!important; width:1px; height:1px;
      padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0);
      white-space:nowrap; border:0;
    }

  /* åŸºç¤é€ å‹ï¼ˆä½ ç¾æœ‰çš„å¯ä¿ç•™ï¼‰ */
  .hero-sticker{
    position:fixed; right:12px; bottom:calc(12px + env(safe-area-inset-bottom));
    width:min(21vw,160px); max-width:200px; height:auto;
    opacity:.95; pointer-events:none;
    filter:drop-shadow(0 6px 18px rgba(0,0,0,.45));
    z-index:10;
    transition: transform .18s ease, opacity .18s ease, width .18s ease;
  }

  /* æ‰‹æ©Ÿé è¨­ç•¥ç¸®ï¼Œå…ˆé¨°ä¸€é»ç©ºé–“ */
  @media (pointer:coarse){
    .hero-sticker{ width:min(22vw,140px); }
  }

  /* åµæ¸¬åˆ°ç¢°æ’æ™‚ï¼Œç”¨ class åšæ›´ç©æ¥µçš„è™•ç½® */
  .hero-sticker.is-shy     { transform: scale(.88); opacity:.92; }
  .hero-sticker.is-tiny    { transform: scale(.78); opacity:.90; }
  .hero-sticker.is-hidden  { opacity:0; visibility:hidden; }

    /* ç©å®¶ç‹€æ…‹ï¼ˆæ¡Œæ©Ÿï¼‰ */
    #playerStatus{
      margin:.4rem auto 0; padding:.5rem .75rem; max-width:960px;
      background:rgba(255,255,255,.15);
      border-radius:10px; color:#fff;
      text-shadow:0 2px 8px rgba(0,0,0,.45);
    }

    /* è¡Œå‹•ç‰ˆï¼šç¸®æ¨™é¡Œã€ç‹€æ…‹è† å›Š */
    @media (pointer:coarse){
      h1{ font-size:1.05rem; font-weight:600; margin:.25rem 0 .1rem; }
      #playerStatus{
        position:fixed; top:calc(8px + env(safe-area-inset-top)); left:8px; right:8px; z-index:18;
        display:flex; flex-wrap:wrap; gap:.25rem .6rem; align-items:center;
        padding:.35rem .6rem;
        background:rgba(0,0,0,.35);
        backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
        border-radius:12px;
        font-size:.9rem; line-height:1.2; color:#fff; text-shadow:0 1px 3px rgba(0,0,0,.35);
      }
      main{ padding-top:calc(2.6rem + env(safe-area-inset-top)); }
    }

    /* æ‰‹æ©Ÿï¼šå·¦ä¸‹æ­¦å™¨æµ®å‹•éˆ•ï¼‹å‚ç›´å­é¸å–® */
    #weaponToggle{
      position:fixed; left:12px; bottom:calc(12px + env(safe-area-inset-bottom));
      z-index:25;
      background:#ffd452; color:#222; border:none; border-radius:50%;
      width:52px; height:52px; font-size:1.25rem;
      box-shadow:0 3px 10px rgba(0,0,0,.3);
      display:none;
    }
    #weaponMenu{
      position:fixed; left:12px; bottom:calc(72px + env(safe-area-inset-bottom));
      display:none; flex-direction:column; gap:.35rem; z-index:26;
    }
    #weaponMenu button{
      background:#ffd452; color:#222; border:none; border-radius:10px;
      font-size:.9rem; padding:.42rem .55rem; min-width:68px;
      box-shadow:0 3px 8px rgba(0,0,0,.25);
    }
    #weaponMenu button:disabled{ opacity:.55; filter:saturate(.7); }
    #weaponToggle{ display:inline-flex; align-items:center; justify-content:center; }
    @media (pointer:fine){
    /* åªå½±éŸ¿æ»‘é¼ /æ¡Œæ©Ÿï¼Œä¸å‹•æ‰‹æ©Ÿ */
    #gameArea{
      max-width: min(96vmin, 960px);
      margin-left:auto; margin-right:auto;
      }
    }
    /* æ¡Œæ©Ÿç‰ˆï¼šé¡¯ç¤ºå‹‡è€…åœ–ç‰‡ */
    @media (pointer:fine) {
      .hero-sticker { display: block; }
    }
    /* æ‰‹æ©Ÿç‰ˆï¼šéš±è—å‹‡è€…åœ–ç‰‡ */
    @media (pointer:coarse) {
      .hero-sticker { display: none; }
    }
  </style>

</head>
<body class="stage5">
  <main>
    <h1>å»šæˆ¿é£¯å»³æ˜¯æœ€å¾Œçš„é˜²ç·š</h1>

    <p class="sr-only" id="a11yHelp">
      éµç›¤ï¼šä¸Šä¸‹å·¦å³ç§»å‹•ï¼›ç©ºç™½éµæƒæï¼›Enter æ”»æ“Šï¼›æ•¸å­— 1~3 åˆ‡æ›æ­¦å™¨ã€‚
      æ‰‹æ©Ÿè‹¥å·²é–‹å•Ÿè¢å¹•é–±è®€å™¨ï¼šäºŒæŒ‡æ»‘å‹•ç§»å‹•ï¼›å–®æŒ‡é›™æ“Šä»»æ„ä½ç½®æ”»æ“Šï¼Œè¢å¹•å·¦ä¸‹è§’æ­¦å™¨é¸å–®ã€‚
      æœ¬é—œå¯ç”¨é‡‘å¹£å‘ç¬¬ä¸€åˆ°ä¸‰éšèŸ‘è‚å–å¾—ç½·å…é€£ç½²ï¼›è»å¸«èŸ‘åˆ°çˆ†ç„¡æ³•ç”¨é‡‘å¹£æ›å–é€£ç½²ã€‚
      é”åˆ°ç½·å…é–€æª»å¯ã€Œç½·å…ã€èŸ‘è‚ç‹ï¼Œæˆ–ç”¨ 200 é‡‘å¹£é¤Šè²“æ“Šæ®ºèŸ‘è‚ç‹ç›´åˆ°ç‰ å€’ä¸‹ã€‚
    </p>

    <!-- ç©å®¶ç‹€æ…‹ -->
    <section id="playerStatus" aria-label="ç©å®¶ç‹€æ…‹">
      <div>å‹‡è€…ï¼š<span id="playerName">---</span></div>
      <div>è¡€é‡ï¼š<span id="playerHP">---</span></div>
      <div>é‡‘å¹£ï¼š<span id="playerCoins">---</span></div>
      <div class="ps-recall">ç½·å…ç¥¨ï¼š<span id="recallVotes">0</span> / <span id="recallNeed">10</span></div>
      <div><span id="weaponStatus">---</span></div>
      <div id="srStatus" aria-live="polite" aria-atomic="true" role="status" class="sr-only"></div>
    </section>

    <!-- éŠæˆ²å ´åœ°ï¼ˆ10Ã—10ï¼ŒModeGrid è¨­å®šï¼‰ -->
    <div id="gameArea" role="group" aria-describedby="a11yHelp"
         aria-label="å»šæˆ¿é£¯å»³æˆ°é¬¥å€ï¼š10ä¹˜10 æ ¼ç‹€å€åŸŸ" tabindex="0"></div>

    <div id="message" aria-live="assertive"></div>

    <!-- æ’­éŸ³ç”¨ audio -->
    <audio id="voicePlayer" src="" hidden></audio>
  </main>

  <!-- æ‰‹æ©Ÿï¼šæ­¦å™¨æµ®å‹•æŒ‰éˆ• + å­é¸å–®ï¼ˆæ¡Œæ©Ÿç”¨éµç›¤æ•¸å­—éµï¼‰ -->
  <button id="weaponToggle" aria-label="æ­¦å™¨é¸å–®">âš”ï¸</button>
  <div id="weaponMenu" role="menu" aria-label="æ­¦å™¨é¸å–®">
    <button data-wpn="fire"    aria-keyshortcuts="1">1ï¸âƒ£ å™´ç«æ§</button>
    <button data-wpn="spray"   aria-keyshortcuts="2">2ï¸âƒ£ é¦™æ°›å™´éœ§</button>
    <button data-wpn="slipper" aria-keyshortcuts="3">3ï¸âƒ£ è—ç™½æ‹–</button>
    <button data-wpn="bait"    aria-keyshortcuts="4">4ï¸âƒ£ æ¯’é¤Œ</button>
    <button data-wpn="cat"     aria-keyshortcuts="5">5ï¸âƒ£ é¤Šè²“</button>
    <button data-wpn="vote"    aria-keyshortcuts="6">6ï¸âƒ£ é€£ç½²</button>
    <button data-wpn="recall"  aria-keyshortcuts="7" id="btnRecallMenu">7ï¸âƒ£ ç½·å…</button>
  </div>

  <!-- é—œå¡ BGM -->
  <audio id="bgm" src="assets/sounds/game_05.mp3" loop preload="auto"></audio>
  <script>
    AudioFX.init();
    AudioFX.register(document.getElementById('bgm'));
    window.addEventListener('game-ready', () => { try{ AudioFX.ensure(); }catch(_){} });
  </script>

  <!-- NEW L5ï¼šè²“å’ªå°è©±æ¡†ï¼ˆä¿ç•™ä½ åŸæœ¬çµæ§‹èˆ‡è¡Œç‚ºï¼‰ -->
  <div id="catDialog" class="sr-only" hidden aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="catTitle" aria-describedby="catDesc">
    <div id="catPanel" style="position:fixed; inset:10% 15%; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.4); padding:1rem; overflow:auto;">
      <h2 id="catTitle">é¤Šè²“ï¼šé¸æ“‡ä½ çš„æˆ°è²“ï¼ˆæ¯éš» 200 é‡‘å¹£ï¼‰</h2>
      <p id="catDesc">é¸ä¸€éš»è²“å’ªåŠ å…¥ä½ çš„éšŠä¼ï¼Œé¤Šè²“æˆåŠŸå¾Œæœƒæˆç‚ºé‡å°èŸ‘è‚ç‹çš„æœ‰æ•ˆæ­¦å™¨ã€‚å¯ç”¨ Tab ç€è¦½ï¼ŒEnter æŒ‰ä¸‹ã€Œé ˜é¤Šã€ã€‚æŒ‰ Esc å¯é—œé–‰ã€‚</p>
      <div id="catGrid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
        <!-- ä½ çš„ 5 éš»è²“å¡ç‰‡ï¼ˆåŸæ¨£ä¿ç•™ï¼‰ -->
        <div class="catCard" tabindex="0" data-cat="cat_01" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_01.png" alt="ç™½è²“ åŒ—ä¸‹é–œ" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">ç™½è²“ åŒ—ä¸‹é–œï¼ˆPeÌh-siak-siakï¼‰</h3>
          <p style="margin:0 0 .5rem;">åæ‡‰å¿«ã€å®ˆé–€ç¥ã€‚</p>
          <button onclick="adoptCat('cat_01')">é ˜é¤Š 200ğŸ’°</button>
        </div>
        <div class="catCard" tabindex="0" data-cat="cat_02" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_02.png" alt="è™æ–‘ é˜¿å" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">è™æ–‘ é˜¿åï¼ˆA-hÃ³ï¼‰</h3>
          <p style="margin:0 0 .5rem;">åŠ›æ°£å¤§ã€å£“åˆ¶ç‹ã€‚</p>
          <button onclick="adoptCat('cat_02')">é ˜é¤Š 200ğŸ’°</button>
        </div>
        <div class="catCard" tabindex="0" data-cat="cat_03" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_03.png" alt="é»‘è²“ æ­ç½µç‘ª" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">é»‘è²“ æ­ç½µç‘ªï¼ˆOÍ˜-mÃ -mÃ ï¼‰</h3>
          <p style="margin:0 0 .5rem;">å†·éœã€å·è¥²é«˜æ‰‹ã€‚</p>
          <button onclick="adoptCat('cat_03')">é ˜é¤Š 200ğŸ’°</button>
        </div>
        <div class="catCard" tabindex="0" data-cat="cat_04" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_04.png" alt="ä¸‰èŠ±è²“ äº”å‘Šæ®" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">ä¸‰èŠ±è²“ äº”å‘Šæ®ï¼ˆÅª-kÃ u Hoeï¼‰</h3>
          <p style="margin:0 0 .5rem;">æ•æ·ã€é€£æ“Šå¿«ã€‚</p>
          <button onclick="adoptCat('cat_04')">é ˜é¤Š 200ğŸ’°</button>
        </div>
        <div class="catCard" tabindex="0" data-cat="cat_05" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_05.png" alt="éº’éºŸå°¾æš¹é‚è²“ å¸•å˜æŠ“" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">éº’éºŸå°¾æš¹é‚è²“ å¸•å˜æŠ“ï¼ˆPhah Ka-choaÌhï¼‰</h3>
          <p style="margin:0 0 .5rem;">æ·±ä¸å¯æ¸¬ã€æ®ºæ°£é¨°é¨°ã€‚</p>
          <button onclick="adoptCat('cat_05')">é ˜é¤Š 200ğŸ’°</button>
        </div>
      </div>
      <div class="dialog-actions" style="margin-top:1rem; text-align:right;">
        <button class="dialog-close" id="catCloseBtn" type="button" onclick="closeCatPicker()">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- BGM è§£é–å·²åœ¨ä¸Šé¢ -->
  <script>document.addEventListener('DOMContentLoaded',()=>document.body.classList.add('ready'));</script>

  <!-- å…§å®¹èˆ‡æ ¸å¿ƒ -->
  <script src="js/content/bugs.js"></script>
  <script src="js/content/levels.js"></script>

  <script src="js/core/game-core.js"></script>
  <script src="js/core/mode-lane.js"></script>
  <script src="js/render/furniture.js"></script>
  <script src="js/core/mode-grid.js"></script>

  <script src="js/a11y/focus-hints.js"></script>
  <script src="js/a11y/announce-arbiter.js"></script>
  <script src="js/a11y/spawn-conductor.js"></script>

  <!-- å•ç­”èˆ‡ K4 å°è©±ï¼ˆèˆ‡ç¬¬ 4 é—œç›¸åŒé †åºï¼‰ -->
  <script src="js/core/quiz.js"></script>
  <script>
    window.quiz = new window.QuizEngine({
      dataUrl: 'assets/questions/questions_k4.json',
      voiceLang: 'zh-TW',
      enableTTS: true,
      readChoicesOnOpen: true,
      speakOnSelect: true
    });
    document.addEventListener('game-ready', async () => {
      try { await window.quiz.load(); } catch(e){ console.warn('[k5] quiz.load å¤±æ•—', e); }
    });
  </script>
  <script src="js/core/k4_dialog.js"></script>
  <script>
  // â˜… æŠŠ k4 å°è©±èˆ‡æ¸¬é©—è™•ç†ç¶åˆ°éŠæˆ²å¯¦ä¾‹
  document.addEventListener('game-ready', (e) => {
    const game = e.detail?.game || window.game;
    if (!game) return;
    if (typeof window.bindK4Trigger === 'function')    window.bindK4Trigger(game);
    if (typeof window.bindQuizHandlers === 'function') window.bindQuizHandlers(game);
  });

  // æ¸¬é©—è¦–çª—é–‹å•Ÿæ™‚æš«åœè¼¸å…¥ã€é—œé–‰æ™‚æ¢å¾©ï¼ˆä¿éšªå†æ›ä¸€æ¬¡ï¼‰
  window.addEventListener('quiz-open',  () => { window.gameActive = false; });
  window.addEventListener('quiz-close', () => { window.gameActive = true;  });
  </script>

  <script src="js/core/retry.js"></script>
  <script> Retry.rememberLevel(); </script>

  <script src="js/core/keys.js"></script>

      <!-- SR å°ˆç”¨æ§åˆ¶ç–Šå±¤ï¼ˆVoiceOver/TalkBackï¼‰ -->
  <div id="srControlOverlay" aria-hidden="false" aria-label="è§¸æ§æ§åˆ¶é¢æ¿">
    <div id="srDpad" class="pad" role="group" aria-label="æ–¹å‘æ“ä½œ">
      <span class="empty" aria-hidden="true"></span>
      <button type="button" data-key="ArrowUp"    aria-label="å‘ä¸Š">â†‘</button>
      <span class="empty" aria-hidden="true"></span>

      <button type="button" data-key="ArrowLeft"  aria-label="å‘å·¦">â†</button>
      <span class="empty" aria-hidden="true"></span>
      <button type="button" data-key="ArrowRight" aria-label="å‘å³">â†’</button>

      <span class="empty" aria-hidden="true"></span>
      <button type="button" data-key="ArrowDown"  aria-label="å‘ä¸‹">â†“</button>
      <span class="empty" aria-hidden="true"></span>
    </div>

    <div id="srEnter" class="pad" role="group" aria-label="ç¢ºèªå‹•ä½œ">
      <button type="button" data-key="Enter" aria-label="ç¢ºèª">ENTER</button>
    </div>
  </div>

  <button id="srToggle" type="button" aria-pressed="false" aria-label="åˆ‡æ›è§¸æ§æ§åˆ¶é¢æ¿">æ§åˆ¶ï¼šè‡ªå‹•</button>
  <button id="srAttackFull" aria-label="æ”»æ“Šï¼ˆå…¨ç•«é¢é›™æ“Šï¼‰" title="æ”»æ“Šï¼ˆå…¨ç•«é¢é›™æ“Šï¼‰"></button>

  <!-- éµç›¤åˆå§‹åŒ– -->
  <script>
    document.addEventListener('game-ready', () => {
      const stage = document.getElementById('gameArea');
      Keys.init({
        stageEl: stage,
        scanFn: () => window.scanArea?.(),
        activeGuardFn: () => window.gameActive !== false
      });
    }, { once:true });
  </script>

  <script>
(function(){
  // ç›´æ¥å‘¼å«ä½ çš„å‹•ä½œ APIï¼Œé¿å…éµç›¤äº‹ä»¶è·¯å¾‘ä¸ä¸€è‡´
  function act(key){
    switch(key){
      case 'ArrowLeft':  return window.moveLeft?.();
      case 'ArrowRight': return window.moveRight?.();
      case 'ArrowUp':    return window.moveUp?.();
      case 'ArrowDown':  return window.moveDown?.();
      case 'Enter':      return window.attack?.();
      case 'Scan':       return window.scanArea?.();
    }
  }

  // ===== å…¨è¢å¹•æ‰‹å‹¢åƒæ•¸ =====
  const G = {
    active:false, startX:0, startY:0,
    lastTapTime:0, lastTapX:0, lastTapY:0,
    singleTapTimer:null,
    threshold:24, edge:10, dblTime:280, dblDist:24
  };

  function isInSafeArea(x, y){
    const w = innerWidth, h = innerHeight, e = G.edge;
    return (x>e && x<w-e && y>e && y<h-e);
  }
  function isInteractiveTarget(el){
    return !!el.closest?.(
      '#catDialog:not([hidden]), #weaponMenu,'+
      'button, a, input, select, textarea,'+
      '[role="button"], [role="dialog"], [aria-haspopup]'
    );
  }

  function onTouchStart(e){
    const t = e.changedTouches?.[0]; if(!t) return;
    if (e.touches?.length > 1) return;                // å¤šæŒ‡å¿½ç•¥
    if (!isInSafeArea(t.clientX, t.clientY)) return;  // é‚Šç·£ä¿è­·
    if (isInteractiveTarget(e.target)) return;        // è®“ UI è‡ªå·±è™•ç†
    if (window.gameActive === false) return;

    G.active = true;
    G.startX = t.clientX;
    G.startY = t.clientY;
  }

  function onTouchEnd(e){
    const t = e.changedTouches?.[0]; if(!t) return;

    const dx = t.clientX - G.startX;
    const dy = t.clientY - G.startY;
    const ax = Math.abs(dx), ay = Math.abs(dy);

    // è‹¥æ˜¯æ»‘å‹•ï¼ˆè¶…éé–¾å€¼ï¼‰â†’ ç›´æ¥ç§»å‹•
    if (G.active && (ax >= G.threshold || ay >= G.threshold)){
      G.active = false;
      if (ax > ay) act(dx>0 ? 'ArrowRight' : 'ArrowLeft');
      else         act(dy>0 ? 'ArrowDown'  : 'ArrowUp');
      // æ»‘å‹•å°±ä¸åšé»æ“Šåˆ¤æ–·
      clearSingleTap();
      return;
    }

    // å¦å‰‡ç•¶ä½œã€Œé»æ“Šåºåˆ—ã€â†’ é›™æ“Š=æ”»æ“Šï¼Œå¦å‰‡å»¶é²è§¸ç™¼æƒæ
    handleTap(t);
    G.active = false;
  }

  function handleTap(t){
    const now = performance.now();
    const dt  = now - G.lastTapTime;
    const dd  = Math.max(Math.abs(t.clientX - G.lastTapX), Math.abs(t.clientY - G.lastTapY));

    // è¨˜éŒ„é€™æ¬¡é»æ“Š
    G.lastTapTime = now;
    G.lastTapX = t.clientX;
    G.lastTapY = t.clientY;

    // è‹¥åœ¨é›™æ“Šé–€æª»å…§ â†’ ç«‹åˆ»æ”»æ“Šï¼Œä¸¦å–æ¶ˆå–®æ“Šæƒæ
    if (dt <= G.dblTime && dd <= G.dblDist){
      clearSingleTap();
      act('Enter');        // é›™æ“Š = æ”»æ“Š
      G.lastTapTime = 0;   // é‡ç½®ï¼Œé¿å…ä¸‰é€£æ“Šèª¤åˆ¤
      return;
    }

    // å¦å‰‡å®‰æ’å–®æ“Š â†’ æƒæï¼ˆç­‰é›™æ“Šæ™‚é–“éäº†å†åŸ·è¡Œï¼‰
    clearSingleTap();
    G.singleTapTimer = setTimeout(()=>{
      act('Scan');         // å–®æ“Š = æƒæ
      G.singleTapTimer = null;
    }, G.dblTime + 10);
  }

  function clearSingleTap(){
    if (G.singleTapTimer){ clearTimeout(G.singleTapTimer); G.singleTapTimer = null; }
  }

  // âœ… æ›´ç©©çš„è§¸æ§åˆ¤æ–· + ç¶åœ¨ documentï¼ˆå…¨é æœ‰æ•ˆï¼‰
  const supportsTouch =
    ('ontouchstart' in window) ||
    (navigator.maxTouchPoints && navigator.maxTouchPoints > 0) ||
    matchMedia('(pointer:coarse)').matches;

  if (supportsTouch) {
    document.addEventListener('touchstart', onTouchStart, { passive:true });
    document.addEventListener('touchend',   onTouchEnd,   { passive:true });
  }

    // ===== 2) è¢å¹•é–±è®€å™¨æƒ…å¢ƒï¼šé¡¯ç¤º SR æ§åˆ¶ç–Šå±¤ï¼ˆå¯èšç„¦æŒ‰éˆ•ï¼‰ =====
    // ç„¡æ³•ç›´æ¥åµæ¸¬ã€ŒSR æ˜¯å¦é–‹å•Ÿã€ï¼Œæ‰€ä»¥æä¾›ï¼š
    //  (a) å¯å‘å¼ï¼šè‹¥æŒ‰éˆ•è¢«èšç„¦/é›™æ“Šæœ‰æ•ˆï¼Œæˆ‘å€‘ä¿æŒç–Šå±¤é¡¯ç¤º
    //  (b) æ‰‹å‹•åˆ‡æ›ï¼šsrToggle
    const overlay = document.getElementById('srControlOverlay');
    const dpad = document.getElementById('srDpad');
    const enterPad = document.getElementById('srEnter');
    const toggleBtn = document.getElementById('srToggle');

    function showOverlay(){
      document.body.classList.add('show-sr-overlay');
      toggleBtn.setAttribute('aria-pressed','true');
      toggleBtn.textContent = 'æ§åˆ¶ï¼šé–‹å•Ÿ';
      // â¬‡ï¸ æ–°å¢ï¼šè‡ªå‹•èšç„¦ ENTER
      const enterBtn = document.querySelector('#srEnter button');
      enterBtn?.focus({ preventScroll: true });
    }
    function hideOverlay(){ document.body.classList.remove('show-sr-overlay'); toggleBtn.setAttribute('aria-pressed','false'); toggleBtn.textContent = 'æ§åˆ¶ï¼šè‡ªå‹•'; }

    // é è¨­ç­–ç•¥ï¼š
    //  - è‹¥åµæ¸¬åˆ°è¢å¹•é–±è®€å™¨å¯èƒ½æ””æˆªæ»‘å‹•ï¼ˆç©å®¶æŠ±æ€¨ç§»ä¸å‹•ï¼‰ï¼Œå¯ä»¥æŒ‰å³ä¸Šè§’ã€Œæ§åˆ¶ï¼šè‡ªå‹•ã€æ‰‹å‹•é–‹å•Ÿ
    toggleBtn?.addEventListener('click', ()=>{
      const on = document.body.classList.toggle('show-sr-overlay');
      toggleBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
      toggleBtn.textContent = on ? 'æ§åˆ¶ï¼šé–‹å•Ÿ' : 'æ§åˆ¶ï¼šè‡ªå‹•';
    });

    // è®“ D-pad / ENTER éˆ•ç”¨ act è§¸ç™¼
    function wireSrPad(){
      const dpad = document.getElementById('srDpad');
      const enterPad = document.getElementById('srEnter');
      const hook = (root)=> root?.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-key]'); if(!btn) return;
        act(btn.getAttribute('data-key'));
      });
      hook(dpad); hook(enterPad);
    }
    wireSrPad();

    // ä½ ä¹Ÿå¯ä»¥åœ¨åˆ‡æ›ã€Œé¤Šè²“å°è©±ã€ã€ã€Œæ¸¬é©—è¦–çª—ã€æ™‚ï¼Œæš«æ™‚è‡ªå‹•é–‹/é—œç–Šå±¤ï¼š
    window.addEventListener('quiz-open',  ()=> showOverlay());   // æ¸¬é©—æœŸé–“å»ºè­°ç”¨æŒ‰éˆ•æ“ä½œ
    window.addEventListener('quiz-close', ()=> hideOverlay());

    // è‹¥ä½ æƒ³ã€Œè‡ªå‹•åˆ¤æ–· SR å¯èƒ½é–‹å•Ÿ â†’ é¡¯ç¤ºç–Šå±¤ã€ï¼Œ
    // å¯ä»¥è§€å¯Ÿä½¿ç”¨è€…å˜—è©¦æ»‘å‹•å» 5 ç§’å…§æ²’æœ‰ä»»ä½•ç§»å‹•æˆåŠŸäº‹ä»¶ï¼Œå†è‡ªå‹• showOverlay()ã€‚
    // é€™è£¡å…ˆç•™ä»‹é¢ï¼ˆé¿å…èª¤åˆ¤ï¼‰ï¼Œä¿å®ˆäº¤ç”±ç©å®¶æ‰‹å‹•åˆ‡æ›ã€‚
  })();
  </script>

  <!-- A11Y åˆå§‹åŒ–ï¼ˆå« Quiz å¿™ç¢Œåµæ¸¬ï¼‰ -->
  <script>
  document.addEventListener('game-ready', () => {
    const stageEl = document.getElementById('gameArea');
    window.__focusHints = A11YFocusHints.install({
      stageEl,
      hintText: 'æç¤ºï¼šå·²é€²å…¥éŠæˆ²ã€‚NVDA ä½¿ç”¨è€…è«‹æŒ‰ NVDA åŠ  ç©ºç™½ åˆ‡æ›åˆ°ç„¦é»æ¨¡å¼ï¼Œå†ç”¨æ–¹å‘éµæ“ä½œã€‚'
    });
    window.__arb = A11YArbiter.install({
      hpEl:   document.getElementById('playerHP'),
      coinEl: document.getElementById('playerCoins'),
      wpnEl:  document.getElementById('weaponStatus'),
      srEl:   document.getElementById('srStatus'),
      ttsBusyFn: () => (Core?._speechDepth>0) || (speechSynthesis?.speaking)
    });
    window.__sc = SpawnConductor.install({
      srEl: document.getElementById('srStatus'),
      ttsBusyFn: () => (Core?._speechDepth>0) || (speechSynthesis?.speaking)
    });
  });
  window.addEventListener('quiz-open',  () => { window.gameActive = false; });
  window.addEventListener('quiz-close', () => { window.gameActive = true;  });
  window.addEventListener('beforeunload', () => { try{ window.__focusHints?.destroy(); }catch(_){} });
  </script>

  <!-- å‹‡è€…åç¨±è²¼åœ–è£œä¸ï¼ˆç¶­æŒã€Œè§’è‰²åï¼æš±ç¨±ã€é¡¯ç¤ºï¼‰ -->
  <script>
  ;(() => {
    "use strict";
    const roleMap = {
      "kinbah.png": "é‡‘å·´","mailah.png": "éº¥æ‹‰","khaupe.png": "è€ƒç›ƒ","holah.png": "èµ«æ‹‰",
      "chinaikhun.png": "é‡‘ï¼è‰¾æ†","chiaulaipeh.png": "éƒŠï¼èŠåŒ—","mienphapan.png": "ç¶¿è‘©ï¼å‚","hamchuniok.png": "ç½•æ—ï¼æ‹—"
    };
    const fileKey = (p)=> (String(p||'').split('#')[0].split('?')[0].split('/').pop()||'').toLowerCase();
    function readHero(){
      let p={}; try{ p=JSON.parse(localStorage.getItem("bugSlayerPlayer")||"{}"); }catch(_){}
      const name=p?.name||"ç„¡åå‹‡è€…", avatarPath=p?.avatar||"", roleName=roleMap[fileKey(avatarPath)]||"æœªçŸ¥å‹‡è€…";
      return { name, roleName, avatarPath };
    }
    function initHeroUI(){
      const { name, roleName, avatarPath } = readHero();
      const elName = document.getElementById("playerName");
      if (elName) elName.textContent = `${roleName}ï¼${name}`;
      let sticker = document.getElementById("heroSticker");
      if (!sticker) {
        sticker = document.createElement("img");
        sticker.id = "heroSticker";
        sticker.className = "hero-sticker";
        sticker.alt = ""; sticker.setAttribute("aria-hidden","true");
        document.body.appendChild(sticker);
      }
      sticker.style.display = avatarPath ? "" : "none";
      if (avatarPath) sticker.src = avatarPath;
    }
    function patchUpdateUI(){
      if (!window.Core || typeof Core.updateUI !== "function") return false;
      if (Core.__patchedHeroName) return true;
      const orig = Core.updateUI.bind(Core);
      Core.updateUI = function(){
        orig();
        const { name, roleName } = readHero();
        const elName = document.getElementById("playerName");
        if (elName) elName.textContent = `${roleName}ï¼${name}`;
      };
      Core.__patchedHeroName = true; return true;
    }
    function ensurePatched(){
      if (patchUpdateUI()) return;
      const t0=Date.now(), timer=setInterval(()=>{ if (patchUpdateUI() || Date.now()-t0>5000) clearInterval(timer); },120);
    }
    document.addEventListener("DOMContentLoaded", initHeroUI);
    document.addEventListener("game-ready", () => { initHeroUI(); ensurePatched(); }, { once:true });
    window.addEventListener("load", ensurePatched, { once:true });
  })();
  </script>

  <!-- å•Ÿå‹•è…³æœ¬ï¼ˆç¬¬ 5 é—œï¼‰ -->
  <script src="js/boot/game_l5.js"></script>

  <!-- æ¨¡å¼åˆ‡æ›ï¼ˆShift+Mï¼‰ -->
  <script> Modes.applyModeOnLoad(); Modes.bindQuickToggle(); </script>

  <!-- SR å™ªéŸ³é–€ï¼ˆæ²¿ç”¨å‰é—œè¨­å®šï¼‰ -->
  <script>
  (function (w) {
    const Q = sel => Array.from(document.querySelectorAll(sel));
    const LIVE = ['#srStatus','#message','[role="status"][aria-live]','[aria-live="polite"]','[aria-live="assertive"]'];
    const orig = new WeakMap();
    const getNodes = () => Array.from(new Set(LIVE.flatMap(s => Q(s))));
    function mute(){ getNodes().forEach(n=>{ if(!orig.has(n)) orig.set(n, n.getAttribute('aria-live')||''); n.setAttribute('aria-live','off'); }); document.body.setAttribute('aria-busy','true'); }
    function unmute(){ getNodes().forEach(n=>{ const v=orig.get(n); if(v===null||v==='') n.removeAttribute('aria-live'); else n.setAttribute('aria-live',v); }); document.body.removeAttribute('aria-busy'); }
    const busy = ()=> !!(w.Core && Core._speechDepth>0) || !!(w.speechSynthesis && speechSynthesis.speaking);
    (function watch(){ let m=false; setInterval(()=>{ const b=busy(); if(b && !m){ mute(); m=true; } else if(!b && m){ unmute(); m=false; } }, 120); })();
    w.addEventListener?.('quiz-open',  mute);
    w.addEventListener?.('quiz-close', unmute);
    w.addEventListener?.('beforeunload', unmute);
  })(window);
  </script>

  <!-- æ­¦å™¨æµ®å‹•é¸å–®ï¼šé»æ“Šåˆ‡æ›ï¼›ç¬¬ä¸€é—œå¡è¦å‰‡ä¸‹å…¨éƒ¨å¯è¦‹ï¼Œä½†å‹•ä½œä¾ä½ ç¾æœ‰ API -->
  <script>
  (function(){
    const btn = document.getElementById('weaponToggle');
    const menu = document.getElementById('weaponMenu');
    if (!btn || !menu) return;

    let open = false;
    const show = ()=>{ menu.style.display='flex'; open=true; };
    const hide = ()=>{ menu.style.display='none'; open=false; };
    const toggle = ()=> open?hide():show();

    btn.addEventListener('click', toggle);
    document.addEventListener('click', (e)=>{ if (open && !menu.contains(e.target) && e.target!==btn) hide(); });

    // å­é¸å–® â†’ å‘¼å«å°æ‡‰è¡Œç‚ºï¼ˆä¾ä½ æ—¢æœ‰çš„å…¨åŸŸ APIï¼‰
    const act = (w)=>{
      switch(w){
        case 'fire':    return window.changeWeapon?.('fire');
        case 'spray':   return window.changeWeapon?.('spray');
        case 'slipper': return window.changeWeapon?.('slipper');
        case 'bait':    return window.changeWeapon?.('bait');
        case 'cat':     return window.openCatPicker?.();
        case 'vote':    return window.vote?.();
        case 'recall':  return window.useRecall?.();
      }
    };
    menu.addEventListener('click', (e)=>{
      const b = e.target.closest('button[data-wpn]'); if (!b || b.disabled) return;
      act(b.dataset.wpn); hide();
    });

    // è‹¥ä½ çš„ Core æœƒä¾æ¢ä»¶é–æ­¦å™¨ï¼Œå¯åœ¨é€™è£¡å‹•æ…‹ç¦ç”¨ï¼ˆç¤ºæ„ï¼šå…ˆå…¨éƒ¨å•Ÿç”¨ï¼‰
    const enable = (...ids)=> ids.forEach(id => menu.querySelector(`[data-wpn="${id}"]`)?.removeAttribute('disabled'));
    const disable= (...ids)=> ids.forEach(id => menu.querySelector(`[data-wpn="${id}"]`)?.setAttribute('disabled',''));
    document.addEventListener('DOMContentLoaded', ()=>{
      enable('fire','spray','slipper','bait','cat','vote','recall');
      // ä¹Ÿå¯åœ¨ game-ready å¾Œæ ¹æ“š Core ç‹€æ…‹ç²¾ç´°æ§åˆ¶ recall æ˜¯å¦å¯ç”¨
      const btnRecall = document.getElementById('btnRecallMenu');
      if (btnRecall && window.Core && typeof Core._isRecallAchieved === 'function'){
        const ok = Core._isRecallAchieved();
        btnRecall.disabled = !ok;
        btnRecall.title = ok ? 'å¯ç™¼å‹•ç½·å…' : 'å°šæœªé”æˆé–€æª»';
      }
    });

    // éµç›¤ç©å®¶ä»å¯ç”¨æ•¸å­—éµ 1â€“7ï¼Œé€™è£¡ä¸ç”¨é¡å¤–è™•ç†ï¼ˆKeys æ¨¡çµ„å·²ç¶ï¼‰
  })();
  </script>

  <!-- é¤Šè²“ Dialog çš„ A11Y æ•ç²ï¼ˆä¿ç•™ä½ åŸæœ¬çš„è¡Œç‚ºï¼‰ -->
  <script>
  (function () {
    const dialog = document.getElementById('catDialog');
    const panel  = document.getElementById('catPanel');
    if (!dialog || !panel) return;
    dialog.classList.add('sr-only'); dialog.setAttribute('hidden',''); dialog.setAttribute('aria-hidden','true');

    const capture = (e) => {
      const keys = ["Enter","Escape","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"," "];
      if (!keys.includes(e.key)) return;
      e.preventDefault(); e.stopPropagation();
      if (e.key === "Escape") { closeCatPicker?.(); return; }
      const el = document.activeElement;
      const isBtn = (el?.tagName === 'BUTTON') || (el?.getAttribute?.('role') === 'button');
      if (e.key === ' ' && isBtn) { el.click?.(); return; }
      if (e.key === 'Enter') {
        if (el?.classList?.contains('dialog-close')) { closeCatPicker?.(); return; }
        if (el?.classList?.contains('catCard')) { el.querySelector('button')?.click(); return; }
        if (isBtn) { el.click?.(); return; }
      }
      const grid = document.getElementById('catGrid'); if (!grid) return;
      const cards = Array.from(grid.querySelectorAll('.catCard')); if (!cards.length) return;
      const idx = cards.indexOf(document.activeElement); if (idx < 0) return;
      const cardW = cards[0].getBoundingClientRect().width || 200;
      const cols  = Math.max(1, Math.round(grid.clientWidth / cardW)) || 4;
      let next=null;
      if (e.key === 'ArrowRight') next = cards[Math.min(cards.length-1, idx+1)];
      if (e.key === 'ArrowLeft')  next = cards[Math.max(0, idx-1)];
      if (e.key === 'ArrowDown')  next = cards[Math.min(cards.length-1, idx+cols)];
      if (e.key === 'ArrowUp')    next = cards[Math.max(0, idx-cols)];
      next?.focus();
    };

    const isVisible = (el)=>{
      if (!el) return false;
      if (el.hasAttribute('hidden') || el.getAttribute('aria-hidden')==='true') return false;
      if (el.classList.contains('sr-only')) return false;
      const cs = getComputedStyle(el);
      return !(cs.display==='none' || cs.visibility==='hidden' || cs.opacity==='0');
    };
    const focusFirst = ()=>{
      const first = document.querySelector('#catGrid .catCard');
      (first || panel).focus();
    };

    // === NEW: é–/è§£ èƒŒæ™¯æ²å‹•ï¼Œä¸¦åœ¨é–‹å•Ÿæ™‚åšä¸€æ¬¡æ²å‹•æ ¡æ­£ï¼ˆæ‰‹æ©Ÿï¼‰ ===
    function lockScroll(){ document.body.classList.add('lock-scroll'); }
    function unlockScroll(){ document.body.classList.remove('lock-scroll'); }
    function ensureVisibleSoon(){
      // ç­‰ä¸‹ä¸€å€‹ frameï¼Œç¢ºä¿ layout å®Œæˆå¾ŒæŠŠé¢æ¿æ²åˆ°æœ€ä¸Šæ–¹
      requestAnimationFrame(()=>{ panel.scrollTop = 0; });
    }

    const mo = new MutationObserver(()=>{
      if (isVisible(dialog)) {
        setTimeout(()=>{
          focusFirst();
          dialog.addEventListener('keydown', capture, true);
          lockScroll();
          ensureVisibleSoon();
        }, 0);
      } else {
        dialog.removeEventListener('keydown', capture, true);
        unlockScroll();
      }
    });
    mo.observe(dialog, { attributes:true, attributeFilter:['class','hidden','aria-hidden','style'] });

    // ä¿ç•™ä½ åŸæœ¬çš„ Enter é–‹å•Ÿæ¢ä»¶
    document.addEventListener('keydown', (e)=>{
      if (e.key!=='Enter' || isVisible(dialog)) return;
      const G = window.game; if (!G) return;
      if (G.state?.weapon==='cat' && !G.state?.catOwned) { openCatPicker?.(); e.preventDefault(); }
    });
  })();
  </script>
</body>
</html>
