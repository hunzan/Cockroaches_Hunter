<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ç¬¬ 5 é—œï¼šå»šæˆ¿é£¯å»³ï¼ˆ10Ã—10ï¼‰ - é€²æ“Šçš„èŸ‘è‚</title>
  <link rel="stylesheet" href="style.css" />
  <script src="js/core/modes.js"></script>
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>
  <style>
    body{
      margin:0; padding:0;
      background:url("assets/images/game_bg5.png") no-repeat center center fixed;
      background-size:cover;
      font-family:sans-serif;
      opacity:0; transition:opacity .6s ease;
    }
    body.ready{ opacity:1; }

    /* åˆå§‹ç‚º flexï¼›é€²å…¥ Grid æ¨¡å¼å¾Œç”± ModeGrid è¨­ç‚º CSS Grid 10Ã—10 */
    #gameArea{
      display:flex;
      justify-content:center;
      margin:1rem auto;
      gap:.5rem;
    }
    .tile{
      width:50px; height:50px;
      border:2px solid #333;
      font-size:1.5rem; text-align:center; line-height:50px;
      background:#eee;
    }
    .tile.player{ background:#cce5ff; }
    .tile.bug{ background:#f8d7da; }

    #touchControls{ margin:1rem auto; text-align:center; }
    #touchControls button{ font-size:1rem; margin:.3rem; }
    #message{ margin-top:1rem; font-weight:bold; text-align:center; }

    .sr-only{
      position:absolute!important; width:1px; height:1px;
      padding:0; margin:-1px; overflow:hidden;
      clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }
        /* å‹‡è€…è²¼åœ–ï¼ˆå³ä¸‹è§’è£é£¾ï¼Œä¸æ“‹æ“ä½œï¼‰ */
  .hero-sticker{
    position: fixed;
    right: 12px;
    bottom: 12px;
    width: min(22vw, 180px);
    max-width: 220px;
    height: auto;
    opacity: .95;
    pointer-events: none;                 /* â˜… ä¸æ””æˆªæ»‘é¼ /è§¸æ§ */
    filter: drop-shadow(0 6px 18px rgba(0,0,0,.45));
    z-index: 10;
  }
  @media (max-width: 480px){
    .hero-sticker{ width: 28vw; opacity: .9; }
  }
  </style>
</head>
<body class="stage5">
  <main>
    <h1>å»šæˆ¿é£¯å»³æ˜¯æœ€å¾Œçš„é˜²ç·š</h1>

    <p id="a11yHelp" class="sr-only">
      éµç›¤æ“ä½œï¼šæ–¹å‘éµç§»å‹•ï¼›ç©ºç™½éµæƒæï¼›Enter æ”»æ“Šï¼›æ•¸å­—éµ 1 åˆ° 7 åˆ‡æ›æ­¦å™¨ã€‚
      ä»»ä½•æ™‚å€™å¯æŒ‰ Shift+S æœ—è®€ç›®å‰ç‹€æ…‹ï¼ˆè¡€é‡ã€é‡‘å¹£ã€æ­¦å™¨èˆ‡å¯ç”¨æ¬¡æ•¸ï¼‰ã€‚
      æœ¬é—œè¦å‰‡ï¼šå¯ç”¨é‡‘å¹£æ”¶è²·ç¬¬ 1 åˆ°ç¬¬ 3 éšçš„èŸ‘è‚ï¼Œä¿—è¾£å¼· 1 æšã€é£›å¤©å¼·å°¼ 3 æšã€ä¸»ç®¡å¼·å¼·æ£ 5 æšã€‚
      è»å¸«èŸ‘åˆ°çˆ†ä¸èƒ½ç”¨é‡‘å¹£æ”¶è²·ï¼Œéœ€ç­”é¡Œéé—œæˆ–ç”¨æ¯’é¤Œæ“Šæ•—ç‰ ã€‚
      ç ´é—œæ–¹æ³•ä¸€ï¼šæ”¶è²· 20 éš»ä¿—è¾£å¼·ã€10 éš»é£›å¤©å¼·å°¼ã€5 éš»ä¸»ç®¡å¼·å¼·æ£ã€ä»¥åŠ 3 éš»è»å¸«èŸ‘åˆ°çˆ†ï¼Œæ–¹å¯ç½·å…èŸ‘è‚ç‹ã€‚
      ç ´é—œæ–¹æ³•äºŒï¼šç©å®¶æ“æœ‰é‡‘å¹£é” 200 æšï¼Œå¯è³¼è²·è²“é£¼æ–™é¤Šè²“å¬å–šè²“å’ªæ“Šé€€èŸ‘è‚ç‹ã€‚
      è«‹ç›¡é‡é¿é–‹èŸ‘è‚ç‹çš„æ”»æ“Šï¼›ç¬¬ 1 åˆ°ç¬¬ 4 é …æ­¦å™¨å°ç¥‚ç„¡æ•ˆã€‚
    </p>

    <!-- ç©å®¶ç‹€æ…‹å€å¡Š -->
    <section id="playerStatus" aria-label="ç©å®¶ç‹€æ…‹" style="margin: 1rem 0; font-weight: bold;">
      <div>å‹‡è€…ï¼š<span id="playerName">---</span></div>
      <div>è¡€é‡ï¼š<span id="playerHP">---</span></div>
      <div>é‡‘å¹£ï¼š<span id="playerCoins">---</span></div>
      <div class="ps-recall">ç½·å…ç¥¨ï¼š<span id="recallVotes">0</span> / <span id="recallNeed">10</span></div>
      <div><span id="weaponStatus">---</span></div>

      <!-- çµ¦è¢å¹•å ±è®€å™¨ç”¨çš„éš±å½¢æ‘˜è¦ -->
      <div id="srStatus" aria-live="polite" aria-atomic="true" role="status" class="sr-only"></div>
    </section>

    <!-- è§¸æ§æ§åˆ¶ -->
    <div id="touchControls" aria-label="è§¸æ§æ§åˆ¶">
      <button onclick="moveLeft()">â¬…ï¸ å·¦ç§»</button>
      <button onclick="moveRight()">â¡ï¸ å³ç§»</button>
      <button onclick="moveUp()">â¬†ï¸ ä¸Š</button>
      <button onclick="moveDown()">â¬‡ï¸ ä¸‹</button>
      <button onclick="scanArea()">ğŸ” æƒæ</button>
      <button onclick="attack()">ğŸ”¥ æ”»æ“Š</button>
      <button onclick="changeWeapon('fire')">1ï¸âƒ£ å™´ç«æ§</button>
      <button onclick="changeWeapon('spray')">2ï¸âƒ£ é¦™æ°›å™´éœ§</button>
      <button onclick="changeWeapon('slipper')">3ï¸âƒ£ è—ç™½æ‹–</button>
      <button onclick="changeWeapon('bait')">4ï¸âƒ£ æ¯’é¤Œ</button>
            <!-- NEW L5ï¼šä¸‰å€‹æ–°æ­¦å™¨ -->
      <button onclick="openCatPicker()">5ï¸âƒ£ é¤Šè²“</button>
      <button onclick="vote()">6ï¸âƒ£ ç½·å…é€£ç½²</button>
      <button id="btnRecall" onclick="useRecall()" class="span2">7ï¸âƒ£ ğŸ—³ï¸ ç½·å… <small id="recallHint"></small></button>
    </div>

    <!-- éŠæˆ²å ´åœ°ï¼ˆ10Ã—10ï¼‰ -->
    <div id="gameArea" role="group" aria-describedby="a11yHelp" aria-label="å»šæˆ¿é£¯å»³æˆ°é¬¥å€ï¼š10ä¹˜10 æ ¼ç‹€å€åŸŸ" tabindex="0"></div>

    <div id="message" aria-live="assertive"></div>

    <!-- æ’­éŸ³ç”¨ audio -->
    <audio id="voicePlayer" src="" hidden></audio>

  </main>
    <!-- NEW L5ï¼šè²“å’ªä»‹ç´¹/é ˜é¤Šå°è©±æ¡† -->
  <div id="catDialog" class="sr-only" hidden aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="catTitle" aria-describedby="catDesc">
    <div id="catPanel" style="position:fixed; inset:10% 15%; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.4); padding:1rem; overflow:auto;">
      <h2 id="catTitle">é¤Šè²“ï¼šé¸æ“‡ä½ çš„æˆ°è²“ï¼ˆæ¯éš» 200 é‡‘å¹£ï¼‰</h2>
      <p id="catDesc">é¸ä¸€éš»è²“å’ªåŠ å…¥ä½ çš„éšŠä¼ï¼Œé¤Šè²“æˆåŠŸå¾Œæœƒæˆç‚ºé‡å°èŸ‘è‚ç‹çš„æœ‰æ•ˆæ­¦å™¨ã€‚å¯ç”¨ Tab ç€è¦½ï¼ŒEnter æŒ‰ä¸‹ã€Œé ˜é¤Šã€ã€‚æŒ‰ Esc å¯é—œé–‰ã€‚</p>
      <div id="catGrid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
        <!-- 5 éš»è²“ç¯„ä¾‹ï¼ˆç”¨ä½ çš„å¯¦éš›åœ–ç‰‡è·¯å¾‘æ›¿æ› srcï¼‰ -->
        <div class="catCard" tabindex="0" data-cat="cat_01" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_01.png" alt="ç™½è²“ åŒ—ä¸‹é–œ" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">ç™½è²“ åŒ—ä¸‹é–œï¼ˆPeÌh-siak-siakï¼‰</h3>
          <p style="margin:0 0 .5rem;">åæ‡‰å¿«ã€å®ˆé–€ç¥ã€‚</p>
          <button onclick="adoptCat('cat_01')">é ˜é¤Š 200ğŸ’°</button>
        </div>
        <div class="catCard" tabindex="0" data-cat="cat_02" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_02.png" alt="è™æ–‘ é˜¿å" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">è™æ–‘ é˜¿åï¼ˆA-hÃ³ï¼‰</h3>
          <p style="margin:0 0 .5rem;">åŠ›æ°£å¤§ã€å£“åˆ¶ç‹ã€‚</p>
          <button onclick="adoptCat('cat_02')">é ˜é¤Š 200ğŸ’°</button>
        </div>
        <div class="catCard" tabindex="0" data-cat="cat_03" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_03.png" alt="é»‘è²“ æ­ç½µç‘ª" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">é»‘è²“ æ­ç½µç‘ªï¼ˆOÍ˜-mÃ -mÃ ï¼‰</h3>
          <p style="margin:0 0 .5rem;">å†·éœã€å·è¥²é«˜æ‰‹ã€‚</p>
          <button onclick="adoptCat('cat_03')">é ˜é¤Š 200ğŸ’°</button>
        </div>
        <div class="catCard" tabindex="0" data-cat="cat_04" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_04.png" alt="ä¸‰èŠ±è²“ äº”å‘Šæ®" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">ä¸‰èŠ±è²“ äº”å‘Šæ®ï¼ˆÅª-kÃ u Hoeï¼‰</h3>
          <p style="margin:0 0 .5rem;">æ•æ·ã€é€£æ“Šå¿«ã€‚</p>
          <button onclick="adoptCat('cat_04')">é ˜é¤Š 200ğŸ’°</button>
        </div>
        <div class="catCard" tabindex="0" data-cat="cat_05" style="border:1px solid #ddd; border-radius:10px; padding:.5rem;">
          <img src="assets/images/cats/cat_05.png" alt="éº’éºŸå°¾æš¹é‚è²“ å¸•å˜æŠ“" style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
          <h3 style="margin:.5rem 0 .25rem;">éº’éºŸå°¾æš¹é‚è²“ å¸•å˜æŠ“ï¼ˆPhah Ka-choaÌhï¼‰</h3>
          <p style="margin:0 0 .5rem;">æ·±ä¸å¯æ¸¬ã€æ®ºæ°£é¨°é¨°ã€‚</p>
          <button onclick="adoptCat('cat_05')">é ˜é¤Š 200ğŸ’°</button>
        </div>
      </div>
        <div class="dialog-actions" style="margin-top:1rem; text-align:right;">
          <button class="dialog-close" id="catCloseBtn" type="button" onclick="closeCatPicker()">é—œé–‰</button>
        </div>
    </div>
  </div>

  <!-- é—œå¡ BGM -->
  <audio id="bgm" src="assets/sounds/game_05.mp3" loop preload="auto"></audio>

          <!-- åœ¨ BGM ä¹‹å¾Œåˆå§‹åŒ–/ç™»è¨˜ -->
  <script>
    // 1) åˆå§‹åŒ–ï¼ˆå¯æ—©å°±å‘¼å«ï¼Œå¤šæ¬¡ä¹Ÿæ²’äº‹ï¼‰
    AudioFX.init();

    // 2) ç™»è¨˜è¦è§£é–/æ’­æ”¾çš„ BGMï¼ˆä¸€å®šè¦åœ¨ <audio> ä¹‹å¾Œï¼‰
    const bgm = document.getElementById('bgm');
    AudioFX.register(bgm);

    // ï¼ˆå¯é¸ï¼‰ç•¶ä½ åˆ‡åˆ°ç„¦é»æ¨¡å¼ã€æˆ–æƒæéµæœ‰è¢«è§¸ç™¼æ™‚ï¼Œä¿éšªå«é†’ä¸€æ¬¡
    window.addEventListener('game-ready', () => { try { AudioFX.ensure(); } catch(_) {} });
  </script>

<script>
(function () {
  document.body.classList.add('ready');
  // ===== é¤Šè²“ Dialogï¼šA11Y & Keyboard UX =====
  const dialog = document.getElementById('catDialog');
  const panel  = document.getElementById('catPanel');
  if (!dialog || !panel) return;

  // åˆå§‹éš±è—ï¼ˆä¿éšªï¼‰
  dialog.classList.add('sr-only');
  dialog.setAttribute('hidden', '');
  dialog.setAttribute('aria-hidden', 'true');

  // ---- æ•ç²éšæ®µä¿è­·ï¼šè¦–çª—é–‹å•Ÿæ™‚ï¼Œéµç›¤äº‹ä»¶ä¸ç©¿é€åˆ°éŠæˆ² ----
  const captureKeys = (e) => {
    const keys = ["Enter","Escape","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"," "];
    if (!keys.includes(e.key)) return;

    e.preventDefault();
    e.stopPropagation();

    // Esc é—œçª—
    if (e.key === "Escape") { closeCatPicker?.(); return; }

    // Space/Enter â†’ è®“æŒ‰éˆ•èƒ½è¢«å•Ÿå‹•
    const el = document.activeElement;
    const isButtonLike = (el?.tagName === 'BUTTON') || (el?.getAttribute?.('role') === 'button');
    if (e.key === ' ' && isButtonLike) { el.click?.(); return; }
    if (e.key === 'Enter') {
      if (el?.classList?.contains('dialog-close')) { closeCatPicker?.(); return; }
      if (el?.classList?.contains('catCard')) { el.querySelector('button')?.click(); return; }
      if (isButtonLike) { el.click?.(); return; }
    }

    // æ–¹å‘éµåœ¨å¡ç‰‡é–“ç§»å‹•
    const grid = document.getElementById('catGrid');
    if (!grid) return;
    const cards = Array.from(grid.querySelectorAll('.catCard'));
    if (!cards.length) return;

    const idx = cards.indexOf(document.activeElement);
    if (idx < 0) return;

    const cardW = cards[0].getBoundingClientRect().width || 200; // fallback
    const cols  = Math.max(1, Math.round(grid.clientWidth / cardW)) || 4;

    let next = null;
    if (e.key === 'ArrowRight') next = cards[Math.min(cards.length - 1, idx + 1)];
    if (e.key === 'ArrowLeft')  next = cards[Math.max(0, idx - 1)];
    if (e.key === 'ArrowDown')  next = cards[Math.min(cards.length - 1, idx + cols)];
    if (e.key === 'ArrowUp')    next = cards[Math.max(0, idx - cols)];
    if (next) next.focus();
  };

  const enableCapture  = () => dialog.addEventListener('keydown', captureKeys, true);   // â˜… capture=true
  const disableCapture = () => dialog.removeEventListener('keydown', captureKeys, true);

  // é–‹å•Ÿæ™‚è‡ªå‹•èšç„¦åˆ°ç¬¬ä¸€å¼µå¡ç‰‡ï¼ˆæˆ–é¢æ¿ï¼‰ï¼Œä¸¦å•Ÿç”¨æ•ç²
  const isVisible = (el) => {
    if (!el) return false;
    if (el.hasAttribute('hidden') || el.getAttribute('aria-hidden') === 'true') return false;
    if (el.classList.contains('sr-only')) return false;
    const cs = window.getComputedStyle(el);
    return !(cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0');
  };
  const focusFirstCard = () => {
    const first = document.querySelector('#catGrid .catCard');
    (first || panel).focus();
  };
  const mo = new MutationObserver(() => {
    if (isVisible(dialog)) {
      // è¦–çª—å‰›é¡¯ç¤ºï¼šèšç„¦ + å•Ÿç”¨æ•ç²
      setTimeout(() => { focusFirstCard(); enableCapture(); }, 0);
    } else {
      // è¦–çª—é—œé–‰ï¼šç§»é™¤æ•ç²
      disableCapture();
    }
  });
  mo.observe(dialog, { attributes: true, attributeFilter: ['class', 'hidden', 'aria-hidden', 'style'] });

  // é¡å¤–ä¿éšªï¼šç•¶æ­¦å™¨é¸åˆ°ã€Œé¤Šè²“ã€ä¸”å°šæœªé ˜é¤Šæ™‚ï¼ŒæŒ‰ Enter ä¹Ÿæœƒæ‰“é–‹è¦–çª—
  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter') return;
    if (isVisible(dialog)) return;                 // â˜… æ–°å¢ï¼šè¦–çª—é–‹è‘—å°±ä¸å†é–‹
    const G = window.game; if (!G) return;
    if (G.state?.weapon === 'cat' && !G.state?.catOwned) {
      if (typeof openCatPicker === 'function') {
        openCatPicker();
        e.preventDefault();
      }
    }
  });
})();
</script>

  <!-- è³‡æ–™ -->
  <script src="js/content/bugs.js"></script>
  <script src="js/content/levels.js"></script>

  <!-- æ ¸å¿ƒèˆ‡æ¨¡å¼ï¼ˆé †åºï¼šcore -> lane -> gridï¼‰ -->
  <script src="js/core/game-core.js"></script>
  <script src="js/core/mode-lane.js"></script>
  <script src="js/render/furniture.js"></script>
  <script src="js/core/mode-grid.js"></script>

  <script src="js/a11y/focus-hints.js"></script>
  <script src="js/a11y/announce-arbiter.js"></script>
  <script src="js/a11y/spawn-conductor.js"></script>

  <!-- å•ç­”èˆ‡ K4 å°è©±ï¼ˆé †åºå¾ˆé‡è¦ï¼šquiz.js â†’ å»ºç«‹å¯¦ä¾‹ â†’ k4_dialog.js â†’ wiring â†’ bootï¼‰ -->
  <script src="js/core/quiz.js"></script>

  <script>
    // å»ºç«‹å…¨åŸŸé¡Œåº«å¯¦ä¾‹ï¼ˆè·¯å¾‘ç”¨ä½ å¯¦éš›çš„ K4 é¡Œåº«ï¼‰
    window.quiz = new window.QuizEngine({
      dataUrl: 'assets/questions/questions_k4.json',
      voiceLang: 'zh-TW',
      enableTTS: true,
      readChoicesOnOpen: true,
      speakOnSelect: true
    });

    // å¯é¸ï¼šå…ˆé è¼‰é¡Œåº«ï¼Œé¿å…æŒ‰ Enter æ™‚æ‰ä¸‹è¼‰
    document.addEventListener('game-ready', async () => {
      try { await window.quiz.load(); } catch (e) {
        console.warn('[k4] quiz.load å¤±æ•—', e);
      }
    });
  </script>

  <script src="js/core/k4_dialog.js"></script>

  <script src="js/core/retry.js"></script>
  <script> Retry.rememberLevel(); </script>

  <script src="js/core/keys.js"></script>

  <script>
    // boot å®Œæˆ/æˆ– game-ready ä¹‹å¾Œå‘¼å«ä¸€æ¬¡
    document.addEventListener('game-ready', () => {
      const stage = document.getElementById('gameArea'); // â˜… å…ˆæŠ“ DOM
      Keys.init({
        stageEl: stage,
        scanFn: () => window.scanArea?.(),
        activeGuardFn: () => window.gameActive !== false // å¯é¸ï¼šé‡åˆ°æ¸¬é©—/å°è©±æ™‚åœç”¨
      });
    }, { once:true });
  </script>

  <script>
  /* === A11Y åˆå§‹åŒ–ï¼šé€²å ´ç„¦é»æç¤º + SR ç‹€æ…‹å ±è®€ä»²è£ï¼ˆå« Quiz å…¼å®¹ï¼‰ === */
  document.addEventListener('game-ready', () => {
    // 1) é€²å ´æç¤ºèˆ‡è‡ªå‹•èšç„¦ï¼ˆNVDA ç„¦é»æ¨¡å¼ï¼‰
    const stageEl = document.getElementById('gameArea');
    window.__focusHints = A11YFocusHints.install({
      stageEl,
      // ä¸çµ¦ srEl ä¹Ÿè¡Œï¼Œæ¨¡çµ„æœƒè‡ªå»ºéš±å½¢ aria-live å®¹å™¨ï¼ˆpolite+atomicï¼‰
      hintText: 'æç¤ºï¼šå·²é€²å…¥éŠæˆ²ã€‚NVDA ä½¿ç”¨è€…è«‹æŒ‰ NVDA åŠ  ç©ºç™½ åˆ‡æ›åˆ°ç„¦é»æ¨¡å¼ï¼Œå†ç”¨æ–¹å‘éµæ“ä½œã€‚',
      // é è¨­ useSpeechSynthesis:falseï¼Œé¿å…å’Œä½ çš„éŠæˆ² TTS æ‰“æ¶
    });

    // 2) ç‹€æ…‹å ±è®€ä»²è£ï¼ˆåˆä½µï¼‹ç¯€æµï¼Œé¿é–‹ TTS/æ¸¬é©—èªéŸ³ èˆ‡ ç”Ÿæ€ªåŠæ‹ï¼‰
    window.__arb = A11YArbiter.install({
      hpEl:   document.getElementById('playerHP'),
      coinEl: document.getElementById('playerCoins'),
      wpnEl:  document.getElementById('weaponStatus'),
      srEl:   document.getElementById('srStatus'),
      // è®“ä»²è£å™¨æŠŠã€Œæ¸¬é©—å¿µé¡Œ/é¸é …ã€ä¹Ÿè¦–ç‚º TTS å¿™ç¢Œ
      ttsBusyFn: () => {
        const coreBusy  = (window.Core && typeof Core._speechDepth === 'number' && Core._speechDepth > 0);
        const synthBusy = !!(window.speechSynthesis && speechSynthesis.speaking);
        return coreBusy || synthBusy;
      },
      // å¦‚éœ€å¾®èª¿ç¯€å¥å¯é–‹æ”¾ï¼š
      // coolDownMs: 1200, quietNeedMs: 400, checkInterval: 200,
    });

      // å®‰è£ SpawnConductorï¼ˆæŠŠ srStatus å‚³é€²ä¾†æ›´ç²¾æº–ï¼‰
    window.__sc = SpawnConductor.install({
      srEl: document.getElementById('srStatus'),
      // waitTimeout: 2200, quietNeed: 300, poll: 60,
      // è‹¥æœ‰ quiz èªéŸ³ï¼Œå»ºè­°ç”¨èˆ‡è©²é—œç›¸åŒçš„ ttsBusyFnï¼š
      ttsBusyFn: () => (Core._speechDepth > 0) || (speechSynthesis?.speaking)
    });
  });

    // ï¼ˆå¯é¸ï¼‰è‹¥ k4_dialog æœ‰æ´¾ç™¼äº‹ä»¶ï¼Œå¯åŒæ­¥éŠæˆ²æ´»å‹•ç‹€æ…‹
    window.addEventListener('quiz-open',  () => { window.gameActive = false; });
    window.addEventListener('quiz-close', () => { window.gameActive = true;  });

  </script>

  <script>
  // åˆ‡é æˆ–é‡è¼‰æ™‚ï¼Œå–„å¾Œé‚„åŸ role/tabindex ç­‰
  window.addEventListener('beforeunload', () => {
    try { window.__focusHints?.destroy(); } catch(_){}
  });
  </script>
  <script>
  ;(() => {
    "use strict";

    // === æª”å â†’ ä¸­æ–‡è§’è‰²åï¼ˆå…¨éƒ¨å°å¯« keyï¼‰ ===
    const roleMap = {
      "kinbah.png": "é‡‘å·´",
      "mailah.png": "éº¥æ‹‰",
      "khaupe.png": "è€ƒç›ƒ",
      "holah.png": "èµ«æ‹‰",
      "chinaikhun.png": "é‡‘ï¼è‰¾æ†",
      "chiaulaipeh.png": "éƒŠï¼èŠåŒ—"
    };

    // å¯é å–æª”åï¼ˆå» query/hashï¼Œè½‰å°å¯«ï¼‰
    function fileKey(path){
      if (!path || typeof path !== "string") return "";
      const clean = path.split("#")[0].split("?")[0];
      const file  = clean.split("/").pop() || "";
      return file.toLowerCase();
    }

    // è®€ç©å®¶ â†’ {name, roleName, avatarPath}
    function readHero(){
      let p = {};
      try { p = JSON.parse(localStorage.getItem("bugSlayerPlayer") || "{}"); } catch {}
      const name = p?.name || "ç„¡åå‹‡è€…";
      const avatarPath = p?.avatar || "";
      const roleName = roleMap[fileKey(avatarPath)] || "æœªçŸ¥å‹‡è€…";
      return { name, roleName, avatarPath };
    }

    // åˆå§‹åŒ–å‹‡è€… UI
    function initHeroUI(){
      const { name, roleName, avatarPath } = readHero();

      // å‹‡è€…åç¨±ï¼ˆè§’è‰²ä¸­æ–‡åï¼æš±ç¨±ï¼‰
      const elName = document.getElementById("playerName");
      if (elName) elName.textContent = `${roleName}ï¼${name}`;

      // å³ä¸‹è§’è²¼åœ–ï¼ˆè£é£¾ï¼‰
      let sticker = document.getElementById("heroSticker");
      if (!sticker) {
        sticker = document.createElement("img");
        sticker.id = "heroSticker";
        sticker.className = "hero-sticker";
        sticker.alt = "";
        sticker.setAttribute("aria-hidden", "true");
        document.body.appendChild(sticker);
      }
      sticker.style.display = avatarPath ? "" : "none";
      if (avatarPath) sticker.src = avatarPath;
    }

    // æ””æˆª Core.updateUIï¼Œæ¯æ¬¡éƒ½ç¶­æŒé¡¯ç¤ºã€Œè§’è‰²ä¸­æ–‡åï¼æš±ç¨±ã€
    function patchUpdateUI(){
      if (!window.Core || typeof Core.updateUI !== "function") return false;
      if (Core.__patchedHeroName) return true;

      const orig = Core.updateUI.bind(Core);
      Core.updateUI = function(){
        orig();
        const { name, roleName } = readHero();
        const elName = document.getElementById("playerName");
        if (elName) elName.textContent = `${roleName}ï¼${name}`;
      };
      Core.__patchedHeroName = true;
      return true;
    }

    // ç¢ºä¿ patch æˆåŠŸï¼ˆäº‹ä»¶ + è¼ªè©¢ï¼‰
    function ensurePatched(){
      if (patchUpdateUI()) return;
      const t0 = Date.now();
      const timer = setInterval(() => {
        if (patchUpdateUI() || Date.now() - t0 > 5000) clearInterval(timer);
      }, 120);
    }

    document.addEventListener("DOMContentLoaded", initHeroUI);
    document.addEventListener("game-ready", () => {
      initHeroUI();
      ensurePatched();
    }, { once:true });
    window.addEventListener("load", ensurePatched, { once:true });
  })();
  </script>

  <!-- å•Ÿå‹•è…³æœ¬ï¼ˆç¬¬ 5 é—œï¼‰ -->
  <script src="js/boot/game_l5.js"></script>
  <script>
    Modes.applyModeOnLoad();
    Modes.bindQuickToggle();

    // è‹¥ä½ æœ‰éŠæˆ²èªéŸ³ï¼Œæ¨¡å¼åˆ‡æ›æ™‚ä¹Ÿå¯è£œä¸€æ®µèªªæ˜ï¼š
    document.addEventListener('keydown', (e)=>{
      if (e.shiftKey && (e.key === 'M' || e.key === 'm')) {
        // é€™è£¡ä¸ç”¨åšåˆ¥çš„ï¼Œmodes.js æœƒè™•ç† TTS + aria äº†
      }
    });
  </script>
  <script>
  /* SRNoiseGate v1 â€” å…¨åŸŸé—œ/é–‹ live regionï¼Œé¿å… NVDA æ¶è©± */
  (function (w) {
    'use strict';
    // ä½ è¦ã€Œç®¡æ§ã€çš„ live å…ƒç´ ï¼ˆå¯è¦–éœ€æ±‚åŠ ï¼‰
    const LIVE_SELECTORS = [
      '#srStatus',  // æˆ‘å€‘çš„ç‹€æ…‹æ’­å ±
      '#message',   // å¤§å¤šæ•¸é—œå¡ç”¨ä¾†é¡¯ç¤ºæç¤º/è­¦ç¤º
      '[role="status"][aria-live]',
      '[aria-live="polite"]',
      '[aria-live="assertive"]'
    ];

    // å– DOM + å»é‡
    function getLiveNodes() {
      const set = new Set();
      LIVE_SELECTORS.forEach(sel => {
        document.querySelectorAll(sel).forEach(n => set.add(n));
      });
      return Array.from(set);
    }

    // è¨˜ä½åŸæœ¬ aria-liveï¼Œä¹‹å¾Œæ¢å¾©
    const original = new WeakMap();
    function muteLiveRegions() {
      getLiveNodes().forEach(n => {
        if (!original.has(n)) original.set(n, n.getAttribute('aria-live') || '');
        n.setAttribute('aria-live', 'off');
      });
      // å‘Šè¨´ ATï¼šé é¢æš«æ™‚å¿™ï¼Œåˆ¥å¿µè®Šæ›´ï¼ˆè¼”åŠ©æ——æ¨™ï¼‰
      document.body.setAttribute('aria-busy', 'true');
    }
    function unmuteLiveRegions() {
      getLiveNodes().forEach(n => {
        const v = original.get(n);
        if (v === null || v === '') n.removeAttribute('aria-live');
        else n.setAttribute('aria-live', v);
      });
      document.body.removeAttribute('aria-busy');
    }

    // åˆ¤æ–· TTS æ˜¯å¦å¿™ç¢Œï¼ˆCore æˆ–ç€è¦½å™¨ TTS å…¶ä¸€ï¼‰
    function ttsBusy() {
      const coreBusy  = !!(w.Core && typeof Core._speechDepth === 'number' && Core._speechDepth > 0);
      const synthBusy = !!(w.speechSynthesis && speechSynthesis.speaking);
      return coreBusy || synthBusy;
    }

    // ç›£è½å™¨ï¼šå®šæœŸæŸ¥çœ‹ç‹€æ…‹è½‰è®Šï¼Œåªåœ¨ã€Œå¿™ç¢Œâ†’ç©ºé–’ã€ã€Œç©ºé–’â†’å¿™ç¢Œã€æ™‚åˆ‡æ›
    (function startWatcher() {
      let muted = false;
      setInterval(() => {
        const busy = ttsBusy();
        if (busy && !muted) { muteLiveRegions(); muted = true; }
        else if (!busy && muted) { unmuteLiveRegions(); muted = false; }
      }, 120);
    })();

    // è‹¥æœ‰ Quiz open/close äº‹ä»¶ä¹Ÿä¸€ä½µæ›ä¸Šï¼Œé€²ä¸€æ­¥éœéŸ³
    w.addEventListener?.('quiz-open',  muteLiveRegions);
    w.addEventListener?.('quiz-close', unmuteLiveRegions);

    // é€€å‡ºé é¢æ™‚æ¸…ç†
    w.addEventListener?.('beforeunload', unmuteLiveRegions);
  })(window);
  </script>

</body>
</html>
