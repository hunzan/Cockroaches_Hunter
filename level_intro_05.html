<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>第五關介紹 - 廚房飯廳</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script>window.ASSETS_ROOT = "/";</script>
  <script src="js/core/audio-unlocker.js"></script>
  <style>
    :root{
      --overlay: rgba(0,0,0,.38);
      --glass: rgba(255,255,255,.08);
      --bd: rgba(255,255,255,.18);
      --accent: #ffd166;
      --safe-bottom: env(safe-area-inset-bottom);
    }

    /* 背景與淡入 */
    body{
      margin:0; color:#fff;
      background:#000 url("assets/images/game_bg5.png") center/cover no-repeat fixed;
      opacity:0; transition:opacity .45s ease;
      -webkit-tap-highlight-color: transparent;
    }
    body.ready{ opacity:1; }

    /* 版心與卡片 */
    .wrap{ max-width:980px; margin:0 auto; padding:clamp(.8rem,2.8vw,1.25rem); }
    section{
      margin:clamp(.75rem,2.2vw,1.2rem) 0;
      padding:clamp(.75rem,2.5vw,1.15rem);
      border-radius:16px;
      background:var(--overlay);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(4px);
      box-shadow:0 8px 26px rgba(0,0,0,.35);
    }
    h1{ text-align:center; margin:.25rem 0 1rem; }
    h2{ text-align:center; margin:.2rem 0 .6rem; }

    /* 鍵帽樣式（觸控更大） */
    .kbd{
      display:inline-block; padding:.18rem .48rem;
      border:1px solid #aaa; border-radius:8px;
      background:#fff; color:#111;
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:.95rem;
    }
    @media (max-width:640px){ .kbd{ padding:.28rem .58rem; border-width:2px; font-size:1rem; } }

    /* 蟑螂卡片 RWD */
    .bug{ display:grid; grid-template-columns:1fr; gap:12px; align-items:center; }
    @media (min-width:760px){
      .bug{ grid-template-columns:320px 1fr; gap:18px; }
    }
    .bug img{
      width:100%; height:auto; display:block;
      border-radius:14px; background:var(--glass);
      border:1px solid var(--bd); padding:.25rem;
    }

    /* 主要行動按鈕（桌機置中；手機 sticky） */
    .cta-wrap{ text-align:center; margin-top:1.2rem; }
    #startBtn{
      appearance:none; border:0; cursor:pointer;
      font-weight:900; letter-spacing:.02em;
      font-size:clamp(1.05rem,2.8vw,1.2rem);
      padding:.75rem 1.4rem; border-radius:999px;
      background:var(--accent); color:#222;
      transition:transform .08s ease, box-shadow .12s ease;
      box-shadow:0 8px 20px rgba(0,0,0,.35);
      touch-action: manipulation;
    }
    #startBtn:active{ transform:translateY(1px); }

    @media (max-width:760px){
      .cta-fixed{
        position:sticky; bottom:0; z-index:50;
        padding:.6rem .8rem calc(.6rem + var(--safe-bottom));
        background:linear-gradient(180deg, transparent 0%, rgba(0,0,0,.55) 45%, rgba(0,0,0,.75) 100%);
        margin:0 -1rem;
      }
      .cta-fixed #startBtn{ width:100%; }
    }

  /* 1) 預設：視覺隱藏（仍可被 SR 看見、可聚焦） */
  .skip-link{
    position:absolute !important;
    width:1px; height:1px;
    padding:0; margin:-1px;
    overflow:hidden; clip:rect(0,0,0,0);
    white-space:nowrap; border:0;
  }

  /* 2) 取得焦點：才顯示並定位在左上角 */
  .skip-link:focus,
  .skip-link:focus-visible{
    position:fixed !important;
    left:12px;
    top:12px;         /* 第二顆你已內聯 top:56px 會覆蓋這裡，OK */
    z-index:10000;
    clip:auto; width:auto; height:auto; overflow:visible;
    padding:.5rem .75rem; margin:0; white-space:normal; border:2px solid var(--accent);
    border-radius:10px;
    background:#000; color:#fff;
    box-shadow:0 6px 24px rgba(0,0,0,.6);
  }
    @media (hover:none) {
    .skip-link{ /* 保持 SR 可聚焦即可，視覺仍隱藏 */ }
    }

    /* 焦點可見（鍵盤） */
    [tabindex="-1"]:focus, section:focus, #startBtn:focus {
      outline: 3px solid var(--accent); outline-offset: 2px;
    }

    /* 視覺隱藏（給 SR） */
    .sr-only {
      position:absolute!important; width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden; clip:rect(0,0,1px,1px); white-space:nowrap; border:0;
    }
  </style>
</head>
<body class="level-intro">
  <!-- 隱藏的跳轉連結（聚焦才顯示） -->
  <a href="#main" class="skip-link" id="skipToMain" aria-label="跳到主內容，開始聽本關說明">跳到主內容</a>
  <a href="#startBtn" class="skip-link" style="top:56px" id="skipToStart" aria-label="跳到開始按鈕，直接進入遊戲">跳到開始按鈕</a>

  <main class="wrap" id="main" tabindex="-1" aria-label="第五關介紹主內容">
    <h1>第 5 關：廚房飯廳</h1>

    <!-- A11Y 區塊 -->
    <section id="a11yBlock" aria-labelledby="a11yTitle" tabindex="-1">
      <h2 id="a11yTitle">螢幕報讀使用者必看</h2>
      <p>
        進入關卡後，請先按 <span class="kbd">NVDA</span> + <span class="kbd">空白</span> 切到<strong>焦點模式</strong>，再用方向鍵操作。
      </p>
      <ul>
        <li>方向鍵：<span class="kbd">↑</span> <span class="kbd">↓</span> <span class="kbd">←</span> <span class="kbd">→</span></li>
        <li>定位輔助：<span class="kbd">空白鍵</span> 掃描蟑螂位置</li>
        <li>武器：<span class="kbd">1</span> 噴火槍、<span class="kbd">2</span> 香氛噴霧、<span class="kbd">3</span> 藍白拖、<span class="kbd">4</span> 毒餌</li>
        <li>Boss 關新增：<span class="kbd">5</span> 養貓、<span class="kbd">6</span> 罷免連署、<span class="kbd">7</span> 發動罷免</li>
        <li>若方向鍵沒反應，請再按一次 <span class="kbd">NVDA</span> + <span class="kbd">空白</span></li>
      </ul>
    </section>

    <!-- 場地形式 -->
    <section>
      <h2>場地形式</h2>
      <p>10 × 10 正方形地圖，可上下左右移動。</p>
    </section>

    <!-- 家具/障礙與移動物件 -->
    <section>
      <h2>家具區與移動障礙</h2>
      <ul>
        <li>
          餐桌椅區：<strong>4 × 2</strong>，位於<strong>第 5–6 行 × 第 4–7 列</strong>（中央偏左）。
          傢具為障礙，<u>不可穿越</u>。第一次撞到會語音提醒；同區域第二次硬撞會<strong>扣 1 血、扣 1 金幣</strong>。
        </li>
        <li>
          活動菜籃車：<strong>移動障礙</strong>，在<strong>第 4 列</strong>左右來回。車子所在格當拍不可進入，發生碰撞會受傷並可能被推移一格。
        </li>
      </ul>
    </section>

    <!-- 新蟑螂 -->
    <section>
      <h2>本關會遇到的新蟑螂 🪳</h2>
      <article class="bug" aria-label="夭壽強">
        <img src="assets/images/cockroaches/k5.png" alt="至尊蟑螂王夭壽強，巨大直立，張嘴露出獠牙，指揮蟑螂族群。">
        <div>
          <h3 style="margin:.25rem 0 .35rem">夭壽強（至尊王者）</h3>
          <p>蟑螂族票選的蟑螂王，常規武器無效。傳說可用「發動罷免 👎」或「召喚貓咪 🐈」擊倒。</p>
        </div>
      </article>
    </section>

    <!-- 操作方式 -->
    <section>
      <h2>操作方式</h2>
      <ul>
        <li>按 <span class="kbd">↑</span> <span class="kbd">↓</span> <span class="kbd">←</span> <span class="kbd">→</span> 移動；按 <span class="kbd">空白鍵</span> 掃描蟑螂位置。</li>
        <li>按 <span class="kbd">1</span> <span class="kbd">2</span> <span class="kbd">3</span> <span class="kbd">4</span> 選武器（噴火槍、香氛噴霧、藍白拖、毒餌）。</li>
        <li>Boss 關特別武器：<span class="kbd">6</span> 罷免連署、<span class="kbd">7</span> 罷免、<span class="kbd">5</span> 養貓（需金幣充足）。</li>
        <li>對準目標後按 <span class="kbd">Enter</span> 執行。</li>
      </ul>
    </section>

    <!-- 特別規則 -->
    <section class="notice" role="note">
      <h2>特別規則 💰 / 👎 / 🐈</h2>
      <ul>
        <li>可用金幣對 <strong>K1/K2/K3</strong> 進行<strong>罷免連署</strong>以換取選票（價格與票值依各蟑螂而定）。</li>
        <li><strong>軍師蟑到爆（K4）</strong>無法收買，需靠解題收服。</li>
        <li>當連署達門檻（K1：20、K2：10、K3：5）即可對蟑螂王使用<strong>發動罷免（7）</strong>一擊致勝。</li>
        <li>金幣 ≥ 200 可<strong>養貓（5）</strong>，之後可召喚戰貓對王造成固定傷害（可多次使用）。</li>
      </ul>
    </section>

    <!-- 破關目標 -->
    <section id="goalSection" tabindex="-1" aria-labelledby="goalTitle">
      <h2 id="goalTitle">破關目標 🎯</h2>
      <p>俗辣強 20 隻、飛天強尼 10 隻、主管強強棍 5 隻、軍師蟑到爆 3 隻，並完成對蟑螂王夭壽強的終局條件。</p>
    </section>

    <!-- SR 提示與哨兵 -->
    <div id="srHint" class="sr-only" role="status" aria-live="polite"></div>
    <div id="endSentinel" class="sr-only" tabindex="0" aria-label="已到說明結尾，將前往開始按鈕"></div>

    <!-- CTA -->
    <div class="cta-wrap cta-fixed">
      <button id="startBtn" aria-describedby="startDesc">進入第五關</button>
      <span id="startDesc" class="sr-only">按下將前往第五關遊戲。</span>
    </div>
  </main>

  <!-- BGM -->
  <audio id="bgm" src="assets/sounds/game_05.mp3" loop preload="auto" autoplay muted playsinline></audio>

  <script>
    /* ==== 音訊初始化與解鎖（行動裝置） ==== */
    AudioFX.init();
    const bgm = document.getElementById('bgm');
    AudioFX.register(bgm);

    (function(){
      let armed = false;
      function fadeIn(audio, vol=0.6, ms=900){
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) { audio.volume = vol; return; }
        audio.volume = 0;
        const steps = 18, delta = vol/steps, step = Math.ceil(ms/steps);
        let i = 0; const t = setInterval(()=>{ i++; audio.volume = Math.min(vol, audio.volume + delta); if(i>=steps) clearInterval(t); }, step);
      }
      function arm(){
        if (armed) return; armed = true;
        try { AudioFX.ensure(); } catch(_){}
        try { bgm.muted = false; } catch(_){}
        bgm.play().then(()=> fadeIn(bgm, .55, 900)).catch(()=>{ /* 自動播放被擋就保持靜音 */ });
        document.removeEventListener('pointerdown', arm, true);
        document.removeEventListener('keydown', arm, true);
      }
      document.addEventListener('pointerdown', arm, true);
      document.addEventListener('keydown', arm, true);
    })();
  </script>

  <script>
    /* ==== 導頁 ==== */
    function goLevel5(){
      try { sessionStorage.setItem('needFocusModeHint', '5'); } catch(_){}
      location.href = 'game_05.html';
    }

    /* ==== 可及性與導覽 ==== */
    document.addEventListener('DOMContentLoaded', ()=>{
      document.body.classList.add('ready');

      const srHint = document.getElementById('srHint');
      const firstBlock = document.getElementById('a11yBlock');
      const skipMain = document.getElementById('skipToMain');
      const skipStart = document.getElementById('skipToStart');
      const startBtn  = document.getElementById('startBtn');
      const endSentinel = document.getElementById('endSentinel');

      // 初次進頁：聚焦第一區塊
      firstBlock?.focus({ preventScroll:true });
      srHint.textContent = '提示：進入關卡後，請按 NVDA 加 空白 切換到焦點模式，再用方向鍵操作。';

      // Skip → 主內容
      function focusFirst(e){ e?.preventDefault(); firstBlock?.focus(); }
      skipMain.addEventListener('click', focusFirst);
      skipMain.addEventListener('keydown', e=>{ if (e.key==='Enter'||e.key===' ') focusFirst(e); });

      // Skip → 開始按鈕
      function focusStart(e){ e?.preventDefault(); startBtn?.focus(); }
      skipStart.addEventListener('click', focusStart);
      skipStart.addEventListener('keydown', e=>{ if (e.key==='Enter'||e.key===' ') focusStart(e); });

      // 內容尾端 → 自動把焦點送到開始按鈕
      endSentinel.addEventListener('focus', ()=>{
        srHint.textContent = '已到說明結尾，前往開始按鈕。';
        setTimeout(()=> startBtn?.focus(), 0);
      });

      // 只在按鈕聚焦時，Enter/Space 才會啟動
      startBtn.addEventListener('click', goLevel5);
      startBtn.addEventListener('keydown', (e)=>{
        if (e.key==='Enter' || e.key===' '){ e.preventDefault(); goLevel5(); }
      });
    });
  </script>
</body>
</html>
