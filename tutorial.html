<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>遊戲說明 - 進擊的蟑螂戰鬥遊戲</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="style.css" />
  <script>window.ASSETS_ROOT = "/";</script>
  <!-- 全域音訊解鎖工具（無 import） -->
  <script src="js/core/audio-unlocker.js"></script>

  <style>
    /* ===== 神秘黑底：只影響本頁 ===== */
    body { margin:0; color:#fff; background:#000; position:relative; overflow-x:hidden; }
    body::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background:
        radial-gradient(80% 60% at 50% 35%, rgba(255,255,255,0.06) 0%, rgba(0,0,0,0) 60%),
        radial-gradient(120% 80% at 50% 120%, rgba(0,0,0,0.85) 10%, rgba(0,0,0,1) 70%);
      background-blend-mode: screen, normal;
    }
    a.skip-link{
      position:fixed; left:16px; top:12px; transform:translateY(-150%);
      background:#000; color:#fff; padding:.5rem .75rem; border-radius:10px; border:2px solid #ffd166;
      box-shadow:0 4px 18px rgba(0,0,0,.45); z-index:10000; transition:transform .18s ease, box-shadow .18s ease;
    }
    a.skip-link:focus, a.skip-link:focus-visible{ transform:translateY(0); outline:none; box-shadow:0 6px 24px rgba(0,0,0,.6); }

    main{
      max-width:1000px; margin:3rem auto; padding:1.25rem;
      background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.15); border-radius:16px;
      backdrop-filter:blur(4px); box-shadow:0 10px 40px rgba(0,0,0,0.5);
      opacity:0; animation:fadeInMain .7s ease-out forwards;
    }
    @keyframes fadeInMain { to { opacity:1; } }

    .equip{ margin-top:1.25rem; }
    .equip h2{ margin:0 0 .4rem; position:relative; text-shadow:0 2px 10px rgba(0,0,0,.7); }
    .equip h2::after{
      content:""; display:block; width:140px; height:3px; margin-top:.45rem;
      background:linear-gradient(90deg, #ffd166, rgba(255,209,102,0)); border-radius:2px;
    }

    .equip-grid{ display:flex; justify-content:center; flex-wrap:wrap; gap:2rem; margin-top:1rem; }
    .item{
      flex:1 1 240px; max-width:280px; text-align:left;
      background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.18);
      border-radius:14px; padding:1rem; backdrop-filter:blur(4px);
      box-shadow:0 3px 10px rgba(0,0,0,0.35); transition:transform .2s ease;
    }
    .item:hover{ transform:translateY(-3px); }
    .item figure{ margin:0; }
    .item img{
      max-width:240px; width:100%; height:auto; border-radius:10px; margin:0 auto .8rem; display:block;
      background:rgba(255,255,255,0.08); padding:.35rem;
    }
    .item figcaption{ font-weight:700; margin-bottom:.25rem; }

    .sr-actions{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin:.25rem 0 1rem; }
    .sr-btn{
      appearance:none; border:1px solid rgba(255,255,255,.28);
      background:rgba(255,255,255,.12); color:#fff; border-radius:10px; padding:.5rem .8rem; cursor:pointer;
    }
    .sr-btn:focus-visible{ outline:2px solid #ffd166; outline-offset:2px; }

    ul{ line-height:1.8; margin:.4rem 0 0; }
    #startBtn{
      margin-top:2rem; font-size:1.2rem; padding:.7rem 1.6rem; border-radius:999px; font-weight:700; cursor:pointer;
    }

    /* 行動端：按鈕更大、邊距更寬 */
    @media (pointer:coarse){
      .sr-btn{ padding:.7rem 1rem; font-size:1.05rem; border-radius:12px; }
      #startBtn{ font-size:1.25rem; padding:.85rem 1.8rem; }
    }

    .sr-only{ position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body class="guide">
  <a href="#main" class="skip-link">跳到主內容</a>

  <main id="main">
    <h1>遊戲說明</h1>

    <section class="equip" aria-labelledby="equipTitle">
      <h2 id="equipTitle">勇者的初始裝備</h2>
      <div class="sr-actions">
        <button class="sr-btn" id="readEquip" aria-keyshortcuts="1">朗讀本節（快捷鍵 1）</button>
        <span id="srStatus" class="sr-only" aria-live="polite"></span>
      </div>

      <div class="equip-grid">
        <div class="item">
          <figure>
            <img src="assets/images/weapons/firegun.png" alt="一把噴火槍正在火烤蟑螂的畫面。">
            <figcaption tabindex="0"><span class="sr-only">噴火槍</span></figcaption>
          </figure>
          <p>🔥 噴火槍：起始值有 10 次，讓蟑螂們變成烤小強。</p>
        </div>
        <div class="item">
          <figure>
            <img src="assets/images/weapons/spray.png" alt="一罐香氛噴霧正在噴蟑螂，蟑螂們倒地抽搐的畫面。">
            <figcaption tabindex="0"><span class="sr-only">香氛噴霧</span></figcaption>
          </figure>
          <p>🌸 香氛噴霧：起始值有 10 次，人類覺得香，蟑螂聞了超想吐。</p>
        </div>
        <div class="item">
          <figure>
            <img src="assets/images/weapons/slipper.png" alt="藍白拖打中蟑螂噴汁的畫面。">
            <figcaption tabindex="0"><span class="sr-only">藍白拖</span></figcaption>
          </figure>
          <p>🩴 藍白拖：近距離必殺，命中瞬間爆擊噴汁，起始值可使用 10 次。</p>
        </div>
      </div>
    </section>

    <section aria-labelledby="controlTitle">
      <h2 id="controlTitle">操作方式</h2>
      <div class="sr-actions">
        <button class="sr-btn" id="readControl" aria-keyshortcuts="2">朗讀本節（快捷鍵 2）</button>
      </div>
      <ul id="controlList">
        <!-- 內容會由腳本依裝置型態（桌機/手機）置換 -->
        <li>載入中…</li>
      </ul>
    </section>

    <section aria-labelledby="tipsTitle">
      <h2 id="tipsTitle">重要提示</h2>
      <div class="sr-actions">
        <button class="sr-btn" id="readTips" aria-keyshortcuts="3">朗讀本節（快捷鍵 3）</button>
      </div>
      <ul id="tipsList">
        <li>遊戲共五關，難度會愈來愈高，出現的蟑螂種類也會增加，愈難對付。</li>
        <li>不同蟑螂怕的武器不同，請留意每關開頭的說明，要聰明選擇！</li>
        <li>攻擊失誤會被蟑螂反擊，小心扣血或損失金幣。</li>
        <li>若在有特殊障礙物的情境，也請小心扣血或損失金幣。</li>
        <li>血量歸零或被蟑螂王 咬 5 次，遊戲就會結束。</li>
      </ul>
    </section>

    <section aria-labelledby="nvdaTitle">
      <h2 id="nvdaTitle">NVDA 使用建議</h2>
      <div class="sr-actions">
        <button class="sr-btn" id="readNVDA" aria-keyshortcuts="4">朗讀本節（快捷鍵 4）</button>
      </div>
      <ul id="nvdaTips">
        <li>進入關卡後，請按 <kbd>NVDA</kbd> + <kbd>空白鍵</kbd> 切換到「焦點模式」，再用方向鍵操作。</li>
        <li>若覺得報讀太吵，可按 <kbd>NVDA</kbd> + <kbd>S</kbd> 在「朗讀／提示音／靜音」間切換。</li>
        <li>遊戲內建的 TTS 會報讀蟑螂座標與關鍵事件；NVDA 報讀只是輔助，干擾時可暫時關閉。</li>
      </ul>
    </section>

    <button id="startBtn" aria-describedby="startDesc">遊戲開始前先來認識敵人</button>
    <span id="startDesc" class="sr-only">按下將前往蟑螂圖鑑與教學頁。</span>
  </main>

  <!-- 背景音樂（說明頁專用） -->
  <audio id="bgm" src="assets/sounds/tutorial_theme.mp3" loop preload="auto" playsinline></audio>

  <!-- ✅ 單一入口：用 ES Module 寫本頁行為 -->
  <script type="module">
    // ====== BGM 解鎖 & 淡入 ======
    const bgm = document.getElementById('bgm');
    try {
      // 相容不同命名的解鎖器
      if (window.AudioFX?.init) window.AudioFX.init();
      if (window.AudioFX?.register) window.AudioFX.register(bgm);
      if (window.AudioUnlocker?.prime) window.AudioUnlocker.prime();
    } catch {}

    function fadeInAudio(audio, target = 0.6, durMs = 900) {
      audio.volume = 0; const steps = 18, delta = target/steps, stepMs = Math.ceil(durMs/steps);
      let i = 0; const timer = setInterval(()=>{ i++; audio.volume = Math.min(target, audio.volume + delta); if(i>=steps) clearInterval(timer); }, stepMs);
    }
    let audioArmed = false;
    function armBgm(){
      if (audioArmed) return; audioArmed = true;
      bgm?.play()?.then(()=>fadeInAudio(bgm, 0.6, 900)).catch(()=>{});
    }
    document.addEventListener('click', armBgm, { once:true });
    document.addEventListener('keydown', armBgm, { once:true });
    document.addEventListener('touchstart', armBgm, { once:true, passive:true });

    // ====== 語音合成（章節快速朗讀） ======
    function speak(text){
      try{
        if(!('speechSynthesis' in window) || !text) return;
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang='zh-TW'; u.rate=1.5; u.pitch=1.0; u.volume=1.0;
        speechSynthesis.speak(u);
      }catch(_){}
    }
    function sectionText(el){
      if(!el) return "";
      let t = ""; const h2 = el.querySelector('h2'); if (h2) t += h2.textContent + "。";
      el.querySelectorAll('p, li').forEach(p => t += p.textContent + "。");
      return t;
    }
    function live(msg){ const sr = document.getElementById('srStatus'); if (sr) sr.textContent = msg || ""; }

    const secEquip = document.querySelector('.equip');
    const secCtrl  = document.querySelector('[aria-labelledby="controlTitle"]');
    const secTips  = document.querySelector('[aria-labelledby="tipsTitle"]');
    const secNVDA  = document.querySelector('[aria-labelledby="nvdaTitle"]');

    document.getElementById('readEquip')?.addEventListener('click', ()=>{ speak(sectionText(secEquip)); live('已朗讀：初始裝備。'); });
    document.getElementById('readControl')?.addEventListener('click', ()=>{ speak(sectionText(secCtrl));  live('已朗讀：操作方式。'); });
    document.getElementById('readTips')?.addEventListener('click', ()=>{ speak(sectionText(secTips));    live('已朗讀：重要提示。'); });
    document.getElementById('readNVDA')?.addEventListener('click',  ()=>{ speak(sectionText(secNVDA));   live('已朗讀：NVDA 使用建議。'); });

    document.addEventListener('keydown', (e)=>{
      if (e.altKey || e.ctrlKey || e.metaKey) return;
      if (e.key === '1') { e.preventDefault(); document.getElementById('readEquip')?.click(); }
      else if (e.key === '2') { e.preventDefault(); document.getElementById('readControl')?.click(); }
      else if (e.key === '3') { e.preventDefault(); document.getElementById('readTips')?.click(); }
      else if (e.key === '4') { e.preventDefault(); document.getElementById('readNVDA')?.click(); }
    });

    // ====== 操作方式：依裝置型態顯示（桌機 vs 手機） ======
    const controlList = document.getElementById('controlList');
    const isCoarse = window.matchMedia?.('(pointer: coarse)')?.matches ?? false;

    const desktopItems = [
      '移動角色位置：使用箭頭 ← 、 → 、 ↑ 、 ↓',
      '掃描目前區域是否有蟑螂：空白鍵',
      '切換武器：數字 1 噴火槍、2 香氛噴霧、3 藍白拖（第 4～5 關會再解鎖 4～7）',
      '發動攻擊：Enter 鍵',
      '語音朗讀玩家目前狀態：Shift + S',
      '切換畫面與純聽覺操作模式：Shift + M'
    ];

    const mobileItems = [
      '移動角色位置：在畫面上「滑動」上下左右',
      '發動攻擊：在畫面上「雙擊」',
      '切換武器：暫以數字鍵（1/2/3…）為主；行動手勢將於後續加入',
      '語音朗讀玩家目前狀態：Shift + S（外接鍵盤）',
      '切換畫面與純聽覺操作模式：Shift + M（外接鍵盤）',
      '※ 小提醒：開啟螢幕閱讀器時，滑動會被系統攔截，請改用底部大型按鈕（進入關卡後會出現）。'
    ];

    function renderControls(items){
      controlList.innerHTML = '';
      items.forEach(t => { const li = document.createElement('li'); li.textContent = t; controlList.appendChild(li); });
    }
    renderControls(isCoarse ? mobileItems : desktopItems);

    // 視窗尺寸或指標型態變更時，重新渲染
    try {
      window.matchMedia('(pointer: coarse)').addEventListener?.('change', (e)=>renderControls(e.matches?mobileItems:desktopItems));
    } catch {}

    // ====== 開始按鈕 ======
    document.getElementById('startBtn').addEventListener('click', () => {
      window.location.href = 'bugs_guide.html';
    });
  </script>
</body>
</html>
