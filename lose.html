<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>戰敗… - 進擊的蟑螂</title>
  <link rel="stylesheet" href="style.css" />
  <script>window.ASSETS_ROOT = "/";</script>
  <style>
  html, body { height: 100%; }
  body {
    margin: 0;
    display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    text-align: center; color: #fff; font-family: sans-serif;

    background: #000 url("assets/images/lose_bg.png") center / cover no-repeat fixed;
    opacity: 0; transition: opacity .6s ease;
  }
  body.ready { opacity: 1; }

  @media (min-aspect-ratio: 4/3) {
    body { background-size: contain; background-color: #000; }
  }

  h2 {
    font-size: 2.2rem;
    margin: 0 0 1rem;
    text-shadow: 0 2px 6px rgba(0,0,0,.35);
  }
  p { margin: 0 0 1.25rem; line-height: 1.7; text-shadow: 0 2px 6px rgba(0,0,0,.35); }

  .btnbar { display:flex; gap:.75rem; flex-wrap:wrap; justify-content:center; }
  .btn, button {
    font-size: 1.1rem; padding: .65rem 1.3rem;
    border: none; border-radius: 10px; cursor: pointer;
    background: #ffd452; color: #222;
  }
  .btn:hover, button:hover { filter: brightness(1.08); }
  .btn.secondary { background:#e9e9e9; color:#222; }
  </style>
</head>
<body>
  <main>
    <h2>蟑螂們佔領了你的家，但勇者不會放棄！</h2>
    <div class="btnbar">
      <button id="retryBtn" class="btn">重試本關</button>
      <button id="resetBtn" class="btn secondary">從頭開始</button>
    </div>
  </main>

  <audio id="bgm" src="assets/sounds/lose.mp3" preload="auto" autoplay muted playsinline></audio>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('ready');
    });

    function getParam(name){
      return new URL(location.href).searchParams.get(name);
    }

    function buildRetryUrl(level){
      // ★依你實際命名規則調整
      return `game_l${level}.html`;
    }

    function clearProgress() {
      try {
        Object.keys(localStorage).forEach(k => {
          if (k.startsWith("packApplied_L")) localStorage.removeItem(k);
        });
        localStorage.removeItem("bugSlayerPlayer");
      } catch (e) { console.warn("清進度失敗：", e); }
    }

    const bgm = document.getElementById('bgm');
    function enableSoundOnce() {
      bgm.muted = false; bgm.volume = 1;
      bgm.play().catch(()=>{});
      document.removeEventListener('click', enableSoundOnce);
      document.removeEventListener('keydown', enableSoundOnce);
      document.removeEventListener('touchstart', enableSoundOnce);
    }
    document.addEventListener('DOMContentLoaded', () => {
      bgm.play().catch(()=>{});
      document.addEventListener('click', enableSoundOnce, { once:true });
      document.addEventListener('keydown', enableSoundOnce, { once:true });
      document.addEventListener('touchstart', enableSoundOnce, { once:true, passive:true });

      if ('speechSynthesis' in window) {
        const u = new SpeechSynthesisUtterance("蟑螂們佔領了你的家。但勇者不會放棄。");
        u.lang = "zh-TW";
        u.onstart = () => { bgm.volume = 0.25; };
        u.onend   = () => { bgm.volume = 1;    };
        speechSynthesis.cancel(); speechSynthesis.speak(u);
      }

      const level = Number(getParam('level') || 1);
      document.getElementById('retryBtn').addEventListener('click', () => {
        location.href = buildRetryUrl(level);
      });
      document.getElementById('resetBtn').addEventListener('click', () => {
        clearProgress();
        location.href = "index.html"; // ★回到主頁
      });
    });
  </script>
</body>
</html>
